<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simo</title>

<style>
:root{
  --bg:#0b1020;
  --panel:#121933;
  --panel2:#0e1530;
  --text:#eaf0ff;
  --muted:#a9b6d3;
  --line:rgba(255,255,255,.10);
  --accent:#2a66ff;
  --accent2:#1f4dd6;
  --warn:#ffcc66;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:radial-gradient(1200px 700px at 20% 0%, #162a66 0%, var(--bg) 55%);
  color:var(--text);
}

.wrap{max-width:980px;margin:0 auto;padding:18px}

.top{
  display:flex;align-items:center;justify-content:space-between;
  gap:12px;margin-bottom:12px;
}

.brand{font-size:22px;font-weight:700;letter-spacing:.2px}
.sub{font-size:12px;color:var(--muted);margin-top:2px}

.badgeRow{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.badge{
  font-size:12px;color:var(--muted);
  border:1px solid var(--line);padding:6px 10px;border-radius:999px;
  background:rgba(255,255,255,.04);
}
.badge strong{color:var(--text);font-weight:700}

.grid{
  display:grid;
  grid-template-columns: 1.2fr .8fr;
  gap:12px;
}
@media (max-width: 920px){ .grid{grid-template-columns: 1fr} }

.card{
  background:rgba(255,255,255,.03);
  border:1px solid var(--line);
  border-radius:14px;
  overflow:hidden;
}

.cardHeader{
  padding:12px 12px 10px;
  border-bottom:1px solid var(--line);
  display:flex;align-items:center;justify-content:space-between;gap:10px;
}
.cardTitle{font-weight:700}
.cardHint{color:var(--muted);font-size:12px}

.chat{height:520px;overflow:auto;padding:12px}

.msg{margin:0 0 12px 0;line-height:1.5;font-size:14px}
.msg .who{display:inline-block;font-weight:700;margin-right:8px}
.msg.user .who{color:#fff}
.msg.simo .who{color:var(--muted)}

.bubble{
  display:inline-block;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.02);
  max-width:95%;
  white-space:pre-wrap;
}
.msg.user .bubble{
  background:rgba(42,102,255,.10);
  border-color:rgba(42,102,255,.25);
}

.controls{
  padding:12px;
  border-top:1px solid var(--line);
  display:flex;gap:8px;align-items:flex-end;
  background:rgba(0,0,0,.10);
}

textarea{
  flex:1;height:52px;resize:none;
  border-radius:12px;border:1px solid var(--line);
  background:var(--panel2);
  color:var(--text);
  padding:10px 12px;
  font-size:14px;outline:none;
}

button{
  border:none;padding:12px 14px;border-radius:12px;
  font-weight:800;cursor:pointer;color:#fff;background:var(--accent);
}
button:hover{background:var(--accent2)}

.secondaryBtn{
  background:rgba(255,255,255,.06);
  border:1px solid var(--line);
  color:var(--text);
}
.secondaryBtn:hover{background:rgba(255,255,255,.10)}

.side{padding:12px}

.kv{
  display:flex;justify-content:space-between;gap:10px;
  padding:10px 10px;border:1px solid var(--line);
  border-radius:12px;background:rgba(255,255,255,.02);
  margin-bottom:10px;font-size:13px;
}
.kv span{color:var(--muted)}
.small{color:var(--muted);font-size:12px;line-height:1.4}

hr.sep{border:none;border-top:1px solid var(--line);margin:12px 0}

.previewWrap{padding:12px}

.previewCard{
  background:#fff;color:#111;
  border-radius:14px;padding:14px;
  border:1px solid rgba(0,0,0,.10);
}

.previewTitle{
  display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
}
.previewTitle h3{margin:0;font-size:16px}
.previewTitle .tag{
  font-size:11px;padding:6px 10px;border-radius:999px;
  border:1px solid rgba(0,0,0,.12);
  background:#f3f4f6;
}

.previewSub{color:#444;font-size:12px;margin:6px 0 10px}
.pillRow{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 10px}
.pill{
  font-size:11px;padding:6px 10px;border-radius:999px;
  border:1px solid #c7d2fe;background:#eef2ff;
}

.blockTitle{font-size:12px;font-weight:800;margin:12px 0 8px;color:#222}
.box{
  border:1px solid #e5e7eb;border-radius:12px;
  padding:10px;background:#f9fafb;margin-bottom:8px;
}
.grayBox{height:140px;background:#e5e7eb;border-radius:12px}

.modalBackdrop{
  position:fixed;inset:0;background:rgba(0,0,0,.55);
  display:none;align-items:center;justify-content:center;
  padding:20px;
}
.modal{
  width:min(520px, 100%);
  border-radius:16px;border:1px solid var(--line);
  background:rgba(18,25,51,.98);
  padding:14px;
}
.modal h3{margin:0 0 6px 0}
.modal p{margin:0 0 12px 0;color:var(--muted);line-height:1.45;font-size:13px}
.modal .row{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
.warnLine{
  border:1px dashed rgba(255,204,102,.45);
  background:rgba(255,204,102,.08);
  color:#ffe7b3;
  padding:10px 12px;border-radius:12px;
  font-size:12px;margin-top:10px;
}
</style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div>
      <div class="brand">Hey — I’m Simo.</div>
      <div class="sub">Best friend vibes by default. Previews adapt to what you ask for.</div>
    </div>
    <div class="badgeRow">
      <div class="badge">Plan: <strong id="planBadge">Free</strong></div>
      <div class="badge">Mode: <strong id="modeBadge">Friend</strong></div>
      <div class="badge">Focus: <strong id="focusBadge">—</strong></div>
      <div class="badge">Domain: <strong id="domainBadge">—</strong></div>
      <div class="badge">Preview: <strong id="previewBadge">Ready</strong></div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="cardHeader">
        <div>
          <div class="cardTitle">Chat</div>
          <div class="cardHint">Enter to send • Shift+Enter for a new line</div>
        </div>
        <button class="secondaryBtn" id="clearBtn" type="button">Clear</button>
      </div>

      <div id="chat" class="chat"></div>

      <div class="controls">
        <textarea id="input" placeholder="Talk to Simo…"></textarea>
        <button id="sendBtn" type="button">Send</button>
      </div>
    </div>

    <div class="card">
      <div class="cardHeader">
        <div>
          <div class="cardTitle">Preview</div>
          <div class="cardHint">Say “show me…” + what you want on it</div>
        </div>
        <button class="secondaryBtn" id="togglePlanBtn" type="button">Toggle Pro</button>
      </div>

      <div class="side">
        <div class="kv"><span>Last intent</span><strong id="intentKV">—</strong></div>
        <div class="kv"><span>Project/topic</span><strong id="topicKV">—</strong></div>
        <div class="kv"><span>Preview modules</span><strong id="modulesKV">—</strong></div>

        <div class="small">
          Tip: “switch topics” resets the lane + pending questions.
        </div>

        <hr class="sep" />

        <div id="previewArea" class="previewWrap">
          <div class="small">No preview yet. Ask for one.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="modalBackdrop" class="modalBackdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <h3>That’s a Pro action</h3>
    <p>
      I can do that — but in the Free plan I keep it light. Toggle Pro to simulate paid upgrades.
      (Payment wiring comes later; this is UI + logic gate.)
    </p>
    <div class="row">
      <button class="secondaryBtn" id="closeModalBtn" type="button">Not now</button>
      <button id="enableProBtn" type="button">Enable Pro</button>
    </div>
    <div class="warnLine">
      This doesn’t charge anyone. It only flips the plan state.
    </div>
  </div>
</div>

<script>
const state = {
  plan: "free",
  mode: "friend",
  focus: "",                  // vent | solve | build
  domain: "",                 // physical | digital | general
  pending: "",                // home_story | app_user | app_core | app_platform
  expectingLaneChoice: false,
  lastSimoKey: "",
  buildStage: 0,              // digital app stages
  history: [],
  memory: {
    lastIntent: "",
    lastTopic: "",
    lastPreviewSpec: null,
    home: { story:"", garage:"", beds:"", baths:"", sqft:"" },
    app:  { user:"", core:"", platform:"", free:"", paid:"", feature1:"" }
  }
};

const chatEl = document.getElementById("chat");
const inputEl = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");

const clearBtn = document.getElementById("clearBtn");
const togglePlanBtn = document.getElementById("togglePlanBtn");

const planBadge = document.getElementById("planBadge");
const modeBadge = document.getElementById("modeBadge");
const focusBadge = document.getElementById("focusBadge");
const domainBadge = document.getElementById("domainBadge");
const previewBadge = document.getElementById("previewBadge");

const intentKV = document.getElementById("intentKV");
const topicKV = document.getElementById("topicKV");
const modulesKV = document.getElementById("modulesKV");
const previewArea = document.getElementById("previewArea");

const modalBackdrop = document.getElementById("modalBackdrop");
const closeModalBtn = document.getElementById("closeModalBtn");
const enableProBtn = document.getElementById("enableProBtn");

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function nowTs(){ return new Date().toISOString(); }

function setBadges(){
  planBadge.textContent = state.plan === "pro" ? "Pro" : "Free";
  modeBadge.textContent = state.mode === "builder" ? "Builder" : "Friend";
  focusBadge.textContent = state.focus ? state.focus.toUpperCase() : "—";
  domainBadge.textContent = state.domain ? state.domain.toUpperCase() : "—";
}
function setContextCards(){
  intentKV.textContent = state.memory.lastIntent || "—";
  topicKV.textContent = state.memory.lastTopic || "—";
  modulesKV.textContent = state.memory.lastPreviewSpec?.modules?.length
    ? state.memory.lastPreviewSpec.modules.join(", ")
    : "—";
}
function openModal(){ modalBackdrop.style.display = "flex"; }
function closeModal(){ modalBackdrop.style.display = "none"; }

function addMessage(role, text, key=""){
  state.history.push({ role, text, ts: nowTs() });

  const msg = document.createElement("div");
  msg.className = "msg " + (role === "user" ? "user" : "simo");

  const who = document.createElement("span");
  who.className = "who";
  who.textContent = role === "user" ? "You:" : "Simo:";

  const bubble = document.createElement("span");
  bubble.className = "bubble";
  bubble.innerHTML = escapeHtml(text);

  msg.appendChild(who);
  msg.appendChild(bubble);
  chatEl.appendChild(msg);
  chatEl.scrollTop = chatEl.scrollHeight;

  if (role === "simo" && key) state.lastSimoKey = key;
}

/* Domain detection */
function detectDomain(text){
  const t = (text || "").toLowerCase();

  const physicalHits = [
    "home","house","floor plan","layout","blueprint","garage","bedroom","bath","sq ft","square feet",
    "kitchen","living room","foundation","lot","roof","modern home","ranch","two-story","story"
  ];
  const digitalHits = [
    "app","website","web app","saas","software","ui","ux","screen","dashboard","login","api","database","frontend","backend"
  ];

  let p=0, d=0;
  for (const w of physicalHits) if (t.includes(w)) p++;
  for (const w of digitalHits) if (t.includes(w)) d++;

  if (p >= 2 && p >= d) return "physical";
  if (d >= 2 && d > p) return "digital";
  return "general";
}

/* Intent detection */
function detectIntent(text){
  const t = text.toLowerCase().trim();

  if (/^(switch topics|new topic|change topic|switch topic)$/i.test(t)) return "switch_topics";

  if (/(switch to|lets|let's)\s+(vent|venting)/i.test(text) || /\bvent(ing)?\b/.test(t)) return "lane_vent";
  if (/(switch to|lets|let's)\s+(solve|solving|problem solve|problem solving)/i.test(text) || /\b(problem\s*solv|solv(ing|e))\b/.test(t)) return "lane_solve";
  if (/(switch to|lets|let's)\s+(build|building|create|design)/i.test(text) || /\b(build(ing)?|create|design)\b/.test(t)) return "lane_build";

  if (/\bshow me\b/.test(t) && (t.includes("layout") || t.includes("floor plan") || t.includes("home") || t.includes("house") || t.includes("mockup") || t.includes("preview") || t.includes("wireframe"))) return "preview";
  if (/(preview|mockup|wireframe)\b/i.test(text)) return "preview";

  if (/(write|draft|email|resume|cover letter|bio|script|story|book)/i.test(text)) return "write";
  if (/(code|html|css|js|javascript|react|bug|fix|error)/i.test(text)) return "code";
  if (/(stressed|tired|argument|anxious|overwhelmed|mad|upset|drained)/i.test(text)) return "vent";

  if (/(help me|idea|plan|how do i)/i.test(text)) return "solve";
  return "chat";
}

function cleanTopic(s){
  return s
    .replace(/[?.!]+$/g, "")
    .replace(/\b(show me|a|an|the|quick|simple|one-page|ui|mockup|preview)\b/ig, "")
    .replace(/\s+/g, " ")
    .trim();
}
function shorten(s){
  if (!s) return "";
  return s.length > 56 ? (s.slice(0, 56).trim() + "…") : s;
}
function inferTopic(text){
  const raw = (text || "").trim();
  if (!raw) return "";
  const m1 = raw.match(/(?:preview|mockup|layout|floor plan)\s+(?:of|for)\s+(.+)$/i);
  if (m1 && m1[1]) return shorten(cleanTopic(m1[1]));
  const m2 = raw.match(/(?:build|create|design)\s+(?:me|a|an)\s+(.+)$/i);
  if (m2 && m2[1]) return shorten(cleanTopic(m2[1]));
  return shorten(raw);
}

/* Preview modules */
function parsePreviewModules(text){
  const t = (text || "").toLowerCase();
  const modules = [];

  if (t.includes("floor plan") || t.includes("layout") || t.includes("home") || t.includes("house")) {
    modules.push("floor plan");
    if (t.includes("garage")) modules.push("garage");
    modules.push("rooms");
    modules.push("dimensions");
    modules.push("notes");
    return [...new Set(modules)];
  }

  modules.push("search","filters","cards","map","action panel");
  return [...new Set(modules)];
}

function renderHomePreview(title, notes){
  previewArea.innerHTML = `
    <div class="previewCard">
      <div class="previewTitle">
        <div>
          <h3>${escapeHtml(title)}</h3>
          <div class="previewSub">${escapeHtml(notes)}</div>
        </div>
        <div class="tag">Floor Plan</div>
      </div>

      <div class="blockTitle">Simple layout concept (not to scale)</div>
      <div class="box">
        <div style="display:grid;gap:10px;">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div class="box" style="background:#fff;">Bedroom 2</div>
            <div class="box" style="background:#fff;">Bedroom 3</div>
          </div>
          <div class="box" style="background:#fff;">Bath + Laundry (central)</div>
          <div class="box" style="background:#fff;">Primary Suite (bed + bath + closet)</div>
          <div style="display:grid;grid-template-columns:1.3fr .7fr;gap:10px;">
            <div class="box" style="background:#fff;">Open Kitchen + Dining + Living</div>
            <div class="box" style="background:#fff;">Entry / Mudroom</div>
          </div>
          <div class="box" style="background:#fff;">Attached 2-Car Garage (${escapeHtml(state.memory.home.garage || "front/side")})</div>
        </div>
      </div>

      <div class="blockTitle">Quick questions to refine</div>
      <div class="pillRow">
        <div class="pill">lot width/depth?</div>
        <div class="pill">garage front or side?</div>
        <div class="pill">open concept level?</div>
        <div class="pill">basement?</div>
      </div>
    </div>
  `;
}

function renderPreview(spec){
  const title = spec.title || "Preview";
  const modules = spec.modules || [];
  const notes = spec.notes || "Tell me what to adjust.";

  if (modules.includes("floor plan")){
    renderHomePreview(title, notes);
    return;
  }

  // generic digital preview template
  previewArea.innerHTML = `
    <div class="previewCard">
      <div class="previewTitle">
        <div>
          <h3>${escapeHtml(title)}</h3>
          <div class="previewSub">${escapeHtml(notes)}</div>
        </div>
        <div class="tag">Preview</div>
      </div>

      <div class="blockTitle">Home Design App (concept UI)</div>
      <div class="box"><strong>Start Designing</strong><br/>Choose template • Set dimensions • Style</div>
      <div class="box"><strong>Canvas</strong><br/>Drag rooms • Resize • Snap to grid</div>
      <div class="box"><strong>AI Assist</strong><br/>“Make this more modern” • “Add pantry”</div>
      <div class="box"><strong>Export</strong><br/>Share • PDF floor plan • Materials list</div>

      <div class="blockTitle">Main Area</div>
      <div class="grayBox"></div>
    </div>
  `;
}

/* Pro gating stubs */
function isProAction(text){
  const t = text.toLowerCase();
  if (/(export|download|pdf|docx|pptx)/i.test(text)) return true;
  if (/(connect|api key|openai|billing|stripe)/i.test(text)) return true;
  return false;
}

/* Focus helpers */
function setFocus(f){
  state.focus = f;
  state.expectingLaneChoice = false;
  setBadges();
}
function resetPending(){
  state.pending = "";
}
function resetBuildStages(){
  state.buildStage = 0;
  state.memory.app = { user:"", core:"", platform:"", free:"", paid:"", feature1:"" };
}

function askLaneOnce(){
  if (state.lastSimoKey === "ask_lane") return;
  state.expectingLaneChoice = true;
  addMessage("simo", "What do you want right now: venting, solving, or building?", "ask_lane");
}
function handleLaneChoice(intent){
  if (intent === "lane_vent"){ setFocus("vent"); return true; }
  if (intent === "lane_solve"){ setFocus("solve"); return true; }
  if (intent === "lane_build"){ setFocus("build"); return true; }
  return false;
}

/* Pending handlers */
function handlePending(userText){
  const t = userText.trim().toLowerCase();

  // HOME: story choice
  if (state.pending === "home_story"){
    if (t.includes("ranch") || t.includes("single") || t.includes("one")){
      state.memory.home.story = "single-story ranch";
      resetPending();
      setFocus("build");
      state.domain = "physical";
      setBadges();

      // Update preview notes to reflect the answer
      if (state.memory.lastPreviewSpec?.modules?.includes("floor plan")){
        renderHomePreview(state.memory.lastPreviewSpec.title, "Locked: single-story ranch. Next: lot width + garage position.");
      }

      addMessage("simo",
        "Bet — ranch it is.\nTwo quick ones:\n1) approx lot width? (ex: 50ft, 60ft)\n2) garage: front-facing or side-entry?",
        "home_refine"
      );
      return true;
    }
    if (t.includes("two") || t.includes("2") || t.includes("story") || t.includes("upstairs")){
      state.memory.home.story = "two-story";
      resetPending();
      setFocus("build");
      state.domain = "physical";
      setBadges();

      if (state.memory.lastPreviewSpec?.modules?.includes("floor plan")){
        renderHomePreview(state.memory.lastPreviewSpec.title, "Locked: two-story. Next: which rooms upstairs + lot width.");
      }

      addMessage("simo",
        "Cool — two-story.\nDo you want all 3 bedrooms upstairs, or primary on main?\nAnd what’s the lot width?",
        "home_refine2"
      );
      return true;
    }

    // Not recognized — re-ask (once) without dumping into lane prompt
    addMessage("simo", "Quick confirm: single-story ranch, or two-story?", "home_story_retry");
    return true;
  }

  // APP: user choice A/B/C
  if (state.pending === "app_user"){
    if (t === "a" || t.includes("homeowner")){
      state.memory.app.user = "homeowners";
      resetPending();
      state.buildStage = 2;
      state.pending = "app_core";
      addMessage("simo",
        "Homeowners — got it.\nCore experience:\n(A) drag-and-drop floor plan\n(B) AI suggestions from a prompt\n(C) templates + customize\nReply A/B/C.",
        "app_core_q"
      );
      return true;
    }
    if (t === "b" || t.includes("contract")){
      state.memory.app.user = "contractors/designers";
      resetPending();
      state.buildStage = 2;
      state.pending = "app_core";
      addMessage("simo",
        "Contractors/designers — got it.\nCore experience:\n(A) drag-and-drop floor plan\n(B) AI suggestions from a prompt\n(C) templates + customize\nReply A/B/C.",
        "app_core_q"
      );
      return true;
    }
    if (t === "c" || t.includes("both")){
      state.memory.app.user = "both";
      resetPending();
      state.buildStage = 2;
      state.pending = "app_core";
      addMessage("simo",
        "Both — got it.\nCore experience:\n(A) drag-and-drop floor plan\n(B) AI suggestions from a prompt\n(C) templates + customize\nReply A/B/C.",
        "app_core_q"
      );
      return true;
    }

    addMessage("simo","Just reply A, B, or C (homeowners / contractors / both).","app_user_retry");
    return true;
  }

  // APP: core experience A/B/C
  if (state.pending === "app_core"){
    if (t === "a"){
      state.memory.app.core = "drag-and-drop floor plan";
    } else if (t === "b"){
      state.memory.app.core = "AI suggestions from prompt";
    } else if (t === "c"){
      state.memory.app.core = "templates + customize";
    } else {
      addMessage("simo","Reply A/B/C for the core experience.","app_core_retry");
      return true;
    }

    resetPending();
    state.buildStage = 3;
    state.pending = "app_platform";
    addMessage("simo",
      "Nice.\nNext: platform.\n(A) mobile first\n(B) web first\n(C) both\nReply A/B/C.",
      "app_platform_q"
    );
    return true;
  }

  // APP: platform A/B/C
  if (state.pending === "app_platform"){
    if (t === "a") state.memory.app.platform = "mobile first";
    else if (t === "b") state.memory.app.platform = "web first";
    else if (t === "c") state.memory.app.platform = "both";
    else {
      addMessage("simo","Reply A/B/C for platform.","app_platform_retry");
      return true;
    }

    resetPending();
    // Show a preview automatically now that we have enough
    state.domain = "digital";
    setFocus("build");
    setBadges();

    state.memory.lastPreviewSpec = {
      title: "Dream Home Design App — Concept",
      modules: ["search","filters","cards","map","action panel"],
      notes: `User: ${state.memory.app.user} • Core: ${state.memory.app.core} • Platform: ${state.memory.app.platform}`
    };
    previewBadge.textContent = "Shown";
    renderPreview(state.memory.lastPreviewSpec);
    setContextCards();

    addMessage("simo",
      "Preview’s on the right.\nNow tell me the #1 feature you want first (ex: room snapping, AI styles, cost estimator).",
      "app_feature1"
    );
    return true;
  }

  return false;
}

/* Main reply */
function simoReply(userText){
  const intent = detectIntent(userText);
  state.memory.lastIntent = intent;

  // Update domain continuously
  state.domain = detectDomain(userText);

  const topic = inferTopic(userText);
  if (topic) state.memory.lastTopic = topic;

  // If we're waiting for an answer to a pending question, handle it first
  if (state.pending){
    const handled = handlePending(userText);
    setBadges();
    setContextCards();
    return;
  }

  // switch topics hard reset
  if (intent === "switch_topics"){
    state.focus = "";
    state.mode = "friend";
    state.expectingLaneChoice = false;
    state.lastSimoKey = "";
    resetPending();
    resetBuildStages();
    setBadges();
    setContextCards();
    addMessage("simo","Got you — switching topics. Venting, solving, or building?","ask_lane");
    state.expectingLaneChoice = true;
    return;
  }

  // lane choice
  if (handleLaneChoice(intent)){
    state.mode = (state.focus === "vent") ? "friend" : "builder";
    setBadges();
    setContextCards();

    if (state.focus === "vent"){
      addMessage("simo","Alright. Vent. What happened?","vent_start");
      return;
    }
    if (state.focus === "solve"){
      addMessage("simo","Alright — solve mode. What’s the goal and what’s blocking you?","solve_start");
      return;
    }
    if (state.focus === "build"){
      addMessage("simo","Alright — build. What are we making?","build_start");
      return;
    }
  }

  // preview (includes “show me…” triggers)
  if (intent === "preview"){
    // showing a home preview should put us in build+physical and set a pending follow-up question
    if (state.domain === "physical"){
      setFocus("build");
      state.mode = "builder";
      state.domain = "physical";
      setBadges();

      const modules = parsePreviewModules(userText);
      const baseTitle = state.memory.lastTopic ? state.memory.lastTopic : "Home Layout";
      const title = `Home Layout: ${baseTitle}`;

      state.memory.lastPreviewSpec = {
        title,
        modules,
        notes: "Simple concept layout. Tell me: single-story ranch, or two-story?"
      };

      previewBadge.textContent = "Shown";
      renderPreview(state.memory.lastPreviewSpec);
      setContextCards();

      // set pending so "ranch" is understood
      state.pending = "home_story";
      addMessage("simo","Preview’s on the right. Want single-story ranch, or two-story with bedrooms upstairs?","home_story_q");
      return;
    }

    // digital preview request
    setFocus("build");
    state.mode = "builder";
    state.domain = "digital";
    setBadges();

    state.memory.lastPreviewSpec = {
      title: "App Preview (generic)",
      modules: ["search","filters","cards","map","action panel"],
      notes: "Tell me who the user is and what the main action is."
    };

    previewBadge.textContent = "Shown";
    renderPreview(state.memory.lastPreviewSpec);
    setContextCards();

    addMessage("simo","Preview’s on the right. Who’s the main user, and what’s the main action?","digital_preview_q");
    return;
  }

  // pro gating
  if (state.plan !== "pro" && isProAction(userText)){
    addMessage("simo",
      "I can do that — but that’s a paid-upgrade type action.\nToggle Pro (top right) and I’ll treat it like the upgraded plan.",
      "pro_gate"
    );
    openModal();
    setContextCards();
    setBadges();
    return;
  }

  // If user asks for an app build, kick off staged flow immediately
  if (/(\bapp\b|\bsoftware\b|\bsaas\b|\bwebsite\b|\bweb app\b)/i.test(userText)){
    setFocus("build");
    state.mode = "builder";
    state.domain = "digital";
    setBadges();
    resetPending();

    // start staged questions
    state.buildStage = 1;
    state.pending = "app_user";
    addMessage(
      "simo",
      "Alright — app build.\nWho’s the main user?\nPick one: (A) homeowners (B) contractors/designers (C) both.",
      "app_user_q"
    );
    setContextCards();
    return;
  }

  // Default: ask lane once (and don’t loop)
  setBadges();
  setContextCards();
  askLaneOnce();
}

/* Sending */
function sendMessage(){
  const text = inputEl.value.trim();
  if (!text) return;
  addMessage("user", text);
  inputEl.value = "";
  simoReply(text);
}

sendBtn.addEventListener("click", sendMessage);
inputEl.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

/* Buttons */
clearBtn.addEventListener("click", () => {
  state.history = [];
  state.focus = "";
  state.domain = "";
  state.mode = "friend";
  state.expectingLaneChoice = false;
  state.lastSimoKey = "";
  resetPending();
  resetBuildStages();
  state.memory.lastIntent = "";
  state.memory.lastTopic = "";
  state.memory.lastPreviewSpec = null;
  state.memory.home = { story:"", garage:"", beds:"", baths:"", sqft:"" };

  chatEl.innerHTML = "";
  previewArea.innerHTML = `<div class="small">No preview yet. Ask for one.</div>`;
  previewBadge.textContent = "Ready";
  setContextCards();
  setBadges();

  addMessage("simo", "Clean slate. I’m still here. What’s up?", "clean_slate");
});

togglePlanBtn.addEventListener("click", () => {
  state.plan = (state.plan === "pro") ? "free" : "pro";
  setBadges();
});

closeModalBtn.addEventListener("click", closeModal);
modalBackdrop.addEventListener("click", (e) => {
  if (e.target === modalBackdrop) closeModal();
});
enableProBtn.addEventListener("click", () => {
  state.plan = "pro";
  setBadges();
  closeModal();
  addMessage("simo","Alright — Pro is on. Now tell me exactly what you want me to generate.","pro_on");
});

/* Boot */
setBadges();
setContextCards();
addMessage("simo",
  "Hey. I’m here.\nIf you want visuals, say: “show me…” and include what you want on it.",
  "boot"
);
</script>
</body>
</html>
