<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simo</title>
  <style>
    :root{
      --bg:#0b1020; --text:#eaf0ff; --muted:#a9b6d3;
      --line:rgba(255,255,255,.10);
      --card:rgba(255,255,255,.04);
      --card2:rgba(0,0,0,.20);
      --shadow: 0 18px 55px rgba(0,0,0,.45);

      --btn:#2a66ff; --btn2:#1f4dd6;
      --good:#39d98a;
      --bad:#ff4d4d;

      --pro:#39d98a;
      --proGlow: 0 0 0 2px rgba(57,217,138,.18), 0 0 22px rgba(57,217,138,.28);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:radial-gradient(1200px 700px at 20% 0%, #162a66 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      padding:16px 18px;border-radius:22px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:44px;height:44px;border-radius:14px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.08));
      position:relative;
      overflow:hidden;
    }
    .logo.pro{
      border-color: rgba(57,217,138,.45);
      box-shadow: var(--proGlow);
    }
    .logo.pro:before{
      content:"";
      position:absolute;inset:-30%;
      background:radial-gradient(circle at 30% 30%, rgba(57,217,138,.55), rgba(57,217,138,0) 55%);
      filter: blur(2px);
    }
    .brand h1{margin:0;font-size:26px;line-height:1}
    .brand .sub{margin-top:4px;color:rgba(234,240,255,.7);font-weight:700;font-size:13px}

    .topActions{display:flex;gap:10px;align-items:center}
    .pillBtn{
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      color:var(--text);
      padding:10px 14px;border-radius:999px;
      font-weight:900;
      cursor:pointer;
    }
    .pillBtn:active{transform:translateY(1px)}
    .toggle{
      display:flex;align-items:center;gap:10px;
      padding:10px 14px;border-radius:999px;
      border:1px solid rgba(57,217,138,.35);
      background:rgba(57,217,138,.08);
      box-shadow: var(--proGlow);
      user-select:none;
    }
    .toggle.off{
      border-color: var(--line);
      background:rgba(0,0,0,.18);
      box-shadow:none;
    }
    .toggle span{font-weight:950}
    .switch{
      width:44px;height:26px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.22);
      position:relative;
      cursor:pointer;
    }
    .knob{
      position:absolute;top:3px;left:3px;
      width:20px;height:20px;border-radius:50%;
      background:rgba(255,255,255,.75);
      transition: transform .18s ease;
    }
    .toggle.on .switch{
      border-color: rgba(57,217,138,.5);
      background:rgba(57,217,138,.18);
    }
    .toggle.on .knob{ transform: translateX(18px); background: rgba(57,217,138,.95); }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr 1fr;
      gap:16px;
      margin-top:16px;
    }
    .panel{
      border:1px solid var(--line);
      border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height: 640px;
    }
    .panelHead{
      padding:16px 16px 10px;
      display:flex;align-items:center;justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .panelTitle{
      font-size:22px;font-weight:1000;letter-spacing:.2px;
      display:flex;align-items:center;gap:10px;
    }
    .modePills{display:flex;gap:10px}
    .modePill{
      padding:10px 14px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:rgba(234,240,255,.85);
      font-weight:950;
      cursor:pointer;
    }
    .modePill.active{
      border-color: rgba(42,102,255,.45);
      background: linear-gradient(180deg, rgba(42,102,255,.25), rgba(31,77,214,.12));
      box-shadow: 0 0 0 2px rgba(42,102,255,.08);
      color: var(--text);
    }

    .chatBody{
      padding:14px 16px 12px;
      height: 520px;
      overflow:auto;
    }
    .msg{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      border-radius:16px;
      padding:12px 12px;
      margin-bottom:10px;
      line-height:1.35;
    }
    .msg .who{font-weight:950;color:rgba(234,240,255,.72);font-size:13px;margin-bottom:6px}
    .msg.user{
      background: linear-gradient(180deg, rgba(42,102,255,.18), rgba(0,0,0,.18));
      border-color: rgba(42,102,255,.25);
    }
    .msg.error{
      border-color: rgba(255,77,77,.35);
      background: rgba(255,77,77,.10);
    }

    .composer{
      padding:12px 16px 16px;
      display:flex;gap:10px;align-items:flex-end;
    }
    textarea{
      flex:1;
      resize:none;
      min-height:54px;
      max-height:120px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:14px;
    }
    .sendBtn{
      padding:14px 18px;border-radius:14px;
      border:1px solid rgba(42,102,255,.45);
      background: linear-gradient(180deg,var(--btn),var(--btn2));
      color:var(--text);
      font-weight:1000;
      cursor:pointer;
    }
    .sendBtn:active{transform:translateY(1px)}
    .hint{
      padding:0 16px 16px;
      color:rgba(234,240,255,.65);
      font-size:12.5px;
      font-weight:700;
    }

    /* Preview */
    .previewHeadRight{display:flex;gap:10px;align-items:center}
    .miniBtn{
      padding:10px 12px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color:var(--text);
      font-weight:950;
      cursor:pointer;
    }
    .miniBtn:active{transform:translateY(1px)}
    .miniBtn.disabled{opacity:.4;cursor:not-allowed}
    .previewMeta{
      padding:10px 16px;
      display:flex;align-items:center;justify-content:space-between;
      color:rgba(234,240,255,.75);
      font-weight:800;
    }
    .badges{display:flex;gap:10px;align-items:center}
    .badge{
      padding:7px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      font-weight:950;
      font-size:12px;
    }
    .badge.pro{
      border-color: rgba(57,217,138,.45);
      background: rgba(57,217,138,.12);
      color: rgba(210,255,232,.95);
      box-shadow: var(--proGlow);
    }

    .previewBox{
      margin:0 16px 16px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      background: rgba(0,0,0,.12);
      height: 510px;
      position:relative;
    }
    iframe{
      width:100%;height:100%;
      border:0;
      background:#fff;
    }
    .previewEmpty{
      position:absolute;inset:0;
      display:flex;align-items:center;justify-content:center;
      flex-direction:column;
      color:rgba(234,240,255,.72);
      text-align:center;
      padding:24px;
      pointer-events:none;
    }
    .previewEmpty h2{margin:0 0 10px;font-size:34px}
    .previewEmpty p{margin:0;max-width:520px;line-height:1.35}
    .statusRow{
      padding:0 16px 16px;
      display:flex;align-items:center;gap:10px;
      color:rgba(234,240,255,.75);
      font-weight:850;
      font-size:13px;
    }
    .dot{
      width:9px;height:9px;border-radius:50%;
      background: var(--good);
      box-shadow: 0 0 10px rgba(57,217,138,.35);
    }
    .dot.bad{background: var(--bad); box-shadow: 0 0 10px rgba(255,77,77,.25);}
    .spacer{flex:1}

    /* Bottom pro pill */
    .proFloat{
      position:fixed;right:18px;bottom:18px;
      padding:10px 14px;border-radius:999px;
      border:1px solid rgba(57,217,138,.45);
      background: rgba(57,217,138,.12);
      color: rgba(220,255,238,.98);
      font-weight:1000;
      box-shadow: var(--proGlow);
      user-select:none;
      pointer-events:none;
    }
    .proFloat.off{
      border-color: rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color: rgba(234,240,255,.7);
      box-shadow:none;
    }

    /* Library modal */
    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
    }
    .modalBackdrop.show{display:flex}
    .modal{
      width:min(820px, 100%);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 14px;
      display:flex;align-items:center;justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .modalHead h3{margin:0;font-size:18px;font-weight:1000}
    .modalBody{max-height:420px;overflow:auto;padding:12px 14px}
    .item{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius:14px;
      padding:12px;
      margin-bottom:10px;
      display:flex;align-items:center;justify-content:space-between;
      gap:12px;
    }
    .item .name{font-weight:1000}
    .item .meta{color:rgba(234,240,255,.65);font-size:12px;font-weight:800;margin-top:4px}
    .rowBtns{display:flex;gap:10px}
    .smBtn{
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color:var(--text);
      font-weight:950;
      cursor:pointer;
    }
    .smBtn.danger{border-color: rgba(255,77,77,.35); background: rgba(255,77,77,.10)}
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .chatBody{height:auto;max-height:420px}
      .panel{min-height:auto}
      .previewBox{height:460px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div id="logo" class="logo"></div>
        <div>
          <h1>Simo</h1>
          <div class="sub">best friend + builder</div>
        </div>
      </div>

      <div class="topActions">
        <div id="proToggle" class="toggle off" title="Pro Mode controls previews + advanced tools">
          <span>Pro Mode</span>
          <div class="switch" role="switch" aria-checked="false" tabindex="0">
            <div class="knob"></div>
          </div>
        </div>
        <button id="resetBtn" class="pillBtn">Reset</button>
        <button id="libraryBtnTop" class="pillBtn">Library</button>
      </div>
    </div>

    <div class="grid">
      <!-- CHAT -->
      <div class="panel">
        <div class="panelHead">
          <div class="panelTitle">CHAT</div>
          <div class="modePills">
            <button class="modePill" data-mode="venting">Venting</button>
            <button class="modePill" data-mode="solving">Solving</button>
            <button class="modePill active" data-mode="building">Building</button>
          </div>
        </div>

        <div id="chatBody" class="chatBody"></div>

        <div class="composer">
          <textarea id="input" placeholder="Type here... (Enter to send, Shift+Enter for new line)"></textarea>
          <button id="sendBtn" class="sendBtn">Send</button>
        </div>
        <div class="hint"><b>Tip:</b> in <b>Building</b> mode, ask for a layout/app/site and I’ll render a preview (Pro).</div>
      </div>

      <!-- PREVIEW -->
      <div class="panel">
        <div class="panelHead">
          <div class="panelTitle">PREVIEW</div>
          <div class="previewHeadRight">
            <button id="saveBuildBtn" class="miniBtn">Save Build</button>
            <button id="libraryBtn" class="miniBtn">Library</button>
            <button id="copyHtmlBtn" class="miniBtn">Copy HTML</button>
            <button id="downloadBtn" class="miniBtn">Download</button>
          </div>
        </div>

        <div class="previewMeta">
          <div>Current: <span id="currentName"><b>Untitled preview</b></span></div>
          <div class="badges">
            <span id="modeBadge" class="badge">Building</span>
            <span id="proBadge" class="badge">PRO disabled</span>
          </div>
        </div>

        <div class="previewBox">
          <iframe id="previewFrame" sandbox="allow-forms allow-scripts allow-same-origin"></iframe>
          <div id="previewEmpty" class="previewEmpty">
            <h2>No preview yet.</h2>
            <p>Switch to <b>Building</b> and ask: “build a landing page preview”.</p>
          </div>
        </div>

        <div class="statusRow">
          <div id="statusDot" class="dot"></div>
          <div id="statusText">Ready</div>
          <div class="spacer"></div>
          <div style="opacity:.8">Library is saved on this device.</div>
        </div>
      </div>
    </div>
  </div>

  <div id="proFloat" class="proFloat off">PRO disabled</div>

  <!-- Library Modal -->
  <div id="modalBackdrop" class="modalBackdrop">
    <div class="modal">
      <div class="modalHead">
        <h3>Library</h3>
        <button id="closeModal" class="smBtn">Close</button>
      </div>
      <div id="modalBody" class="modalBody"></div>
    </div>
  </div>

<script>
(function(){
  const API = "/api/simon";

  const chatBody = document.getElementById("chatBody");
  const input = document.getElementById("input");
  const sendBtn = document.getElementById("sendBtn");

  const proToggle = document.getElementById("proToggle");
  const logo = document.getElementById("logo");
  const proBadge = document.getElementById("proBadge");
  const proFloat = document.getElementById("proFloat");

  const modeBadge = document.getElementById("modeBadge");
  const modeButtons = Array.from(document.querySelectorAll(".modePill"));

  const previewFrame = document.getElementById("previewFrame");
  const previewEmpty = document.getElementById("previewEmpty");
  const currentName = document.getElementById("currentName");

  const saveBuildBtn = document.getElementById("saveBuildBtn");
  const libraryBtn = document.getElementById("libraryBtn");
  const libraryBtnTop = document.getElementById("libraryBtnTop");
  const copyHtmlBtn = document.getElementById("copyHtmlBtn");
  const downloadBtn = document.getElementById("downloadBtn");
  const resetBtn = document.getElementById("resetBtn");

  const statusDot = document.getElementById("statusDot");
  const statusText = document.getElementById("statusText");

  const modalBackdrop = document.getElementById("modalBackdrop");
  const modalBody = document.getElementById("modalBody");
  const closeModal = document.getElementById("closeModal");

  // State
  const state = {
    mode: "building",
    pro: false,
    current: {
      name: "Untitled preview",
      html: ""
    },
    sending: false
  };

  function setStatus(ok, text){
    statusDot.classList.toggle("bad", !ok);
    statusText.textContent = text || (ok ? "Ready" : "Server error");
  }

  function addMsg(who, text, kind){
    const d = document.createElement("div");
    d.className = "msg" + (who === "You" ? " user" : "") + (kind === "error" ? " error" : "");
    d.innerHTML = `<div class="who">${who}</div><div class="txt"></div>`;
    d.querySelector(".txt").textContent = text;
    chatBody.appendChild(d);
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  function setMode(mode){
    state.mode = mode;
    modeButtons.forEach(b => b.classList.toggle("active", b.dataset.mode === mode));
    modeBadge.textContent = mode.charAt(0).toUpperCase() + mode.slice(1);
  }

  function setPro(on){
    state.pro = !!on;
    proToggle.classList.toggle("on", state.pro);
    proToggle.classList.toggle("off", !state.pro);
    proToggle.querySelector(".switch").setAttribute("aria-checked", String(state.pro));

    logo.classList.toggle("pro", state.pro);

    if (state.pro){
      proBadge.textContent = "PRO enabled";
      proBadge.classList.add("pro");
      proFloat.textContent = "PRO enabled";
      proFloat.classList.remove("off");
      proFloat.classList.add("on");
    } else {
      proBadge.textContent = "PRO disabled";
      proBadge.classList.remove("pro");
      proFloat.textContent = "PRO disabled";
      proFloat.classList.add("off");
      proFloat.classList.remove("on");
    }
    localStorage.setItem("simo_pro", state.pro ? "1" : "0");
  }

  function setPreview(name, html){
    state.current.name = name || "Untitled preview";
    state.current.html = html || "";
    currentName.innerHTML = `<b>${state.current.name}</b>`;

    if (state.current.html){
      previewFrame.srcdoc = state.current.html;
      previewEmpty.style.display = "none";
      copyHtmlBtn.classList.remove("disabled");
      downloadBtn.classList.remove("disabled");
      saveBuildBtn.classList.remove("disabled");
    } else {
      previewFrame.srcdoc = "";
      previewEmpty.style.display = "flex";
    }
  }

  function getLibrary(){
    try { return JSON.parse(localStorage.getItem("simo_library") || "[]"); }
    catch(e){ return []; }
  }
  function setLibrary(items){
    localStorage.setItem("simo_library", JSON.stringify(items || []));
  }

  function openLibrary(){
    renderLibrary();
    modalBackdrop.classList.add("show");
  }
  function closeLibrary(){
    modalBackdrop.classList.remove("show");
  }

  function renderLibrary(){
    const items = getLibrary();
    if (!items.length){
      modalBody.innerHTML = `<div class="item"><div><div class="name">No saved builds yet.</div><div class="meta">Use “Save Build” to store previews.</div></div></div>`;
      return;
    }
    modalBody.innerHTML = "";
    items.slice().reverse().forEach(item => {
      const el = document.createElement("div");
      el.className = "item";
      const when = new Date(item.createdAt).toLocaleString();
      el.innerHTML = `
        <div>
          <div class="name">${item.name}</div>
          <div class="meta">${when}</div>
        </div>
        <div class="rowBtns">
          <button class="smBtn" data-act="load">Load</button>
          <button class="smBtn" data-act="copy">Copy</button>
          <button class="smBtn danger" data-act="delete">Delete</button>
        </div>
      `;
      el.querySelector('[data-act="load"]').onclick = () => {
        setPreview(item.name, item.html);
        setStatus(true, "Loaded from Library");
        closeLibrary();
      };
      el.querySelector('[data-act="copy"]').onclick = async () => {
        await copyText(item.html);
        setStatus(true, "HTML copied");
      };
      el.querySelector('[data-act="delete"]').onclick = () => {
        const next = getLibrary().filter(x => x.id !== item.id);
        setLibrary(next);
        renderLibrary();
        setStatus(true, "Deleted");
      };
      modalBody.appendChild(el);
    });
  }

  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text || "");
      return true;
    }catch(e){
      // fallback
      const ta = document.createElement("textarea");
      ta.value = text || "";
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      return true;
    }
  }

  function downloadHtml(name, html){
    const blob = new Blob([html || ""], {type:"text/html;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    const safe = (name || "preview").replace(/[^\w\-]+/g,"_");
    a.download = safe + ".html";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function postMessage(message){
    const payload = { message, mode: state.mode, pro: state.pro };

    // 20s timeout
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), 20000);

    const res = await fetch(API, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify(payload),
      signal: controller.signal
    }).finally(() => clearTimeout(t));

    const data = await res.json().catch(() => null);
    if (!res.ok || !data || data.ok === false){
      const err = (data && (data.error || data.message)) || ("HTTP " + res.status);
      throw new Error(err);
    }
    return data;
  }

  async function send(){
    if (state.sending) return;
    const text = (input.value || "").trim();
    if (!text) return;

    state.sending = true;
    setStatus(true, "Thinking...");
    sendBtn.disabled = true;

    addMsg("You", text);
    input.value = "";

    try{
      const data = await postMessage(text);

      addMsg("Simo", data.reply || "Okay.");

      if (data.preview && data.preview.kind === "html" && data.preview.html){
        setPreview(data.preview.name || "preview", data.preview.html);
        setStatus(true, "Preview updated");
      } else {
        setStatus(true, "Ready");
      }
    } catch(e){
      addMsg("Simo", "Server error", "error");
      setStatus(false, "Server error");
    } finally {
      state.sending = false;
      sendBtn.disabled = false;
      input.focus();
    }
  }

  // Events
  sendBtn.onclick = send;

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      send();
    }
  });

  modeButtons.forEach(b => {
    b.onclick = () => setMode(b.dataset.mode);
  });

  proToggle.onclick = () => setPro(!state.pro);
  proToggle.querySelector(".switch").addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " "){
      e.preventDefault();
      setPro(!state.pro);
    }
  });

  resetBtn.onclick = () => {
    chatBody.innerHTML = "";
    addMsg("Simo", "Fresh start. I’m here.");
    setPreview("Untitled preview", "");
    setStatus(true, "Ready");
  };

  copyHtmlBtn.onclick = async () => {
    if (!state.current.html){ setStatus(false, "Nothing to copy"); return; }
    await copyText(state.current.html);
    setStatus(true, "HTML copied");
  };

  downloadBtn.onclick = () => {
    if (!state.current.html){ setStatus(false, "Nothing to download"); return; }
    downloadHtml(state.current.name, state.current.html);
    setStatus(true, "Downloaded");
  };

  saveBuildBtn.onclick = () => {
    if (!state.current.html){ setStatus(false, "Nothing to save"); return; }
    const items = getLibrary();
    const id = crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2);
    items.push({ id, name: state.current.name, html: state.current.html, createdAt: Date.now() });
    setLibrary(items);
    setStatus(true, "Saved to Library");
  };

  libraryBtn.onclick = openLibrary;
  libraryBtnTop.onclick = openLibrary;
  closeModal.onclick = closeLibrary;
  modalBackdrop.onclick = (e) => { if (e.target === modalBackdrop) closeLibrary(); };

  // Boot
  (function init(){
    setMode("building");
    const savedPro = localStorage.getItem("simo_pro") === "1";
    setPro(savedPro);

    addMsg("Simo", "I’m here. Pick a mode — or just talk.");
    setPreview("Untitled preview", "");
    setStatus(true, "Ready");
  })();

})();
</script>
</body>
</html>
