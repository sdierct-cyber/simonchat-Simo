<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simo</title>

<style>
:root{
  --bg:#0b1020;
  --panel:#121933;
  --panel2:#0e1530;
  --text:#eaf0ff;
  --muted:#a9b6d3;
  --line:rgba(255,255,255,.10);
  --accent:#2a66ff;
  --accent2:#1f4dd6;
  --warn:#ffcc66;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:radial-gradient(1200px 700px at 20% 0%, #162a66 0%, var(--bg) 55%);
  color:var(--text);
}

.wrap{max-width:980px;margin:0 auto;padding:18px}

.top{
  display:flex;align-items:center;justify-content:space-between;
  gap:12px;margin-bottom:12px;
}

.brand{font-size:22px;font-weight:700;letter-spacing:.2px}
.sub{font-size:12px;color:var(--muted);margin-top:2px}

.badgeRow{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.badge{
  font-size:12px;color:var(--muted);
  border:1px solid var(--line);padding:6px 10px;border-radius:999px;
  background:rgba(255,255,255,.04);
}
.badge strong{color:var(--text);font-weight:700}

.grid{
  display:grid;
  grid-template-columns: 1.2fr .8fr;
  gap:12px;
}
@media (max-width: 920px){ .grid{grid-template-columns: 1fr} }

.card{
  background:rgba(255,255,255,.03);
  border:1px solid var(--line);
  border-radius:14px;
  overflow:hidden;
}

.cardHeader{
  padding:12px 12px 10px;
  border-bottom:1px solid var(--line);
  display:flex;align-items:center;justify-content:space-between;gap:10px;
}
.cardTitle{font-weight:700}
.cardHint{color:var(--muted);font-size:12px}

.chat{height:520px;overflow:auto;padding:12px}

.msg{margin:0 0 12px 0;line-height:1.5;font-size:14px}
.msg .who{display:inline-block;font-weight:700;margin-right:8px}
.msg.user .who{color:#fff}
.msg.simo .who{color:var(--muted)}

.bubble{
  display:inline-block;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.02);
  max-width:95%;
  white-space:pre-wrap;
}
.msg.user .bubble{
  background:rgba(42,102,255,.10);
  border-color:rgba(42,102,255,.25);
}

.controls{
  padding:12px;
  border-top:1px solid var(--line);
  display:flex;gap:8px;align-items:flex-end;
  background:rgba(0,0,0,.10);
}

textarea{
  flex:1;height:52px;resize:none;
  border-radius:12px;border:1px solid var(--line);
  background:var(--panel2);
  color:var(--text);
  padding:10px 12px;
  font-size:14px;outline:none;
}

button{
  border:none;padding:12px 14px;border-radius:12px;
  font-weight:800;cursor:pointer;color:#fff;background:var(--accent);
}
button:hover{background:var(--accent2)}

.secondaryBtn{
  background:rgba(255,255,255,.06);
  border:1px solid var(--line);
  color:var(--text);
}
.secondaryBtn:hover{background:rgba(255,255,255,.10)}

.side{padding:12px}

.kv{
  display:flex;justify-content:space-between;gap:10px;
  padding:10px 10px;border:1px solid var(--line);
  border-radius:12px;background:rgba(255,255,255,.02);
  margin-bottom:10px;font-size:13px;
}
.kv span{color:var(--muted)}
.small{color:var(--muted);font-size:12px;line-height:1.4}

hr.sep{border:none;border-top:1px solid var(--line);margin:12px 0}

.previewWrap{padding:12px}

.previewCard{
  background:#fff;color:#111;
  border-radius:14px;padding:14px;
  border:1px solid rgba(0,0,0,.10);
}

.previewTitle{
  display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
}
.previewTitle h3{margin:0;font-size:16px}
.previewTitle .tag{
  font-size:11px;padding:6px 10px;border-radius:999px;
  border:1px solid rgba(0,0,0,.12);
  background:#f3f4f6;
}

.previewSub{color:#444;font-size:12px;margin:6px 0 10px}
.pillRow{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 10px}
.pill{
  font-size:11px;padding:6px 10px;border-radius:999px;
  border:1px solid #c7d2fe;background:#eef2ff;
}

.blockTitle{font-size:12px;font-weight:800;margin:12px 0 8px;color:#222}
.box{
  border:1px solid #e5e7eb;border-radius:12px;
  padding:10px;background:#f9fafb;margin-bottom:8px;
}
.grayBox{height:140px;background:#e5e7eb;border-radius:12px}

.modalBackdrop{
  position:fixed;inset:0;background:rgba(0,0,0,.55);
  display:none;align-items:center;justify-content:center;
  padding:20px;
}
.modal{
  width:min(520px, 100%);
  border-radius:16px;border:1px solid var(--line);
  background:rgba(18,25,51,.98);
  padding:14px;
}
.modal h3{margin:0 0 6px 0}
.modal p{margin:0 0 12px 0;color:var(--muted);line-height:1.45;font-size:13px}
.modal .row{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
.warnLine{
  border:1px dashed rgba(255,204,102,.45);
  background:rgba(255,204,102,.08);
  color:#ffe7b3;
  padding:10px 12px;border-radius:12px;
  font-size:12px;margin-top:10px;
}
</style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div>
      <div class="brand">Hey — I’m Simo.</div>
      <div class="sub">Best friend vibes by default. Previews adapt to what you ask for.</div>
    </div>
    <div class="badgeRow">
      <div class="badge">Plan: <strong id="planBadge">Free</strong></div>
      <div class="badge">Mode: <strong id="modeBadge">Friend</strong></div>
      <div class="badge">Focus: <strong id="focusBadge">—</strong></div>
      <div class="badge">Domain: <strong id="domainBadge">—</strong></div>
      <div class="badge">Preview: <strong id="previewBadge">Ready</strong></div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="cardHeader">
        <div>
          <div class="cardTitle">Chat</div>
          <div class="cardHint">Enter to send • Shift+Enter for a new line</div>
        </div>
        <button class="secondaryBtn" id="clearBtn" type="button">Clear</button>
      </div>

      <div id="chat" class="chat"></div>

      <div class="controls">
        <textarea id="input" placeholder="Talk to Simo…"></textarea>
        <button id="sendBtn" type="button">Send</button>
      </div>
    </div>

    <div class="card">
      <div class="cardHeader">
        <div>
          <div class="cardTitle">Preview</div>
          <div class="cardHint">Say “show me…” + what you want on it</div>
        </div>
        <button class="secondaryBtn" id="togglePlanBtn" type="button">Toggle Pro</button>
      </div>

      <div class="side">
        <div class="kv"><span>Last intent</span><strong id="intentKV">—</strong></div>
        <div class="kv"><span>Project/topic</span><strong id="topicKV">—</strong></div>
        <div class="kv"><span>Preview modules</span><strong id="modulesKV">—</strong></div>

        <div class="small">
          Type “switch topics” to reset the lane and start fresh without weird carryover.
        </div>

        <hr class="sep" />

        <div id="previewArea" class="previewWrap">
          <div class="small">No preview yet. Ask for one.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="modalBackdrop" class="modalBackdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <h3>That’s a Pro action</h3>
    <p>
      I can do that — but in the Free plan I keep it light. Toggle Pro to simulate paid upgrades.
      (Payment wiring comes later; this is UI + logic gate.)
    </p>
    <div class="row">
      <button class="secondaryBtn" id="closeModalBtn" type="button">Not now</button>
      <button id="enableProBtn" type="button">Enable Pro</button>
    </div>
    <div class="warnLine">
      This doesn’t charge anyone. It only flips the plan state.
    </div>
  </div>
</div>

<script>
const state = {
  plan: "free",
  mode: "friend",
  focus: "",               // vent | solve | build
  domain: "",              // physical | digital | general
  expectingLaneChoice: false,
  lastSimoKey: "",
  buildStage: 0,           // prevents repeating prompts in digital build
  history: [],
  memory: {
    lastIntent: "",
    lastTopic: "",
    lastPreviewSpec: null,
  }
};

const chatEl = document.getElementById("chat");
const inputEl = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");

const clearBtn = document.getElementById("clearBtn");
const togglePlanBtn = document.getElementById("togglePlanBtn");

const planBadge = document.getElementById("planBadge");
const modeBadge = document.getElementById("modeBadge");
const focusBadge = document.getElementById("focusBadge");
const domainBadge = document.getElementById("domainBadge");
const previewBadge = document.getElementById("previewBadge");

const intentKV = document.getElementById("intentKV");
const topicKV = document.getElementById("topicKV");
const modulesKV = document.getElementById("modulesKV");
const previewArea = document.getElementById("previewArea");

const modalBackdrop = document.getElementById("modalBackdrop");
const closeModalBtn = document.getElementById("closeModalBtn");
const enableProBtn = document.getElementById("enableProBtn");

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function nowTs(){ return new Date().toISOString(); }

function setBadges(){
  planBadge.textContent = state.plan === "pro" ? "Pro" : "Free";
  modeBadge.textContent = state.mode === "builder" ? "Builder" : "Friend";
  focusBadge.textContent = state.focus ? state.focus.toUpperCase() : "—";
  domainBadge.textContent = state.domain ? state.domain.toUpperCase() : "—";
}
function setContextCards(){
  intentKV.textContent = state.memory.lastIntent || "—";
  topicKV.textContent = state.memory.lastTopic || "—";
  modulesKV.textContent = state.memory.lastPreviewSpec?.modules?.length
    ? state.memory.lastPreviewSpec.modules.join(", ")
    : "—";
}
function openModal(){ modalBackdrop.style.display = "flex"; }
function closeModal(){ modalBackdrop.style.display = "none"; }

function addMessage(role, text, key=""){
  state.history.push({ role, text, ts: nowTs() });

  const msg = document.createElement("div");
  msg.className = "msg " + (role === "user" ? "user" : "simo");

  const who = document.createElement("span");
  who.className = "who";
  who.textContent = role === "user" ? "You:" : "Simo:";

  const bubble = document.createElement("span");
  bubble.className = "bubble";
  bubble.innerHTML = escapeHtml(text);

  msg.appendChild(who);
  msg.appendChild(bubble);
  chatEl.appendChild(msg);
  chatEl.scrollTop = chatEl.scrollHeight;

  if (role === "simo" && key) state.lastSimoKey = key;
}

/* Domain detection */
function detectDomain(text){
  const t = (text || "").toLowerCase();

  const physicalHits = [
    "home","house","floor plan","layout","blueprint","garage","bedroom","bath","sq ft","square feet",
    "kitchen","living room","foundation","lot","roof","modern home"
  ];
  const digitalHits = [
    "app","website","web app","saas","software","ui","ux","screen","dashboard","login","api","database","frontend","backend"
  ];

  let p=0, d=0;
  for (const w of physicalHits) if (t.includes(w)) p++;
  for (const w of digitalHits) if (t.includes(w)) d++;

  if (p >= 2 && p >= d) return "physical";
  if (d >= 2 && d > p) return "digital";
  return "general";
}

/* Intent detection */
function detectIntent(text){
  const t = text.toLowerCase().trim();

  if (/^(switch topics|new topic|change topic|switch topic)$/i.test(t)) return "switch_topics";

  if (/(switch to|lets|let's)\s+(vent|venting)/i.test(text) || /\bvent(ing)?\b/.test(t)) return "lane_vent";
  if (/(switch to|lets|let's)\s+(solve|solving|problem solve|problem solving)/i.test(text) || /\b(problem\s*solv|solv(ing|e))\b/.test(t)) return "lane_solve";
  if (/(switch to|lets|let's)\s+(build|building|create|design)/i.test(text) || /\b(build(ing)?|create|design)\b/.test(t)) return "lane_build";

  if (/\bshow me\b/.test(t) && (t.includes("layout") || t.includes("floor plan") || t.includes("home") || t.includes("house") || t.includes("mockup") || t.includes("preview") || t.includes("wireframe"))) return "preview";
  if (/(preview|mockup|wireframe)\b/i.test(text)) return "preview";

  if (/(write|draft|email|resume|cover letter|bio|script|story|book)/i.test(text)) return "write";
  if (/(code|html|css|js|javascript|react|bug|fix|error)/i.test(text)) return "code";
  if (/(stressed|tired|argument|anxious|overwhelmed|mad|upset|drained)/i.test(text)) return "vent";

  if (/(help me|idea|plan|how do i)/i.test(text)) return "solve";
  return "chat";
}

function cleanTopic(s){
  return s
    .replace(/[?.!]+$/g, "")
    .replace(/\b(show me|a|an|the|quick|simple|one-page|ui|mockup|preview)\b/ig, "")
    .replace(/\s+/g, " ")
    .trim();
}
function shorten(s){
  if (!s) return "";
  return s.length > 56 ? (s.slice(0, 56).trim() + "…") : s;
}
function inferTopic(text){
  const raw = (text || "").trim();
  if (!raw) return "";
  const m1 = raw.match(/(?:preview|mockup|layout|floor plan)\s+(?:of|for)\s+(.+)$/i);
  if (m1 && m1[1]) return shorten(cleanTopic(m1[1]));
  const m2 = raw.match(/(?:build|create|design)\s+(?:me|a|an)\s+(.+)$/i);
  if (m2 && m2[1]) return shorten(cleanTopic(m2[1]));
  return shorten(raw);
}

/* Preview modules */
function parsePreviewModules(text){
  const t = (text || "").toLowerCase();
  const modules = [];

  if (t.includes("floor plan") || t.includes("layout") || t.includes("home") || t.includes("house")) {
    modules.push("floor plan");
    if (t.includes("garage")) modules.push("garage");
    modules.push("rooms");
    modules.push("dimensions");
    modules.push("notes");
    return [...new Set(modules)];
  }

  if (t.includes("search")) modules.push("search");
  if (t.includes("filter") || t.includes("chip")) modules.push("filters");
  if (t.includes("card") || t.includes("listing") || t.includes("results")) modules.push("cards");
  if (t.includes("map") || t.includes("image") || t.includes("visual")) modules.push("map");
  if (t.includes("booking") || t.includes("checkout") || t.includes("reserve") || t.includes("submit")) modules.push("action panel");

  if (modules.length === 0) modules.push("search","filters","cards","map","action panel");
  return [...new Set(modules)];
}

function renderPreview(spec){
  const title = spec.title || "Preview";
  const modules = spec.modules || [];
  const notes = spec.notes || "Tell me what to adjust.";

  if (modules.includes("floor plan")){
    previewArea.innerHTML = `
      <div class="previewCard">
        <div class="previewTitle">
          <div>
            <h3>${escapeHtml(title)}</h3>
            <div class="previewSub">${escapeHtml(notes)}</div>
          </div>
          <div class="tag">Floor Plan</div>
        </div>

        <div class="blockTitle">Simple layout concept (not to scale)</div>
        <div class="box">
          <div style="display:grid;gap:10px;">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
              <div class="box" style="background:#fff;">Bedroom 2</div>
              <div class="box" style="background:#fff;">Bedroom 3</div>
            </div>
            <div class="box" style="background:#fff;">Bath + Laundry (central)</div>
            <div class="box" style="background:#fff;">Primary Suite (bed + bath + closet)</div>
            <div style="display:grid;grid-template-columns:1.3fr .7fr;gap:10px;">
              <div class="box" style="background:#fff;">Open Kitchen + Dining + Living</div>
              <div class="box" style="background:#fff;">Entry / Mudroom</div>
            </div>
            <div class="box" style="background:#fff;">Attached 2-Car Garage (front/side)</div>
          </div>
        </div>

        <div class="blockTitle">Quick questions to refine</div>
        <div class="pillRow">
          <div class="pill">single-story or two-story?</div>
          <div class="pill">lot width/depth?</div>
          <div class="pill">garage front or side?</div>
          <div class="pill">open concept level?</div>
        </div>
      </div>
    `;
    return;
  }

  // generic digital preview
  previewArea.innerHTML = `
    <div class="previewCard">
      <div class="previewTitle">
        <div>
          <h3>${escapeHtml(title)}</h3>
          <div class="previewSub">${escapeHtml(notes)}</div>
        </div>
        <div class="tag">Preview</div>
      </div>

      <div class="blockTitle">Search / Input</div>
      <div class="box">Type here…</div>

      <div class="blockTitle">Filters</div>
      <div class="pillRow">
        <div class="pill">Filter A</div><div class="pill">Filter B</div><div class="pill">Filter C</div>
      </div>

      <div class="blockTitle">Results / Cards</div>
      <div class="box"><strong>Item One</strong><br/>Short description • status/price • CTA</div>
      <div class="box"><strong>Item Two</strong><br/>Short description • status/price • CTA</div>
      <div class="box"><strong>Item Three</strong><br/>Short description • status/price • CTA</div>

      <div class="blockTitle">Main Visual / Area</div>
      <div class="grayBox"></div>

      <div class="blockTitle">Action Panel</div>
      <div class="box">Primary action: Submit / Save / Checkout</div>
    </div>
  `;
}

/* Pro gating stubs */
function isProAction(text){
  const t = text.toLowerCase();
  if (/(generate|create|build).*(full|complete).*(code|website|app)/i.test(text)) return true;
  if (/(make|generate).*(image|logo|cover|art)/i.test(text)) return true;
  if (/(export|download|pdf|docx|pptx)/i.test(text)) return true;
  if (/(connect|api key|openai|billing|stripe)/i.test(text)) return true;
  return false;
}

/* Focus helpers */
function setFocus(f){
  state.focus = f;
  state.expectingLaneChoice = false;
  setBadges();
}
function askLaneOnce(){
  if (state.lastSimoKey === "ask_lane") return;
  state.expectingLaneChoice = true;
  addMessage("simo", "What do you want right now: venting, solving, or building?", "ask_lane");
}
function handleLaneChoice(intent){
  if (intent === "lane_vent"){ setFocus("vent"); return true; }
  if (intent === "lane_solve"){ setFocus("solve"); return true; }
  if (intent === "lane_build"){ setFocus("build"); return true; }
  return false;
}

/* NEW: stage-based build prompts for digital so it doesn't repeat */
function promptDigitalBuildNext(){
  state.mode = "builder";
  setBadges();

  if (state.buildStage === 0){
    state.buildStage = 1;
    addMessage(
      "simo",
      "Alright — app build.\nWho’s the main user?\nPick one: (A) homeowners (B) contractors/designers (C) both.\nThen tell me the #1 feature you want.",
      "digital_stage1"
    );
    return;
  }

  if (state.buildStage === 1){
    state.buildStage = 2;
    addMessage(
      "simo",
      "Nice. Core experience:\n(A) drag-and-drop floor plan\n(B) AI suggestions from a prompt\n(C) templates + customize\nReply A/B/C.",
      "digital_stage2"
    );
    return;
  }

  state.buildStage = 3;
  addMessage(
    "simo",
    "Cool — last setup:\n1) mobile or web first?\n2) what’s free plan include?\n3) what’s paid plan include?\nSay it rough — we’ll refine.",
    "digital_stage3"
  );
}

function nextPromptForFocus(){
  if (state.focus === "vent"){
    state.mode = "friend";
    setBadges();
    addMessage("simo","Alright — vent. What happened, and what part hit you the hardest?","vent_prompt");
    return;
  }

  if (state.focus === "solve"){
    state.mode = "builder";
    setBadges();
    addMessage(
      "simo",
      "Alright — problem solving.\nGive me:\n1) the goal (one sentence)\n2) what’s blocking you\n3) what you’ve tried",
      "solve_prompt"
    );
    return;
  }

  if (state.focus === "build"){
    // Physical build prompt
    if (state.domain === "physical"){
      state.mode = "builder";
      setBadges();
      addMessage(
        "simo",
        "Alright — home design.\nGive me:\n1) square footage target\n2) beds/baths\n3) garage (attached? front or side?)\nThen say “show me the layout” and I’ll drop a floor-plan preview on the right.",
        "build_physical_prompt"
      );
      return;
    }

    // Digital build prompt (stage-based)
    if (state.domain === "digital"){
      promptDigitalBuildNext();
      return;
    }

    // General fallback
    state.mode = "builder";
    setBadges();
    addMessage("simo","Alright — we’re building.\nWhat is it, who’s it for, and your top 3 must-haves?","build_general_prompt");
  }
}

/* Main reply */
function simoReply(userText){
  const intent = detectIntent(userText);
  state.memory.lastIntent = intent;

  // Update domain continuously
  state.domain = detectDomain(userText);

  const topic = inferTopic(userText);
  if (topic) state.memory.lastTopic = topic;

  // switch topics hard reset
  if (intent === "switch_topics"){
    state.focus = "";
    state.mode = "friend";
    state.expectingLaneChoice = false;
    state.lastSimoKey = "";
    state.buildStage = 0;
    setBadges();
    setContextCards();
    addMessage("simo","Got you — switching topics. Venting, solving, or building?","ask_lane");
    state.expectingLaneChoice = true;
    return;
  }

  // lane choice
  if (handleLaneChoice(intent)){
    setContextCards();
    nextPromptForFocus();
    return;
  }

  // preview (includes “show me…” triggers)
  if (intent === "preview"){
    const modules = parsePreviewModules(userText);
    const baseTitle = state.memory.lastTopic ? state.memory.lastTopic : "Preview";
    const title = (state.domain === "physical") ? `Home Layout: ${baseTitle}` : `Mockup: ${baseTitle}`;

    state.memory.lastPreviewSpec = {
      title,
      modules,
      notes: (state.domain === "physical")
        ? "Simple concept layout. Tell me if you want single-story vs two-story and your lot width."
        : "Generic app mockup. Tell me what sections you want (search, cards, onboarding, etc.)."
    };

    previewBadge.textContent = "Shown";
    renderPreview(state.memory.lastPreviewSpec);
    setContextCards();
    setBadges();

    addMessage(
      "simo",
      (state.domain === "physical")
        ? "Preview’s on the right. Want single-story ranch, or two-story with bedrooms upstairs?"
        : "Preview’s on the right. Want onboarding + a dashboard, or keep it one page?",
      "preview_next"
    );
    return;
  }

  // pro gating
  if (state.plan !== "pro" && isProAction(userText)){
    addMessage("simo",
      "I can do that — but that’s a paid-upgrade type action.\nToggle Pro (top right) and I’ll treat it like the upgraded plan.",
      "pro_gate"
    );
    openModal();
    setContextCards();
    setBadges();
    return;
  }

  // If they ask about an APP explicitly, automatically go build+digital and move stages
  if (/(\bapp\b|\bsoftware\b|\bsaas\b|\bwebsite\b|\bweb app\b)/i.test(userText)){
    setFocus("build");
    state.domain = "digital";
    setBadges();
    setContextCards();
    // advance digital stages instead of repeating the same question
    promptDigitalBuildNext();
    return;
  }

  // If they ask about a HOME explicitly, auto build+physical
  if (state.domain === "physical" && /(home|house|layout|floor plan|design)/i.test(userText)){
    setFocus("build");
    setBadges();
    setContextCards();
    addMessage(
      "simo",
      "Got you — home design.\nQuick: single-story or two-story? And is the garage front or side?\nThen say “show me the layout.”",
      "auto_build_physical"
    );
    return;
  }

  // If we already have focus, keep moving without repeating identical questions
  if (state.focus){
    setContextCards();
    setBadges();

    if (state.focus === "build" && state.domain === "digital"){
      // keep progressing stages
      promptDigitalBuildNext();
      return;
    }

    if (state.focus === "solve"){
      addMessage("simo",
        "Okay — hit me with:\n• goal\n• constraints\n• what you tried\nThen I’ll give you a clean next-step plan.",
        "solve_continue"
      );
      return;
    }

    if (state.focus === "vent"){
      addMessage("simo","Talk to me. What set it off?","vent_continue");
      return;
    }
  }

  // default: ask lane once
  setContextCards();
  setBadges();
  askLaneOnce();
}

/* Sending */
function sendMessage(){
  const text = inputEl.value.trim();
  if (!text) return;
  addMessage("user", text);
  inputEl.value = "";
  simoReply(text);
}

sendBtn.addEventListener("click", sendMessage);
inputEl.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

/* Buttons */
clearBtn.addEventListener("click", () => {
  state.history = [];
  state.focus = "";
  state.domain = "";
  state.expectingLaneChoice = false;
  state.lastSimoKey = "";
  state.buildStage = 0;
  state.memory.lastIntent = "";
  state.memory.lastTopic = "";
  state.memory.lastPreviewSpec = null;

  chatEl.innerHTML = "";
  previewArea.innerHTML = `<div class="small">No preview yet. Ask for one.</div>`;
  previewBadge.textContent = "Ready";
  setContextCards();
  setBadges();

  addMessage("simo", "Clean slate. I’m still here. What’s up?", "clean_slate");
});

togglePlanBtn.addEventListener("click", () => {
  state.plan = (state.plan === "pro") ? "free" : "pro";
  setBadges();
});

closeModalBtn.addEventListener("click", closeModal);
modalBackdrop.addEventListener("click", (e) => {
  if (e.target === modalBackdrop) closeModal();
});
enableProBtn.addEventListener("click", () => {
  state.plan = "pro";
  setBadges();
  closeModal();
  addMessage("simo","Alright — Pro is on. Now tell me exactly what you want me to generate.","pro_on");
});

/* Boot */
setBadges();
setContextCards();
addMessage("simo",
  "Hey. I’m here.\nIf you want visuals, say: “show me…” and include what you want on it.",
  "boot"
);
</script>
</body>
</html>
