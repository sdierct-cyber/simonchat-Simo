<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simo</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg:#0b1020; --text:#eaf0ff; --muted:#a9b6d3;
      --line:rgba(255,255,255,.10);
      --btn:#2a66ff; --btn2:#1f4dd6;
      --good:#39ff7a;
      --bad:#ff4d4d;
      --shadow:0 14px 34px rgba(0,0,0,.35);
      --panel: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.14));
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:radial-gradient(1200px 700px at 20% 0%, #162a66 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .header{display:flex;align-items:flex-start;justify-content:space-between;gap:14px;margin-bottom:14px}
    .brand{display:flex;gap:10px;align-items:center}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--good);box-shadow:0 0 16px rgba(57,255,122,.55)}
    .brand h1{margin:0;font-size:20px;line-height:1.1}
    .sub{color:var(--muted);font-weight:800;font-size:12px;margin-top:2px}
    .toggles{display:flex;gap:10px;align-items:center}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      color:var(--text); font-weight:950; font-size:12px;
      cursor:pointer; user-select:none;
    }
    .pill .pDot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.35)}
    .pill.on{
      border-color:rgba(57,255,122,.35);
      background:rgba(57,255,122,.12);
      box-shadow:0 0 0 2px rgba(57,255,122,.08) inset, 0 10px 26px rgba(0,0,0,.28);
    }
    .pill.on .pDot{background:var(--good); box-shadow:0 0 14px rgba(57,255,122,.65)}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .panel{
      border:1px solid var(--line);
      border-radius:22px;
      background:var(--panel);
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height:620px;
    }
    .panelTop{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 16px;border-bottom:1px solid var(--line);
    }
    .panelTop .title{font-weight:1000}
    .panelTop .rightNote{color:var(--muted);font-weight:900;font-size:12px}

    .chatBody{padding:14px 16px;display:flex;flex-direction:column;height:calc(100% - 58px)}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      color:var(--text);
      border-radius:999px;
      padding:9px 12px;
      font-weight:950;font-size:12px;
      cursor:pointer;
    }
    .btn.locked{opacity:.55; cursor:not-allowed}
    .btn.danger{border-color:rgba(255,77,77,.35); background:rgba(255,77,77,.10)}
    .log{
      flex:1;
      border:1px dashed rgba(255,255,255,.12);
      border-radius:16px;
      padding:12px;
      overflow:auto;
      background:rgba(0,0,0,.10);
    }
    .msg{margin:0 0 10px;line-height:1.45}
    .msg .who{font-weight:1000}
    .msg .txt{font-weight:800}
    .composer{
      display:flex;gap:10px;margin-top:12px;
      border-top:1px solid var(--line);padding-top:12px;
    }
    textarea{
      flex:1; resize:none;
      height:56px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:12px;
      font-weight:850;
      outline:none;
    }
    .send{
      width:120px;
      border-radius:16px;
      border:2px solid rgba(255,255,255,.18);
      background:linear-gradient(180deg, var(--btn), var(--btn2));
      color:#fff;font-weight:1000;
      cursor:pointer;
    }
    .send:disabled{opacity:.65; cursor:not-allowed}

    .previewBody{padding:12px 12px 16px}
    .previewHeader{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 12px;border:1px solid var(--line);
      border-radius:16px 16px 0 0;
      background:rgba(0,0,0,.20);
      font-weight:950;
    }
    .frameWrap{
      border:1px solid var(--line);
      border-top:none;
      border-radius:0 0 16px 16px;
      overflow:hidden;
      background:rgba(255,255,255,.04);
      height:540px;
    }
    iframe{width:100%;height:100%;border:0;background:#0b1020}
    .muted{color:var(--muted);font-weight:850}
    .small{font-size:12px}
    .badgeLock{margin-left:6px;opacity:.85}

    /* Modal */
    .modalBackdrop{
      position:fixed; inset:0; display:none;
      background:rgba(0,0,0,.55);
      align-items:center; justify-content:center;
      padding:18px;
      z-index:9999;
    }
    .modalBackdrop.show{display:flex}
    .modal{
      width:min(820px, 96vw);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.35));
      box-shadow:0 24px 70px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalTop{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modalTop .t{font-weight:1000}
    .modalTop .x{
      width:38px;height:38px;border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text); font-weight:1000;
      cursor:pointer;
    }
    .modalBody{padding:14px 16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    .input{
      flex:1; min-width:220px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:10px 12px;
      font-weight:850;
      outline:none;
    }
    .list{
      display:grid; gap:10px;
      max-height:52vh; overflow:auto;
      padding-right:4px;
    }
    .item{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      border-radius:16px;
      padding:12px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .meta{display:flex; flex-direction:column; gap:4px}
    .name{font-weight:1000}
    .date{color:var(--muted); font-weight:850; font-size:12px}
    .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .tiny{
      border-radius:12px;
      padding:8px 10px;
      font-size:12px;
    }
    .ok{color:var(--good); font-weight:950}
    .err{color:var(--bad); font-weight:950}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <h1>Simo</h1>
          <div class="sub">Checkpoint V1 ‚Äî stable chat + preview + Pro gating</div>
        </div>
      </div>

      <div class="toggles">
        <div id="freePill" class="pill on" role="button" aria-label="Free">
          <span class="pDot"></span> Free <span class="muted">$0</span>
        </div>
        <div id="proPill" class="pill" role="button" aria-label="Pro">
          <span class="pDot"></span> Pro <span class="muted">$19</span>
        </div>
      </div>
    </div>

    <div class="grid">
      <section class="panel">
        <div class="panelTop">
          <div class="title">Chat</div>
          <div class="rightNote" id="statusDot">Ready</div>
        </div>

        <div class="chatBody">
          <div class="controls">
            <button id="resetBtn" class="btn">Reset</button>
            <button id="saveBtn" class="btn locked">Save <span class="badgeLock">üîí</span></button>
            <button id="downloadBtn" class="btn locked">Download <span class="badgeLock">üîí</span></button>
            <button id="libraryBtn" class="btn locked">Library <span class="badgeLock">üîí</span></button>
          </div>

          <div id="log" class="log" aria-live="polite">
            <p class="msg simo"><span class="who">Simo:</span> <span class="txt">Reset. I‚Äôm here.</span></p>
          </div>

          <div class="composer">
            <textarea id="input" placeholder="Enter to send ‚Ä¢ Shift+Enter for new line"></textarea>
            <button id="sendBtn" class="send">Send</button>
          </div>
        </div>
      </section>

      <section class="panel">
        <div class="panelTop">
          <div class="title">Preview</div>
          <div class="rightNote">HTML / cover / updates render here</div>
        </div>

        <div class="previewBody">
          <div class="previewHeader">
            <div id="previewTitle">Idle</div>
            <div class="muted small" id="previewMeta">No preview yet</div>
          </div>
          <div class="frameWrap">
            <iframe id="previewFrame" title="Preview frame"></iframe>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Library Modal -->
  <div id="libModal" class="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Library">
      <div class="modalTop">
        <div class="t">Library</div>
        <button id="closeLibModal" class="x" aria-label="Close">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="row">
          <input id="saveName" class="input" placeholder="Name this build (e.g., Fitness Coach V1)" />
          <button id="saveNow" class="btn">Save current</button>
          <button id="clearAll" class="btn danger">Clear all</button>
        </div>
        <div class="muted small" style="margin-bottom:10px">
          Saved builds are stored in this browser (localStorage).
        </div>
        <div id="libList" class="list"></div>
      </div>
    </div>
  </div>

  <!-- Pro Key Modal -->
  <div id="proModal" class="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Unlock Pro">
      <div class="modalTop">
        <div class="t">Unlock Pro</div>
        <button id="closeProModal" class="x" aria-label="Close">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="muted small" style="margin-bottom:10px">
          Enter your Pro license key. Pro unlocks only after server verification.
        </div>
        <div class="row">
          <input id="proKey" class="input" placeholder="e.g. SIMO-TEST-123" />
          <button id="verifyProBtn" class="btn">Verify</button>
          <button id="logoutProBtn" class="btn danger">Log out Pro</button>
        </div>
        <div id="proStatus" class="muted small"></div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const STORAGE_KEY = "simo.library.v1";
    const PRO_FLAG_KEY = "simo.pro.verified.v1"; // boolean "1" or ""
    const PRO_KEY_CACHE = "simo.pro.keyhint.v1"; // optional key hint (not required)

    const state = {
      tier: "free",
      conversation: [],
      lastPreview: null,
      lastSavedHtml: null,
      isBusy: false,
      proVerified: false
    };

    function nowStamp() { return new Date().toISOString(); }
    function niceDate(iso) { try { return new Date(iso).toLocaleString(); } catch { return iso; } }

    function loadLibrary() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch { return []; }
    }
    function saveLibrary(arr) { localStorage.setItem(STORAGE_KEY, JSON.stringify(arr || [])); }

    function idlePreviewDoc() {
      return `<!doctype html><html><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
  html,body{height:100%;margin:0}
  body{display:grid;place-items:center;font-family:system-ui;background:#0b1020;color:#a9b6d3}
  .box{border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:18px 16px;background:rgba(255,255,255,.04);text-align:center;max-width:360px}
  b{color:#eaf0ff}
</style></head>
<body><div class="box"><b>No preview yet</b><div style="height:6px"></div>
Ask: ‚Äúbuild a landing page for a fitness coach‚Äù</div></body></html>`;
    }

    function setBusy(on) {
      state.isBusy = !!on;
      $("sendBtn").disabled = state.isBusy;
      $("statusDot").textContent = state.isBusy ? "Thinking‚Ä¶" : "Ready";
    }

    function setTier(tier) {
      state.tier = tier === "pro" ? "pro" : "free";
      $("freePill").classList.toggle("on", state.tier === "free");
      $("proPill").classList.toggle("on", state.tier === "pro");

      const proOn = (state.tier === "pro") && state.proVerified;
      ["saveBtn","downloadBtn","libraryBtn"].forEach((id) => {
        const b = $(id);
        b.classList.toggle("locked", !proOn);
        b.innerHTML = proOn
          ? b.textContent.replace("üîí","").trim()
          : (b.textContent.replace("üîí","").trim() + ' <span class="badgeLock">üîí</span>');
      });

      // Visual: if user clicked Pro but not verified, show modal instead
      if (state.tier === "pro" && !state.proVerified) {
        // keep UI in Free mode until verified
        state.tier = "free";
        $("freePill").classList.add("on");
        $("proPill").classList.remove("on");
      }
    }

    function addMsg(role, text) {
      const p = document.createElement("p");
      p.className = "msg " + (role === "user" ? "user" : "simo");
      p.innerHTML = '<span class="who">'+(role==="user"?"You:":"Simo:")+
        '</span> <span class="txt"></span>';
      p.querySelector(".txt").textContent = text || "";
      $("log").appendChild(p);
      $("log").scrollTop = $("log").scrollHeight;

      state.conversation.push({ role, content: String(text || "") });
      if (state.conversation.length > 30) state.conversation = state.conversation.slice(-30);
    }

    function setPreview(preview) {
      if (!preview || !preview.html) return;
      state.lastPreview = preview;
      $("previewTitle").textContent = preview.title || "Preview";
      $("previewMeta").textContent = preview.meta || "Updated";
      $("previewFrame").srcdoc = preview.html;
      state.lastSavedHtml = preview.html;
    }

    // -------- Local deterministic landing preview ----------
    function looksLikePreviewAsk(text) {
      const x = (text||"").toLowerCase().trim();
      return (
        x.includes("landing page") ||
        x.includes("marketing page") ||
        x.includes("show me a preview") ||
        x.startsWith("preview") ||
        x.startsWith("build a landing page") ||
        x.startsWith("build me a landing page") ||
        x.includes("make a landing page") ||
        x.includes("create a landing page")
      );
    }
    function extractTopic(text) {
      const t = (text||"").toLowerCase();
      const m =
        t.match(/landing page for (a|an)\s+(.+?)(\.|$)/i) ||
        t.match(/page for (a|an)\s+(.+?)(\.|$)/i) ||
        t.match(/for (a|an)\s+(.+?)(\.|$)/i);
      if (m && m[2]) return (m[2]||"").trim().replace(/\.$/,"");
      if ((text||"").trim().length <= 40) return (text||"").trim();
      return "your offer";
    }
    function sanitize(s){
      return String(s||"")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;");
    }
    function localLandingHTML(topic){
      const T = sanitize(topic);
      const H = sanitize(`${topic} ‚Äî made simple`);
      return `<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="color-scheme" content="dark"/>
<title>Simo ‚Äî Landing Page</title>
<style>
:root{--bg:#0b1020;--text:#eaf0ff;--muted:#a9b6d3;--line:rgba(255,255,255,.12);--pro:#39ff7a;--shadow:0 12px 28px rgba(0,0,0,.35)}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;font-family:system-ui;background:radial-gradient(1200px 700px at 20% 0%, #162a66 0%, var(--bg) 55%);color:var(--text)}
.wrap{max-width:980px;margin:0 auto;padding:22px}
.top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:6px 0 18px}
.brand{display:flex;align-items:center;gap:10px;font-weight:900}
.dot{width:10px;height:10px;border-radius:99px;background:var(--pro);box-shadow:0 0 18px rgba(57,255,122,.6)}
.tag{font-size:12px;color:var(--muted);font-weight:800}
.hero{border:1px solid var(--line);border-radius:22px;background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));box-shadow:var(--shadow);padding:22px}
h1{margin:8px 0 10px;font-size:54px;line-height:1.02;letter-spacing:-.02em}
p{color:var(--muted);font-weight:700;line-height:1.5;font-size:16px}
.ctaRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
.btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 14px;border-radius:14px;font-weight:950;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);text-decoration:none}
.btn.primary{border-color:rgba(57,255,122,.25);background:rgba(57,255,122,.14);box-shadow:0 10px 20px rgba(0,0,0,.25)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
@media (max-width:860px){h1{font-size:44px}.grid{grid-template-columns:1fr}}
.card{border:1px solid var(--line);border-radius:18px;background:rgba(0,0,0,.18);padding:16px}
.card h3{margin:0 0 6px;font-size:18px}.card p{margin:0}
[data-hidden="true"]{display:none !important;}
.sectionTitle{font-size:18px;font-weight:950;margin:22px 0 10px}
.list{display:grid;gap:10px}
.pill{border:1px solid var(--line); border-radius:14px;padding:12px;background:rgba(255,255,255,.04);font-weight:800;color:var(--text);}
.priceBox{display:flex;align-items:flex-end;justify-content:space-between;gap:10px;padding:16px;border-radius:18px;border:1px solid rgba(57,255,122,.25);background:rgba(57,255,122,.10);}
.price{font-size:34px;font-weight:1000;letter-spacing:-.02em;}
.small{font-size:12px;color:var(--muted);font-weight:850}
</style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand"><span class="dot"></span> <span data-field="brand">Simo</span></div>
      <div class="tag">Local preview ‚Ä¢ topic: <span data-field="topic">${T}</span></div>
    </div>

    <div class="hero">
      <div class="tag">Simo Preview</div>
      <h1 data-field="headline">${H}</h1>
      <p data-field="subhead">A clean landing page you can export as HTML. Ask me to change sections, CTA, or copy.</p>

      <div class="ctaRow">
        <a class="btn primary" href="#" data-cta="primary">Get Started</a>
        <a class="btn" href="#" data-cta="secondary">Learn More</a>
      </div>

      <div class="grid" style="margin-top:18px">
        <div class="card"><h3>Fast</h3><p>Clean structure that converts.</p></div>
        <div class="card"><h3>Clear</h3><p>Headline ‚Üí value ‚Üí call-to-action.</p></div>
      </div>
    </div>

    <!--section:benefits:start--><div data-section="benefits" data-hidden="false">
      <div class="sectionTitle">Benefits</div>
      <div class="list">
        <div class="pill">Get a simple plan for <strong>${T}</strong> that people understand fast.</div>
        <div class="pill">Show what you do, who it‚Äôs for, and how to start.</div>
        <div class="pill">Turn visitors into leads with a clear CTA.</div>
      </div>
    </div><!--section:benefits:end-->

    <!--section:testimonials:start--><div data-section="testimonials" data-hidden="false">
      <div class="sectionTitle">Testimonials</div>
      <div class="list">
        <div class="pill">‚ÄúThis was exactly what I needed ‚Äî clean and professional.‚Äù</div>
        <div class="pill">‚ÄúThe layout made it easy to explain my offer.‚Äù</div>
      </div>
    </div><!--section:testimonials:end-->

    <!--section:pricing:start--><div data-section="pricing" data-hidden="false">
      <div class="sectionTitle">Pricing</div>
      <div class="priceBox">
        <div>
          <div class="small">Starter package</div>
          <div class="price" data-field="price">$19</div>
        </div>
        <a class="btn primary" href="#" data-cta="pricing">Get Started</a>
      </div>
    </div><!--section:pricing:end-->

    <!--section:faq:start--><div data-section="faq" data-hidden="false">
      <div class="sectionTitle">FAQ</div>
      <div class="list">
        <div class="pill"><strong>How do I start?</strong><br><span class="small">Click Get Started and send your details.</span></div>
        <div class="pill"><strong>Can I customize this?</strong><br><span class="small">Yes ‚Äî tell me ‚Äúheadline:‚Äù ‚Äúcta:‚Äù or ‚Äúadd/remove sections‚Äù.</span></div>
      </div>
    </div><!--section:faq:end-->

    <div style="height:28px"></div>
  </div>
</body>
</html>`;
    }

    // -------- Local edit commands (works even if server times out) --------
    function norm(s){ return String(s||"").trim(); }
    function lower(s){ return norm(s).toLowerCase(); }

    function isEditCommand(t) {
      const x = lower(t);
      return (
        x.startsWith("headline:") ||
        x.startsWith("title:") ||
        x.startsWith("cta:") ||
        x.startsWith("price:") ||
        x === "add faq" || x === "remove faq" ||
        x === "add pricing" || x === "remove pricing" ||
        x === "add testimonials" || x === "remove testimonials" ||
        x === "add benefits" || x === "remove benefits"
      );
    }

    function moneyFromText(text, fallback="$19"){
      const m = norm(text).match(/^price:\s*(.+)$/i);
      if (!m) return fallback;
      let v = norm(m[1]);
      if (!v) return fallback;
      if (/^\d+(\.\d+)?$/.test(v)) v = `$${v}`;
      return v;
    }

    function toggleSection(html, id, wantOn) {
      if (typeof html !== "string") return html;
      const start = `<!--section:${id}:start-->`;
      const end = `<!--section:${id}:end-->`;
      const si = html.indexOf(start);
      const ei = html.indexOf(end);
      if (si === -1 || ei === -1 || ei <= si) return html;
      const block = html.slice(si, ei + end.length);
      const isHidden = block.includes(`data-hidden="true"`);
      if (wantOn && isHidden) return html.replace(block, block.replace(`data-hidden="true"`, `data-hidden="false"`));
      if (!wantOn && !isHidden) return html.replace(block, block.replace(`data-hidden="false"`, `data-hidden="true"`));
      return html;
    }

    function setTextInHtml(html, field, newText){
      const safe = sanitize(newText);
      const re = new RegExp(`(data-field="${field}"[^>]*>)([\\s\\S]*?)(</)`, "i");
      return html.replace(re, `$1${safe}$3`);
    }

    function setCtaInHtml(html, which, newText){
      const safe = sanitize(newText);
      const re = new RegExp(`(data-cta="${which}"[^>]*>)([\\s\\S]*?)(</)`, "i");
      return html.replace(re, `$1${safe}$3`);
    }

    function setPriceInHtml(html, newPrice){
      const safe = sanitize(newPrice);
      const re = new RegExp(`(data-field="price"[^>]*>)([\\s\\S]*?)(</)`, "i");
      return html.replace(re, `$1${safe}$3`);
    }

    function applyLocalEdits(text, html){
      let out = String(html||"");
      const t = norm(text);
      const x = lower(t);

      if (x.startsWith("headline:")) {
        const v = norm(t.split(":").slice(1).join(":"));
        if (v) out = setTextInHtml(out, "headline", v);
        return { html: out, note: "Updated headline." };
      }
      if (x.startsWith("title:")) {
        const v = norm(t.split(":").slice(1).join(":"));
        if (v) out = setTextInHtml(out, "headline", v);
        return { html: out, note: "Updated title/headline." };
      }
      if (x.startsWith("cta:")) {
        const v = norm(t.split(":").slice(1).join(":"));
        if (v) out = setCtaInHtml(out, "primary", v);
        return { html: out, note: "Updated CTA." };
      }
      if (x.startsWith("price:")) {
        const v = moneyFromText(t, "$19");
        out = setPriceInHtml(out, v);
        return { html: out, note: "Updated price." };
      }

      if (x === "add faq") return { html: toggleSection(out, "faq", true), note: "Added FAQ." };
      if (x === "remove faq") return { html: toggleSection(out, "faq", false), note: "Removed FAQ." };

      if (x === "add pricing") return { html: toggleSection(out, "pricing", true), note: "Added pricing." };
      if (x === "remove pricing") return { html: toggleSection(out, "pricing", false), note: "Removed pricing." };

      if (x === "add testimonials") return { html: toggleSection(out, "testimonials", true), note: "Added testimonials." };
      if (x === "remove testimonials") return { html: toggleSection(out, "testimonials", false), note: "Removed testimonials." };

      if (x === "add benefits") return { html: toggleSection(out, "benefits", true), note: "Added benefits." };
      if (x === "remove benefits") return { html: toggleSection(out, "benefits", false), note: "Removed benefits." };

      return { html: out, note: "No edit applied." };
    }

    // -------- Local best-friend fallback (NO dead-ends) --------
    function localBestFriendFallback(userText) {
      const x = (userText||"").toLowerCase();
      if (x.includes("im stressed") || x.includes("i'm stressed") || x.includes("stressed out")) {
        return "I got you. What‚Äôs the main source ‚Äî work, money, relationship, or just everything stacking?";
      }
      if (x.includes("anxious") || x.includes("panic")) {
        return "Okay. In 4‚Ä¶ hold 2‚Ä¶ out 6 (twice). Now: what triggered it in the last 10 minutes?";
      }
      if (x.includes("sad") || x.includes("depressed")) {
        return "I‚Äôm here. What happened today that hit you the hardest? One sentence.";
      }
      if (x.includes("angry") || x.includes("pissed") || x.includes("mad")) {
        return "Alright. What crossed the line? Tell me the one thing that set you off.";
      }
      return "I‚Äôm here. Tell me what you want right now ‚Äî venting, solving, or building.";
    }

    async function callBackend(text, timeoutMs) {
      const payload = {
        text,
        tier: (state.proVerified ? "pro" : "free"),
        conversation: state.conversation,
        lastPreview: state.lastPreview
      };

      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), timeoutMs);

      try {
        const res = await fetch("/.netlify/functions/simon", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(payload),
          signal: controller.signal,
        });
        const data = await res.json().catch(() => ({}));
        return data;
      } finally {
        clearTimeout(timeout);
      }
    }

    // ---------------- Pro features ----------------
    function requirePro(actionName) {
      if (!state.proVerified) {
        addMsg("assistant", `${actionName} is a Pro feature üîí. Click Pro and verify your license key.`);
        openProModal();
        return false;
      }
      return true;
    }

    function downloadHtml(filename, html) {
      const blob = new Blob([html], { type: "text/html;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function openLibModal() {
      $("libModal").classList.add("show");
      $("libModal").setAttribute("aria-hidden", "false");
      renderLibrary();
      setTimeout(() => $("saveName").focus(), 50);
    }
    function closeLibModal() {
      $("libModal").classList.remove("show");
      $("libModal").setAttribute("aria-hidden", "true");
    }

    function openProModal() {
      $("proModal").classList.add("show");
      $("proModal").setAttribute("aria-hidden", "false");
      const hint = localStorage.getItem(PRO_KEY_CACHE) || "";
      $("proKey").value = hint;
      updateProStatus();
      setTimeout(() => $("proKey").focus(), 50);
    }
    function closeProModal() {
      $("proModal").classList.remove("show");
      $("proModal").setAttribute("aria-hidden", "true");
    }

    function updateProStatus(msg, ok) {
      const el = $("proStatus");
      if (typeof msg === "string") {
        el.textContent = msg;
        el.className = (ok === true) ? "ok" : (ok === false) ? "err" : "muted small";
        return;
      }
      if (state.proVerified) {
        el.textContent = "Pro is verified ‚úÖ";
        el.className = "ok";
      } else {
        el.textContent = "Pro is locked until verified.";
        el.className = "muted small";
      }
    }

    function setProVerified(on) {
      state.proVerified = !!on;
      if (state.proVerified) localStorage.setItem(PRO_FLAG_KEY, "1");
      else localStorage.removeItem(PRO_FLAG_KEY);

      // reflect UI
      $("freePill").classList.toggle("on", !state.proVerified);
      $("proPill").classList.toggle("on", state.proVerified);

      const proOn = state.proVerified;
      ["saveBtn","downloadBtn","libraryBtn"].forEach((id) => {
        const b = $(id);
        b.classList.toggle("locked", !proOn);
        b.innerHTML = proOn
          ? b.textContent.replace("üîí","").trim()
          : (b.textContent.replace("üîí","").trim() + ' <span class="badgeLock">üîí</span>');
      });
      updateProStatus();
    }

    async function verifyProKey(key) {
      const k = String(key || "").trim();
      if (!k) {
        updateProStatus("Enter a key first.", false);
        return false;
      }

      updateProStatus("Verifying‚Ä¶", null);

      try {
        const r = await fetch("/.netlify/functions/pro", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ key: k })
        });
        const j = await r.json().catch(() => ({}));
        if (j && j.ok && j.pro === true) {
          localStorage.setItem(PRO_KEY_CACHE, k);
          setProVerified(true);
          updateProStatus("Verified ‚úÖ Pro unlocked.", true);
          closeProModal();
          addMsg("assistant", "Pro verified ‚úÖ Save / Download / Library unlocked.");
          return true;
        }
        setProVerified(false);
        updateProStatus("Invalid key. Double-check it matches PRO_LICENSE_KEYS.", false);
        return false;
      } catch (e) {
        setProVerified(false);
        updateProStatus("Server error verifying Pro. Try again.", false);
        return false;
      }
    }

    function currentHtmlOrNull() {
      const html = state.lastSavedHtml || state.lastPreview?.html || "";
      return html && html.trim().length > 50 ? html : "";
    }

    function renderLibrary() {
      const list = $("libList");
      list.innerHTML = "";
      const items = loadLibrary().sort((a,b) => (b.updatedAt||"").localeCompare(a.updatedAt||""));

      if (!items.length) {
        const empty = document.createElement("div");
        empty.className = "muted small";
        empty.textContent = "No saved builds yet. Generate a preview, then click Save.";
        list.appendChild(empty);
        return;
      }

      for (const it of items) {
        const row = document.createElement("div");
        row.className = "item";

        const left = document.createElement("div");
        left.className = "meta";
        const name = document.createElement("div");
        name.className = "name";
        name.textContent = it.name || "Untitled";
        const date = document.createElement("div");
        date.className = "date";
        date.textContent = `Updated: ${niceDate(it.updatedAt || it.createdAt || "")}`;
        left.appendChild(name);
        left.appendChild(date);

        const right = document.createElement("div");
        right.className = "actions";

        const loadBtn = document.createElement("button");
        loadBtn.className = "btn tiny";
        loadBtn.textContent = "Load";
        loadBtn.addEventListener("click", () => {
          if (!it.html) return;
          setPreview({ kind:"html", title: it.name || "Saved build", meta:"Loaded from Library", html: it.html });
          addMsg("assistant", `Loaded ‚Äú${it.name || "Untitled"}‚Äù into preview.`);
          closeLibModal();
        });

        const dlBtn = document.createElement("button");
        dlBtn.className = "btn tiny";
        dlBtn.textContent = "Download";
        dlBtn.addEventListener("click", () => {
          if (!it.html) return;
          const safe = (it.name || "simo-build").replace(/[^a-z0-9-_]+/gi, "-").replace(/-+/g,"-").toLowerCase();
          downloadHtml(`${safe}.html`, it.html);
          addMsg("assistant", `Downloaded ‚Äú${it.name || "Untitled"}‚Äù.`);
        });

        const delBtn = document.createElement("button");
        delBtn.className = "btn tiny danger";
        delBtn.textContent = "Delete";
        delBtn.addEventListener("click", () => {
          const arr = loadLibrary().filter(x => x.id !== it.id);
          saveLibrary(arr);
          renderLibrary();
          addMsg("assistant", `Deleted ‚Äú${it.name || "Untitled"}‚Äù.`);
        });

        right.appendChild(loadBtn);
        right.appendChild(dlBtn);
        right.appendChild(delBtn);

        row.appendChild(left);
        row.appendChild(right);
        list.appendChild(row);
      }
    }

    function saveCurrentToLibrary(customName) {
      const html = currentHtmlOrNull();
      if (!html) {
        addMsg("assistant", "Nothing to save yet. Generate a preview first (e.g., ‚Äúbuild a landing page for a fitness coach‚Äù).");
        return;
      }

      const name = (customName || "").trim() || (state.lastPreview?.title ? `${state.lastPreview.title} ${new Date().toLocaleTimeString()}` : "Untitled");
      const arr = loadLibrary();

      const existing = arr.find(x => (x.name || "").toLowerCase() === name.toLowerCase());
      if (existing) {
        existing.html = html;
        existing.updatedAt = nowStamp();
        saveLibrary(arr);
        addMsg("assistant", `Updated saved build: ‚Äú${name}‚Äù.`);
        return;
      }

      const item = {
        id: "b_" + Math.random().toString(16).slice(2) + "_" + Date.now(),
        name,
        html,
        createdAt: nowStamp(),
        updatedAt: nowStamp()
      };
      arr.push(item);
      saveLibrary(arr);
      addMsg("assistant", `Saved: ‚Äú${name}‚Äù.`);
    }

    async function send() {
      const text = $("input").value.trim();
      if (!text || state.isBusy) return;

      addMsg("user", text);
      $("input").value = "";

      // 1) Instant preview (local)
      if (looksLikePreviewAsk(text)) {
        const topic = extractTopic(text);
        setPreview({ kind:"html", title:"Landing page", meta:"Instant (local)", html: localLandingHTML(topic) });
        addMsg("assistant", "Done. I updated the preview on the right.");
      }

      // 2) Local edits apply immediately
      if (isEditCommand(text)) {
        const html = currentHtmlOrNull();
        if (html) {
          const edited = applyLocalEdits(text, html);
          setPreview({ kind:"html", title: $("previewTitle").textContent || "Landing page", meta:"Edited (local)", html: edited.html });
          addMsg("assistant", `Done. ${edited.note}`);
        } else {
          addMsg("assistant", "No preview yet to edit. First: ‚Äúbuild a landing page for a fitness coach‚Äù.");
        }
      }

      setBusy(true);

      try {
        const timeoutMs = 25000;
        const data = await callBackend(text, timeoutMs);

        if (data && typeof data.text === "string" && data.text.trim()) {
          addMsg("assistant", data.text.trim());
        } else if (!looksLikePreviewAsk(text) && !isEditCommand(text)) {
          addMsg("assistant", localBestFriendFallback(text));
        }

        if (data && data.preview && data.preview.kind === "html") {
          setPreview(data.preview);
        }
      } catch (err) {
        if (!looksLikePreviewAsk(text) && !isEditCommand(text)) {
          addMsg("assistant", localBestFriendFallback(text));
        }
      } finally {
        setBusy(false);
      }
    }

    function reset() {
      state.conversation = [];
      state.lastPreview = null;
      state.lastSavedHtml = null;
      $("log").innerHTML = "";
      addMsg("assistant", "Reset. I‚Äôm here.");
      $("previewTitle").textContent = "Idle";
      $("previewMeta").textContent = "No preview yet";
      $("previewFrame").srcdoc = idlePreviewDoc();
    }

    // ----- Button wiring -----
    $("sendBtn").addEventListener("click", send);
    $("resetBtn").addEventListener("click", reset);

    $("input").addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

    // Pro/Free pills:
    $("freePill").addEventListener("click", () => {
      setProVerified(false);
      addMsg("assistant", "Switched to Free.");
    });

    $("proPill").addEventListener("click", () => {
      openProModal();
    });

    // Pro modal buttons
    $("closeProModal").addEventListener("click", closeProModal);
    $("verifyProBtn").addEventListener("click", () => verifyProKey($("proKey").value));
    $("logoutProBtn").addEventListener("click", () => {
      setProVerified(false);
      addMsg("assistant", "Pro logged out. Back to Free.");
      updateProStatus("Pro logged out.", false);
    });

    $("proModal").addEventListener("click", (e) => {
      if (e.target === $("proModal")) closeProModal();
    });

    // Pro: Save / Download / Library
    $("saveBtn").addEventListener("click", () => {
      if (!requirePro("Save")) return;
      const auto = $("previewTitle").textContent || "Build";
      saveCurrentToLibrary(auto + " " + new Date().toLocaleString());
    });

    $("downloadBtn").addEventListener("click", () => {
      if (!requirePro("Download")) return;
      const html = currentHtmlOrNull();
      if (!html) {
        addMsg("assistant", "Nothing to download yet. Generate a preview first.");
        return;
      }
      const base = ($("previewTitle").textContent || "simo-build")
        .replace(/[^a-z0-9-_]+/gi, "-")
        .replace(/-+/g,"-")
        .toLowerCase();
      downloadHtml(`${base}.html`, html);
      addMsg("assistant", "Downloaded the current build.");
    });

    $("libraryBtn").addEventListener("click", () => {
      if (!requirePro("Library")) return;
      openLibModal();
    });

    // Library modal close wiring
    $("closeLibModal").addEventListener("click", closeLibModal);
    $("libModal").addEventListener("click", (e) => {
      if (e.target === $("libModal")) closeLibModal();
    });

    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        if ($("libModal").classList.contains("show")) closeLibModal();
        if ($("proModal").classList.contains("show")) closeProModal();
      }
    });

    $("saveNow").addEventListener("click", () => {
      if (!requirePro("Save")) return;
      saveCurrentToLibrary($("saveName").value);
      $("saveName").value = "";
      renderLibrary();
    });

    $("clearAll").addEventListener("click", () => {
      if (!requirePro("Library")) return;
      saveLibrary([]);
      renderLibrary();
      addMsg("assistant", "Cleared all saved builds.");
    });

    // init
    $("previewFrame").srcdoc = idlePreviewDoc();

    // restore pro verified flag (optional)
    state.proVerified = localStorage.getItem(PRO_FLAG_KEY) === "1";
    setProVerified(state.proVerified);
  </script>
</body>
</html>
