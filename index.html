<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simo</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg:#0b1020; --panel:#0f1730; --panel2:#0c1328;
      --text:#eaf0ff; --muted:#a9b6d3; --line:rgba(255,255,255,.10);
      --btn:#2a66ff; --btn2:#1f4dd6;
      --good:#39ff7a; --bad:#ff4d4d;
      --shadow:0 14px 34px rgba(0,0,0,.35);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:radial-gradient(1200px 700px at 20% 0%, #162a66 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .header{display:flex;align-items:flex-start;justify-content:space-between;gap:14px;margin-bottom:14px}
    .brand{display:flex;gap:10px;align-items:center}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--good);box-shadow:0 0 16px rgba(57,255,122,.55)}
    .brand h1{margin:0;font-size:20px;line-height:1.1}
    .sub{color:var(--muted);font-weight:800;font-size:12px;margin-top:2px}
    .toggles{display:flex;gap:10px;align-items:center}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      color:var(--text); font-weight:950; font-size:12px;
      cursor:pointer; user-select:none;
    }
    .pill .pDot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.35)}
    .pill.on{
      border-color:rgba(57,255,122,.35);
      background:rgba(57,255,122,.12);
      box-shadow:0 0 0 2px rgba(57,255,122,.08) inset, 0 10px 26px rgba(0,0,0,.28);
    }
    .pill.on .pDot{background:var(--good); box-shadow:0 0 14px rgba(57,255,122,.65)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .panel{
      border:1px solid var(--line);
      border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.14));
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height:620px;
    }
    .panelTop{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 16px;border-bottom:1px solid var(--line);
    }
    .panelTop .title{font-weight:1000}
    .panelTop .rightNote{color:var(--muted);font-weight:900;font-size:12px}
    .chatBody{padding:14px 16px;display:flex;flex-direction:column;height:calc(100% - 58px)}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      color:var(--text);
      border-radius:999px;
      padding:9px 12px;
      font-weight:950;font-size:12px;
      cursor:pointer;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:linear-gradient(180deg, var(--btn), var(--btn2));
      border-color:rgba(255,255,255,.16);
    }
    .btn.locked{opacity:.55; cursor:not-allowed}
    .log{
      flex:1;
      border:1px dashed rgba(255,255,255,.12);
      border-radius:16px;
      padding:12px;
      overflow:auto;
      background:rgba(0,0,0,.10);
    }
    .msg{margin:0 0 10px;line-height:1.45}
    .msg .who{font-weight:1000}
    .msg .txt{color:var(--text);font-weight:800}
    .msg.user .txt{color:#fff}
    .msg.simo .txt{color:var(--text)}
    .composer{
      display:flex;gap:10px;margin-top:12px;
      border-top:1px solid var(--line);padding-top:12px;
    }
    textarea{
      flex:1; resize:none;
      height:56px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:12px;
      font-weight:850;
      outline:none;
    }
    .send{
      width:120px;
      border-radius:16px;
      border:2px solid rgba(255,255,255,.18);
      background:linear-gradient(180deg, var(--btn), var(--btn2));
      color:#fff;font-weight:1000;
      cursor:pointer;
    }
    .send:disabled{opacity:.65; cursor:not-allowed}
    .previewBody{padding:12px 12px 16px}
    .previewHeader{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 12px;border:1px solid var(--line);
      border-radius:16px 16px 0 0;
      background:rgba(0,0,0,.20);
      font-weight:950;
    }
    .frameWrap{
      border:1px solid var(--line);
      border-top:none;
      border-radius:0 0 16px 16px;
      overflow:hidden;
      background:rgba(255,255,255,.04);
      height:540px;
    }
    iframe{width:100%;height:100%;border:0;background:#fff}
    .muted{color:var(--muted);font-weight:850}
    .small{font-size:12px}
    .badgeLock{margin-left:6px;opacity:.85}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <h1>Simo</h1>
          <div class="sub">Checkpoint V1 â€” stable chat + preview + Pro gating</div>
        </div>
      </div>

      <div class="toggles">
        <div id="freePill" class="pill on" role="button" aria-label="Free">
          <span class="pDot"></span> Free <span class="muted">$0</span>
        </div>
        <div id="proPill" class="pill" role="button" aria-label="Pro">
          <span class="pDot"></span> Pro <span class="muted">$19</span>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- CHAT -->
      <section class="panel" aria-label="Chat panel">
        <div class="panelTop">
          <div class="title">Chat</div>
          <div class="rightNote" id="statusDot">Ready</div>
        </div>

        <div class="chatBody">
          <div class="controls">
            <button id="resetBtn" class="btn">Reset</button>
            <button id="saveBtn" class="btn locked">Save <span class="badgeLock">ðŸ”’</span></button>
            <button id="downloadBtn" class="btn locked">Download <span class="badgeLock">ðŸ”’</span></button>
            <button id="libraryBtn" class="btn locked">Library <span class="badgeLock">ðŸ”’</span></button>
          </div>

          <div id="log" class="log" aria-live="polite">
            <p class="msg simo">
              <span class="who">Simo:</span>
              <span class="txt">Reset. Iâ€™m here.</span>
            </p>
          </div>

          <div class="composer">
            <textarea id="input" placeholder="Enter to send â€¢ Shift+Enter for new line"></textarea>
            <button id="sendBtn" class="send">Send</button>
          </div>
        </div>
      </section>

      <!-- PREVIEW -->
      <section class="panel" aria-label="Preview panel">
        <div class="panelTop">
          <div class="title">Preview</div>
          <div class="rightNote">HTML / cover / updates render here</div>
        </div>

        <div class="previewBody">
          <div class="previewHeader">
            <div id="previewTitle">Idle</div>
            <div class="muted small" id="previewMeta">No preview yet</div>
          </div>
          <div class="frameWrap">
            <iframe id="previewFrame" title="Preview frame"></iframe>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // Single-file UI controller (no external chat.js = no â€œscript not loadingâ€ failures)

    const $ = (id) => document.getElementById(id);

    const state = {
      tier: "free",
      conversation: [],
      lastPreview: null,
      lastSavedHtml: null,
      isBusy: false,
    };

    function setBusy(on) {
      state.isBusy = !!on;
      $("sendBtn").disabled = state.isBusy;
      $("statusDot").textContent = state.isBusy ? "Thinkingâ€¦" : "Ready";
    }

    function setTier(tier) {
      state.tier = tier === "pro" ? "pro" : "free";
      $("freePill").classList.toggle("on", state.tier === "free");
      $("proPill").classList.toggle("on", state.tier === "pro");

      // Pro gating (visual only; actual Pro features can be enforced later)
      const proOn = state.tier === "pro";
      const lockButtons = ["saveBtn","downloadBtn","libraryBtn"];
      lockButtons.forEach((id) => {
        const b = $(id);
        b.classList.toggle("locked", !proOn);
        b.innerHTML = proOn
          ? b.textContent.replace("ðŸ”’","").trim()
          : (b.textContent.replace("ðŸ”’","").trim() + ' <span class="badgeLock">ðŸ”’</span>');
      });
    }

    function addMsg(role, text) {
      const p = document.createElement("p");
      p.className = "msg " + (role === "user" ? "user" : "simo");
      p.innerHTML =
        '<span class="who">' + (role === "user" ? "You:" : "Simo:") + '</span> ' +
        '<span class="txt"></span>';
      p.querySelector(".txt").textContent = text || "";
      $("log").appendChild(p);
      $("log").scrollTop = $("log").scrollHeight;

      state.conversation.push({ role, content: String(text || "") });
      // keep it trimmed so payload stays small
      if (state.conversation.length > 30) state.conversation = state.conversation.slice(-30);
    }

    function setPreview(preview) {
      if (!preview || !preview.html) return;
      state.lastPreview = preview;
      $("previewTitle").textContent = preview.title || "Preview";
      $("previewMeta").textContent = preview.meta || "Updated";
      // Always use srcdoc (no extra network, avoids white â€œloadingâ€ flashes)
      $("previewFrame").srcdoc = preview.html;
      state.lastSavedHtml = preview.html;
    }

    async function callBackend(text) {
      const payload = {
        text,
        tier: state.tier,
        conversation: state.conversation,
        lastPreview: state.lastPreview
      };

      const res = await fetch("/.netlify/functions/simon", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(payload),
      });

      // If the function is down, this will throw in res.json()
      const data = await res.json();
      return data;
    }

    async function send() {
      const text = $("input").value.trim();
      if (!text || state.isBusy) return;

      addMsg("user", text);
      $("input").value = "";
      setBusy(true);

      try {
        const data = await callBackend(text);

        // UI-safe: even if backend returns weird stuff, we never â€œcrashâ€
        const reply = (data && typeof data.text === "string" && data.text.trim())
          ? data.text
          : "Iâ€™m here. What do you want right now â€” venting, solving, or building?";

        addMsg("assistant", reply);

        if (data && data.preview && data.preview.kind === "html") {
          setPreview(data.preview);
        }
      } catch (err) {
        addMsg("assistant", "Something failed calling the server. Open DevTools â†’ Console for the error.");
      } finally {
        setBusy(false);
      }
    }

    function reset() {
      state.conversation = [];
      state.lastPreview = null;
      state.lastSavedHtml = null;
      $("log").innerHTML = "";
      addMsg("assistant", "Reset. Iâ€™m here.");
      $("previewTitle").textContent = "Idle";
      $("previewMeta").textContent = "No preview yet";
      $("previewFrame").srcdoc = "";
    }

    // Wire up listeners (guaranteed)
    $("sendBtn").addEventListener("click", send);
    $("resetBtn").addEventListener("click", reset);

    $("freePill").addEventListener("click", () => setTier("free"));
    $("proPill").addEventListener("click", () => setTier("pro"));

    $("input").addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

    // Pro-locked buttons (no-op for now)
    ["saveBtn","downloadBtn","libraryBtn"].forEach((id) => {
      $(id).addEventListener("click", () => {
        if (state.tier !== "pro") {
          addMsg("assistant", "Thatâ€™s a Pro feature ðŸ”’ (toggle Pro top-right).");
          return;
        }
        addMsg("assistant", "Pro feature placeholder â€” weâ€™ll wire this next.");
      });
    });

    // Initialize
    setTier("free");
  </script>
</body>
</html>
