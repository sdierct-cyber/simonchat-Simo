<!doctype html>
<html lang="en">
<head>
  <link rel="icon" href="data:,">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simo</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg:#0b1020;
      --bg2:#0a0f1f;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.04);
      --line:rgba(255,255,255,.12);
      --text:#eaf0ff;
      --muted:#a9b6d3;
      --btn:#2a66ff;
      --btn2:#1f4dd6;
      --good:#39ff7a;
      --warn:#ffb020;
      --bad:#ff4d4d;
      --shadow:0 18px 44px rgba(0,0,0,.40);
      --shadow2:0 12px 30px rgba(0,0,0,.26);
      --r:18px;
      --r2:24px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 0%, #162a66 0%, var(--bg) 55%),
        radial-gradient(900px 650px at 80% 30%, rgba(42,102,255,.20) 0%, transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      overflow:hidden;
    }
    .wrap{ max-width:1220px; margin:0 auto; height:100%; padding:18px; }
    .topbar{
      height:64px;
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      border-radius:var(--r2);
      box-shadow:var(--shadow);
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .dot{ width:14px; height:14px; border-radius:50%;
      background:rgba(42,102,255,1);
      box-shadow:0 0 0 5px rgba(42,102,255,.12), 0 0 24px rgba(42,102,255,.25);
    }
    .brand h1{ margin:0; font-size:26px; letter-spacing:.2px; }
    .sub{ margin:0; font-size:12px; color:rgba(234,240,255,.65); margin-top:-6px; }
    .rightTop{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .pill{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      border-radius:999px;
      box-shadow:var(--shadow2);
      font-weight:700;
    }
    .statusDot{ width:10px; height:10px; border-radius:50%; background:var(--good); box-shadow:0 0 16px rgba(57,255,122,.35); }
    .btn{
      appearance:none; border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, var(--btn), var(--btn2));
      color:white; font-weight:800;
      padding:10px 14px; border-radius:999px;
      cursor:pointer;
    }
    .btn.secondary{
      background:rgba(255,255,255,.06);
      font-weight:800;
    }
    .btn.danger{
      background:linear-gradient(180deg, rgba(255,77,77,.9), rgba(180,40,40,.95));
    }
    .btn:active{ transform:translateY(1px); }
    .main{
      margin-top:14px;
      height: calc(100% - 78px);
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    .panel{
      height:100%;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      border-radius:var(--r2);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .panelHead{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      font-weight:900;
    }
    .panelHead small{ color:rgba(234,240,255,.65); font-weight:700; }
    .chatBody{ padding:14px; overflow:auto; flex:1; }
    .row{ display:flex; gap:10px; margin-bottom:10px; }
    .avatar{
      width:28px; height:28px; border-radius:10px;
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:rgba(234,240,255,.9);
      font-weight:900;
      flex:0 0 auto;
    }
    .bubble{
      max-width:82%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      line-height:1.45;
      color:rgba(234,240,255,.92);
    }
    .bubble.you{
      background:rgba(42,102,255,.18);
      border-color:rgba(42,102,255,.32);
    }
    .composer{
      border-top:1px solid rgba(255,255,255,.08);
      padding:12px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.06));
    }
    .inputRow{ display:flex; gap:10px; align-items:stretch; }
    textarea{
      flex:1;
      resize:none;
      height:74px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
      font-family:var(--sans);
      font-size:15px;
    }
    textarea::placeholder{ color:rgba(234,240,255,.45); }
    .send{
      width:140px;
      border-radius:16px;
      font-size:16px;
    }
    .actions{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .leftActions{ display:flex; gap:10px; flex-wrap:wrap; }
    .chip{
      font-size:13px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:rgba(234,240,255,.75);
    }
    .chip b{ color:rgba(234,240,255,.95); }
    .disabled{ opacity:.45; cursor:not-allowed; }
    .hint{ font-size:12px; color:rgba(234,240,255,.55); }

    /* ===== Preview: no white panel ever ===== */
    .previewShell{
      position:relative;
      height:100%;
      background:transparent !important;
    }
    #previewFrame{
  width:100%;
  height:100%;
  min-height:520px;
  border:0;
  border-radius:16px;
  display:block;
  background: rgba(0,0,0,.22);
}
    #previewEmpty{
  position:absolute;
  inset:16px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.22);
  color: rgba(234,240,255,.75);
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:22px;
  pointer-events:none;
}
    #previewEmpty b{ color:#eaf0ff; }

    @media (max-width: 1000px){
      .main{ grid-template-columns: 1fr; }
      .wrap{ padding:12px; }
      .send{ width:120px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <h1>Simo</h1>
          <p class="sub" id="subline">Checkpoint V1.B — ChatGPT-like routing • last-good preview • Pro gated</p>
        </div>
      </div>

      <div class="rightTop">
        <button class="btn danger" id="btnReset" type="button">Reset</button>
        <div class="pill"><span class="statusDot"></span><span id="modeLabel">Mode: solving</span></div>
        <div class="pill"><span style="opacity:.7">Pro:</span> <span id="proState">OFF</span></div>
        <button class="btn" id="btnUnlock" type="button">Unlock Pro</button>
      </div>
    </div>

    <div class="main">
      <!-- Chat Panel -->
      <div class="panel">
        <div class="panelHead">
          <div>Chat</div>
          <small id="status">Ready</small>
        </div>

        <div class="chatBody" id="chat"></div>

        <div class="composer">
          <div class="inputRow">
            <textarea id="input" placeholder="Type here..."></textarea>
            <button class="btn send" id="btnSend" type="button">Send</button>
          </div>

          <div class="actions">
            <div class="leftActions">
              <button class="btn secondary" id="btnPreview" type="button">Preview</button>
              <button class="btn secondary" id="btnDownload" type="button">Download</button>
              <button class="btn secondary disabled" id="btnSave" type="button">Save</button>
              <button class="btn secondary disabled" id="btnLibrary" type="button">Library</button>
            </div>
            <div class="hint" id="hint">Enter to send • Shift+Enter for new line</div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <div class="chip">topic: <b id="topicChip">general</b></div>
            <div class="chip">preview: <b id="previewChip">locked</b></div>
            <div class="chip" id="tipChip">Tip: Try: “write a 10-bullet plan…” or “show me a landing page…”</div>
          </div>
        </div>
      </div>

      <!-- Preview Panel -->
      <div class="panel">
        <div class="panelHead">
          <div>Preview</div>
          <small id="previewMeta">Updated • —</small>
        </div>

        <div style="padding:14px; height:100%;">
          <div class="previewShell">
            <div id="previewEmpty">
              <div>
                <b>No preview yet.</b><br/>
                Ask for a build like “show me a landing page…” or “show me a book cover…”
              </div>
            </div>

            <iframe id="previewFrame"
  sandbox="allow-scripts allow-forms allow-modals allow-popups"
  srcdoc="<!doctype html><html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'><style>html,body{height:100%;margin:0}body{display:grid;place-items:center;background:#0b1020;color:#eaf0ff;font-family:system-ui} .card{max-width:520px;padding:18px 16px;border:1px solid rgba(255,255,255,.12);border-radius:16px;background:rgba(255,255,255,.06);text-align:center} .muted{opacity:.75;line-height:1.4}</style></head><body><div class='card'><div style='font-weight:800;font-size:18px'>No preview yet</div><div class='muted' style='margin-top:8px'>Ask for a build like <b>“show me a landing page…”</b> or <b>“show me a book cover…”</b></div></div></body></html>"></iframe>
            ></iframe>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // State
  let mode = "solving";
  let topic = "general";
  let pro = false;

  const chat = $("chat");
  const input = $("input");
  const status = $("status");
  const modeLabel = $("modeLabel");
  const proState = $("proState");
  const previewMeta = $("previewMeta");
  const topicChip = $("topicChip");
  const previewChip = $("previewChip");

  const btnSend = $("btnSend");
  const btnReset = $("btnReset");
  const btnPreview = $("btnPreview");
  const btnDownload = $("btnDownload");
  const btnSave = $("btnSave");
  const btnLibrary = $("btnLibrary");
  const btnUnlock = $("btnUnlock");

  const API = "/.netlify/functions/simon";
  const PRO_API = "/.netlify/functions/pro";

  function nowStamp(){
    const d = new Date();
    return d.toLocaleString();
  }

  function addMsg(who, text){
    const row = document.createElement("div");
    row.className = "row";
    const av = document.createElement("div");
    av.className = "avatar";
    av.textContent = (who === "S") ? "S" : "You";
    const bub = document.createElement("div");
    bub.className = "bubble " + (who === "You" ? "you" : "");
    bub.textContent = text;
    row.appendChild(av);
    row.appendChild(bub);
    chat.appendChild(row);
    chat.scrollTop = chat.scrollHeight;
  }

  // --- Preview: never white, keep last-good ---
  function looksLikeHtml(s){
    s = String(s || "").trim();
    return /^<!doctype html/i.test(s) || /<html[\\s>]/i.test(s) || /<body[\\s>]/i.test(s);
  }

  function showPreview(html){
    const frame = $("previewFrame");
    const empty = $("previewEmpty");
    const s = String(html || "").trim();

    if (!looksLikeHtml(s)) {
      if (empty) empty.style.display = "flex";
      previewChip.textContent = "locked";
      return;
    }

    if (empty) empty.style.display = "none";
    frame.removeAttribute("src");
    frame.srcdoc = s;

    window.__LAST_GOOD_PREVIEW__ = s;
    try { localStorage.setItem("simo_last_good_preview", s); } catch {}

    previewMeta.textContent = "Updated • " + nowStamp();
    previewChip.textContent = "updated";
  }

  function restoreLastGood(){
    const cached = window.__LAST_GOOD_PREVIEW__ || localStorage.getItem("simo_last_good_preview") || "";
    if (cached) showPreview(cached);
    else showPreview(""); // shows dark placeholder
  }

  // --- Pro gating hooks (keeps your existing /pro function) ---
  function setPro(on){
    pro = !!on;
    proState.textContent = pro ? "ON" : "OFF";
    btnSave.classList.toggle("disabled", !pro);
    btnLibrary.classList.toggle("disabled", !pro);
  }

  async function unlockProFlow(){
    const key = prompt("Enter Pro key:");
    if (!key) return;
    try{
      const r = await fetch(PRO_API, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ key })
      });
      const j = await r.json().catch(() => ({}));
      if (j && j.ok && j.pro) {
        setPro(true);
        alert("Pro unlocked.");
      } else {
        setPro(false);
        alert("Invalid key.");
      }
    } catch {
      alert("Pro check failed.");
    }
  }

  // --- ChatGPT-like routing: UI mode can be changed by backend ---
  function setModeLabel(m){
    mode = m || mode;
    modeLabel.textContent = "Mode: " + mode;
  }

  async function send(){
    const text = input.value.trim();
    if (!text) return;

    addMsg("You", text);
    input.value = "";
    status.textContent = "Thinking…";

    try{
      const payload = { mode, topic, input: text };
      const r = await fetch(API, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });

      const j = await r.json().catch(() => null);
      if (!j || !j.ok){
        status.textContent = "Backend error.";
        addMsg("S", "Backend error. Kept last-good preview.");
        restoreLastGood();
        return;
      }

      if (j.routed_mode) setModeLabel(j.routed_mode);
      if (j.topic) { topic = j.topic; topicChip.textContent = topic; }

      if (j.text) addMsg("S", j.text);

      // If HTML came back, render it. If not, do NOT clear preview.
      const html = j.html || j.preview_html || j.output_html || "";
      if (looksLikeHtml(html)) showPreview(html);

      status.textContent = "Ready";
    } catch(e){
      status.textContent = "Backend error.";
      addMsg("S", "Backend error. Kept last-good preview.");
      restoreLastGood();
    }
  }

  // Preview button: forces GET self-test preview render
  async function previewTest(){
    status.textContent = "Loading preview…";
    try{
      const r = await fetch(API);
      const j = await r.json().catch(() => null);
      if (j && j.ok && looksLikeHtml(j.html)) {
        showPreview(j.html);
        addMsg("S", "Preview updated.");
      } else {
        addMsg("S", "No valid HTML returned.");
        restoreLastGood();
      }
    } finally {
      status.textContent = "Ready";
    }
  }

  function download(){
    const html = window.__LAST_GOOD_PREVIEW__ || localStorage.getItem("simo_last_good_preview") || "";
    const blob = new Blob([html || ""], { type:"text/html" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "simo_preview.html";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function reset(){
    chat.innerHTML = "";
    addMsg("S", "Reset. I’m here.");
    status.textContent = "Ready";
    topic = "general";
    topicChip.textContent = topic;
    setModeLabel("solving");
    restoreLastGood(); // IMPORTANT: prevents white panel
  }

  // Wire events
  btnSend.addEventListener("click", send);
  btnReset.addEventListener("click", reset);
  btnPreview.addEventListener("click", previewTest);
  btnDownload.addEventListener("click", download);
  btnUnlock.addEventListener("click", unlockProFlow);

  btnSave.addEventListener("click", () => {
    if (!pro) return;
    const html = window.__LAST_GOOD_PREVIEW__ || localStorage.getItem("simo_last_good_preview") || "";
    if (!html) return alert("Nothing to save yet.");
    const name = prompt("Save name:", "build-" + new Date().toISOString().slice(0,10));
    if (!name) return;
    const lib = JSON.parse(localStorage.getItem("simo_library") || "[]");
    lib.unshift({ name, html, at: Date.now() });
    localStorage.setItem("simo_library", JSON.stringify(lib.slice(0,50)));
    alert("Saved.");
  });

  btnLibrary.addEventListener("click", () => {
    if (!pro) return;
    const lib = JSON.parse(localStorage.getItem("simo_library") || "[]");
    if (!lib.length) return alert("Library empty.");
    const names = lib.map((x,i) => `${i+1}) ${x.name}`).join("\\n");
    const pick = prompt("Pick a number:\\n" + names);
    const idx = Number(pick) - 1;
    if (!Number.isFinite(idx) || !lib[idx]) return;
    showPreview(lib[idx].html);
    addMsg("S", `Loaded: ${lib[idx].name}`);
  });

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      send();
    }
  });

  // Boot
  reset();
})();
</script>
</body>
</html>



