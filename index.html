<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simo</title>
  <style>
    :root{
      --bg:#0b1020; --text:#eaf0ff; --muted:#a9b6d3;
      --line:rgba(255,255,255,.10);
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.04);
      --btn:#2a66ff; --btn2:#1f4dd6;
      --good:#39d98a; --bad:#ff4d4d;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:radial-gradient(1200px 700px at 20% 0%, #162a66 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{max-width:1240px;margin:0 auto;padding:18px}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:14px; padding:12px 14px;
      border:1px solid var(--line);
      border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:44px; height:44px; border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.05));
      border:1px solid var(--line);
    }
    .brand h1{font-size:26px; margin:0; line-height:1}
    .brand .tag{font-size:13px;color:var(--muted); margin-top:2px}
    .top-actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:800;
    }
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn.primary{
      background:var(--btn);
      border-color:transparent;
    }
    .btn.primary:hover{background:var(--btn2)}
    .toggle{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:999px;
      border:1px solid rgba(57,217,138,.35);
      background:rgba(57,217,138,.08);
      box-shadow:0 10px 26px rgba(0,0,0,.2);
    }
    .toggle span{font-weight:900}
    .switch{
      width:44px; height:24px; border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.25);
      position:relative;
      cursor:pointer;
    }
    .knob{
      position:absolute; top:2px; left:2px;
      width:20px; height:20px; border-radius:999px;
      background:rgba(255,255,255,.85);
      transition:all .18s ease;
    }
    .switch.on{background:rgba(57,217,138,.25); border-color:rgba(57,217,138,.35)}
    .switch.on .knob{left:22px; background:rgba(255,255,255,.95)}

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    .panel{
      border:1px solid var(--line);
      border-radius:26px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height:680px;
      display:flex;
      flex-direction:column;
    }
    .panelHead{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--line);
    }
    .panelHead h2{margin:0;font-size:26px;letter-spacing:.5px}
    .modes{display:flex; gap:10px}
    .modeBtn{
      padding:10px 16px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.12);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
    }
    .modeBtn.active{
      background:rgba(42,102,255,.22);
      border-color:rgba(42,102,255,.45);
    }

    .chatBody{
      padding:16px;
      flex:1;
      overflow:auto;
    }
    .msg{
      border:1px solid var(--line);
      background:rgba(0,0,0,.10);
      border-radius:18px;
      padding:14px 14px;
      margin-bottom:12px;
      max-width:92%;
      box-shadow:0 10px 26px rgba(0,0,0,.18);
    }
    .msg.you{
      margin-left:auto;
      background:rgba(42,102,255,.16);
      border-color:rgba(42,102,255,.35);
    }
    .msg .who{font-weight:900; font-size:13px; color:var(--muted); margin-bottom:6px}
    .msg .txt{white-space:pre-wrap; line-height:1.35}
    .statusRow{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:10px 14px;
      border-top:1px solid var(--line);
      background:rgba(0,0,0,.10);
    }
    .tip{font-size:12px; color:var(--muted)}
    .ready{
      display:flex; align-items:center; gap:8px;
      font-size:12px; color:var(--muted);
      user-select:none;
    }
    .dot{
      width:9px;height:9px;border-radius:999px;background:var(--good);
      box-shadow:0 0 0 4px rgba(57,217,138,.12);
    }
    .dot.bad{background:var(--bad); box-shadow:0 0 0 4px rgba(255,77,77,.12)}
    .dot.think{background:#8aa7ff; box-shadow:0 0 0 4px rgba(138,167,255,.14)}
    .composer{
      padding:12px 14px;
      display:flex; gap:10px; align-items:flex-end;
      border-top:1px solid var(--line);
      background:rgba(0,0,0,.12);
    }
    textarea{
      flex:1;
      min-height:46px;
      max-height:140px;
      resize:none;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      color:var(--text);
      padding:12px 12px;
      outline:none;
      font-size:14px;
    }
    .send{
      padding:12px 18px;
      border-radius:14px;
      border:none;
      background:var(--btn);
      color:#fff;
      font-weight:900;
      cursor:pointer;
    }
    .send:hover{background:var(--btn2)}
    .send:disabled{opacity:.55; cursor:not-allowed}

    /* Preview panel */
    .previewTopActions{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .pillSmall{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(57,217,138,.35);
      background:rgba(57,217,138,.08);
      font-weight:900;
      font-size:12px;
      color:var(--text);
    }
    .previewMeta{
      padding:12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--line);
      color:var(--muted);
      font-size:13px;
    }
    .previewBody{
      padding:14px 14px 0;
      flex:1;
      overflow:auto;
    }
    .previewFrameWrap{
      border:1px solid var(--line);
      background:rgba(0,0,0,.10);
      border-radius:18px;
      overflow:hidden;
      height:100%;
      min-height:560px;
      box-shadow:0 14px 40px rgba(0,0,0,.22);
    }
    iframe{
      width:100%;
      height:100%;
      border:0;
      background:#fff;
    }
    .emptyPreview{
      padding:80px 20px;
      text-align:center;
      color:rgba(234,240,255,.88);
    }
    .emptyPreview h3{margin:0 0 10px; font-size:36px}
    .emptyPreview .hint{color:var(--muted)}
    .footNote{
      padding:10px 16px 14px;
      color:var(--muted);
      font-size:12px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0; background:rgba(0,0,0,.65);
      display:none; align-items:center; justify-content:center;
      padding:18px;
    }
    .modal{
      width:min(860px, 98vw);
      max-height:86vh;
      overflow:auto;
      border-radius:22px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(20,28,58,.98), rgba(10,14,30,.98));
      box-shadow:0 26px 100px rgba(0,0,0,.55);
      padding:16px;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:10px;
    }
    .modalHead h3{margin:0;font-size:22px}
    .list{
      display:grid; gap:10px;
    }
    .item{
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      border-radius:16px;
      padding:12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .item .left{
      display:flex; flex-direction:column; gap:4px;
      min-width:0;
    }
    .item .name{font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .item .date{font-size:12px;color:var(--muted)}
    .item .actions{display:flex; gap:8px; flex-wrap:wrap}
    .smallBtn{
      padding:8px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
    }
    .smallBtn:hover{background:rgba(255,255,255,.10)}
    .smallBtn.danger{border-color:rgba(255,77,77,.40)}
    .smallBtn.danger:hover{background:rgba(255,77,77,.14)}

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .panel{min-height:620px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Simo</h1>
          <div class="tag">best friend + builder</div>
        </div>
      </div>

      <div class="top-actions">
        <div class="toggle" title="When ON, Simo will auto-render previews when provided by the backend.">
          <span>Pro Mode</span>
          <div id="proSwitch" class="switch on"><div class="knob"></div></div>
        </div>
        <button id="resetBtn" class="btn">Reset</button>
        <button id="openLibraryBtnTop" class="btn">Library</button>
      </div>
    </div>

    <div class="grid">
      <!-- CHAT -->
      <div class="panel">
        <div class="panelHead">
          <h2>CHAT</h2>
          <div class="modes">
            <button class="modeBtn" data-mode="venting">Venting</button>
            <button class="modeBtn" data-mode="solving">Solving</button>
            <button class="modeBtn active" data-mode="building">Building</button>
          </div>
        </div>

        <div id="chatBody" class="chatBody"></div>

        <div class="composer">
          <textarea id="input" placeholder="Type here… (Enter to send, Shift+Enter for new line)"></textarea>
          <button id="sendBtn" class="send">Send</button>
        </div>

        <div class="statusRow">
          <div class="tip">Tip: in <b>Building</b> mode, ask for a layout/app/site and I’ll render a preview.</div>
          <div class="ready">
            <div id="statusDot" class="dot"></div>
            <div id="statusText">Ready</div>
          </div>
        </div>
      </div>

      <!-- PREVIEW -->
      <div class="panel">
        <div class="panelHead">
          <h2>PREVIEW</h2>
          <div class="previewTopActions">
            <button id="saveBuildBtn" class="btn">Save Build</button>
            <button id="openLibraryBtn" class="btn">Library</button>
            <button id="copyHtmlBtn" class="btn">Copy HTML</button>
            <button id="downloadBtn" class="btn">Download</button>
          </div>
        </div>

        <div class="previewMeta">
          <div>Current: <b id="currentLabel">Untitled preview</b></div>
          <div class="pillSmall" id="modePill">Building</div>
        </div>

        <div class="previewBody">
          <div class="previewFrameWrap" id="previewWrap">
            <div id="emptyPreview" class="emptyPreview">
              <h3>No preview yet.</h3>
              <div class="hint">Switch to <b>Building</b> and ask for something like: “build a landing page preview”</div>
            </div>
            <iframe id="previewFrame" sandbox="allow-forms allow-modals allow-popups allow-scripts allow-same-origin" style="display:none;"></iframe>
          </div>
        </div>

        <div class="footNote">
          <div>Library is saved on this device</div>
          <div class="pillSmall">PRO enabled</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Library Modal -->
  <div id="modalBack" class="modalBack">
    <div class="modal">
      <div class="modalHead">
        <h3>Library</h3>
        <button id="closeModalBtn" class="btn">Close</button>
      </div>
      <div id="libraryList" class="list"></div>
    </div>
  </div>

<script>
  // ---------------------------
  // State
  // ---------------------------
  const API_URL = "/.netlify/functions/simon";
  let mode = "building";
  let proMode = true;

  let currentPreview = {
    kind: null,
    title: "Untitled preview",
    html: null,
  };

  // chat history for your UI only (backend in this version is stateful by itself)
  const chat = [];

  // ---------------------------
  // Elements
  // ---------------------------
  const chatBody = document.getElementById("chatBody");
  const input = document.getElementById("input");
  const sendBtn = document.getElementById("sendBtn");
  const resetBtn = document.getElementById("resetBtn");

  const modeButtons = Array.from(document.querySelectorAll(".modeBtn"));
  const modePill = document.getElementById("modePill");

  const proSwitch = document.getElementById("proSwitch");

  const currentLabel = document.getElementById("currentLabel");
  const emptyPreview = document.getElementById("emptyPreview");
  const previewFrame = document.getElementById("previewFrame");

  const saveBuildBtn = document.getElementById("saveBuildBtn");
  const copyHtmlBtn = document.getElementById("copyHtmlBtn");
  const downloadBtn = document.getElementById("downloadBtn");
  const openLibraryBtn = document.getElementById("openLibraryBtn");
  const openLibraryBtnTop = document.getElementById("openLibraryBtnTop");

  const modalBack = document.getElementById("modalBack");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const libraryList = document.getElementById("libraryList");

  const statusDot = document.getElementById("statusDot");
  const statusText = document.getElementById("statusText");

  // ---------------------------
  // Helpers
  // ---------------------------
  function setStatus(kind, text){
    statusDot.classList.remove("bad","think");
    if(kind === "ready"){
      statusDot.classList.add();
      statusDot.className = "dot";
    } else if(kind === "thinking"){
      statusDot.className = "dot think";
    } else if(kind === "error"){
      statusDot.className = "dot bad";
    }
    statusText.textContent = text;
  }

  function pushMsg(who, text){
    chat.push({ who, text });
    renderChat();
  }

  function renderChat(){
    chatBody.innerHTML = "";
    for(const m of chat){
      const div = document.createElement("div");
      div.className = "msg " + (m.who === "You" ? "you" : "simo");

      const who = document.createElement("div");
      who.className = "who";
      who.textContent = m.who;

      const txt = document.createElement("div");
      txt.className = "txt";
      txt.textContent = m.text;

      div.appendChild(who);
      div.appendChild(txt);
      chatBody.appendChild(div);
    }
    chatBody.scrollTop = chatBody.scrollHeight;
  }

  function setMode(newMode){
    mode = newMode;
    modeButtons.forEach(b => b.classList.toggle("active", b.dataset.mode === newMode));
    modePill.textContent = newMode.charAt(0).toUpperCase() + newMode.slice(1);

    // keep the vibe consistent
    if(newMode === "venting"){
      pushMsg("Simo", "I’m here. Talk to me.");
    } else if(newMode === "solving"){
      pushMsg("Simo", "Alright. What are we trying to fix or accomplish?");
    } else {
      pushMsg("Simo", "I’m here. Pick a mode — or just talk.");
    }
  }

  function setPreview({kind, title, html}){
    currentPreview.kind = kind || currentPreview.kind;
    currentPreview.title = title || (kind ? kind : "Untitled preview");
    currentPreview.html = html || currentPreview.html;

    currentLabel.textContent = currentPreview.title || "Untitled preview";

    if(currentPreview.html){
      emptyPreview.style.display = "none";
      previewFrame.style.display = "block";
      previewFrame.srcdoc = currentPreview.html;
    } else {
      emptyPreview.style.display = "block";
      previewFrame.style.display = "none";
      previewFrame.srcdoc = "";
    }
  }

  function getLibrary(){
    try{
      return JSON.parse(localStorage.getItem("simo_library") || "[]");
    }catch(e){
      return [];
    }
  }
  function setLibrary(items){
    localStorage.setItem("simo_library", JSON.stringify(items));
  }

  function downloadText(filename, text){
    const blob = new Blob([text], {type:"text/html;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  }

  async function copyToClipboard(text){
    await navigator.clipboard.writeText(text);
  }

  // ---------------------------
  // Core: Send to backend
  // ---------------------------
  async function sendMessage(){
    const msg = input.value.trim();
    if(!msg) return;

    input.value = "";
    pushMsg("You", msg);

    setStatus("thinking", "Thinking…");
    sendBtn.disabled = true;

    try{
      const res = await fetch(API_URL, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ message: msg, mode })
      });

      const data = await res.json();

      // assistant text
      const assistantText =
        data.assistant || data.reply || data.text || (data.ok ? "Okay." : "Error.");

      pushMsg("Simo", assistantText);

      // --- preview extraction (supports multiple formats; YOUR backend uses data.preview.html) ---
      const previewHTML =
        (data && data.preview && data.preview.html) ||
        (data && typeof data.preview === "string" ? data.preview : null) ||
        (data && data.preview_html) ||
        (data && data.updated_html) ||
        null;

      const previewKind =
        (data && data.preview && data.preview.kind) ||
        (data && data.kind) ||
        null;

      const previewTitle =
        (data && data.preview && data.preview.title) ||
        (previewKind ? previewKind : null);

      // Auto-render when Pro mode is ON
      if(proMode && previewHTML){
        setPreview({ kind: previewKind, title: previewTitle, html: previewHTML });
      }

      setStatus("ready", "Ready");
    }catch(err){
      pushMsg("Simo", "⚠️ Server error");
      setStatus("error", "Error");
    }finally{
      sendBtn.disabled = false;
      input.focus();
    }
  }

  // ---------------------------
  // Library UI
  // ---------------------------
  function openModal(){
    modalBack.style.display = "flex";
    renderLibrary();
  }
  function closeModal(){
    modalBack.style.display = "none";
  }

  function renderLibrary(){
    const items = getLibrary();
    libraryList.innerHTML = "";

    if(items.length === 0){
      const empty = document.createElement("div");
      empty.className = "item";
      empty.innerHTML = `<div class="left"><div class="name">No saved builds yet</div><div class="date">Use “Save Build” after a preview renders.</div></div>`;
      libraryList.appendChild(empty);
      return;
    }

    items
      .slice()
      .sort((a,b)=> (b.savedAt||0)-(a.savedAt||0))
      .forEach((it, idx)=>{
        const row = document.createElement("div");
        row.className = "item";

        const left = document.createElement("div");
        left.className = "left";
        const name = document.createElement("div");
        name.className = "name";
        name.textContent = it.title || it.kind || "Saved build";
        const date = document.createElement("div");
        date.className = "date";
        date.textContent = new Date(it.savedAt || Date.now()).toLocaleString();
        left.appendChild(name);
        left.appendChild(date);

        const actions = document.createElement("div");
        actions.className = "actions";

        const loadBtn = document.createElement("button");
        loadBtn.className = "smallBtn";
        loadBtn.textContent = "Load";
        loadBtn.onclick = ()=>{
          setPreview({ kind: it.kind, title: it.title, html: it.html });
          closeModal();
        };

        const delBtn = document.createElement("button");
        delBtn.className = "smallBtn danger";
        delBtn.textContent = "Delete";
        delBtn.onclick = ()=>{
          const all = getLibrary();
          const filtered = all.filter(x => x.id !== it.id);
          setLibrary(filtered);
          renderLibrary();
        };

        actions.appendChild(loadBtn);
        actions.appendChild(delBtn);

        row.appendChild(left);
        row.appendChild(actions);
        libraryList.appendChild(row);
      });
  }

  // ---------------------------
  // Wire up events
  // ---------------------------
  sendBtn.addEventListener("click", sendMessage);

  input.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      sendMessage();
    }
  });

  resetBtn.addEventListener("click", ()=>{
    chat.length = 0;
    setPreview({ kind:null, title:"Untitled preview", html:null });
    setStatus("ready","Ready");
    // keep welcome consistent with active mode
    if(mode === "building"){
      pushMsg("Simo","I’m here. Pick a mode — or just talk.");
    } else if(mode === "venting"){
      pushMsg("Simo","I’m here. Talk to me.");
    } else {
      pushMsg("Simo","Alright. What are we trying to fix or accomplish?");
    }
  });

  modeButtons.forEach(btn=>{
    btn.addEventListener("click", ()=> setMode(btn.dataset.mode));
  });

  proSwitch.addEventListener("click", ()=>{
    proMode = !proMode;
    proSwitch.classList.toggle("on", proMode);
  });

  saveBuildBtn.addEventListener("click", ()=>{
    if(!currentPreview.html){
      pushMsg("Simo", "No preview to save yet — generate one first.");
      return;
    }
    const items = getLibrary();
    const id = "b_" + Math.random().toString(16).slice(2) + "_" + Date.now();
    items.push({
      id,
      kind: currentPreview.kind || "preview",
      title: currentPreview.title || "Saved build",
      html: currentPreview.html,
      savedAt: Date.now()
    });
    setLibrary(items);
    pushMsg("Simo", "Saved to Library.");
  });

  openLibraryBtn.addEventListener("click", openModal);
  openLibraryBtnTop.addEventListener("click", openModal);
  closeModalBtn.addEventListener("click", closeModal);
  modalBack.addEventListener("click", (e)=>{
    if(e.target === modalBack) closeModal();
  });

  copyHtmlBtn.addEventListener("click", async ()=>{
    if(!currentPreview.html){
      pushMsg("Simo", "No HTML to copy yet — generate a preview first.");
      return;
    }
    try{
      await copyToClipboard(currentPreview.html);
      pushMsg("Simo", "Copied HTML to clipboard.");
    }catch(e){
      pushMsg("Simo", "Couldn’t copy automatically — your browser blocked it.");
    }
  });

  downloadBtn.addEventListener("click", ()=>{
    if(!currentPreview.html){
      pushMsg("Simo", "No HTML to download yet — generate a preview first.");
      return;
    }
    const safeName = (currentPreview.title || "preview").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");
    downloadText((safeName || "preview") + ".html", currentPreview.html);
    pushMsg("Simo", "Downloaded HTML file.");
  });

  // ---------------------------
  // Boot
  // ---------------------------
  setStatus("ready","Ready");
  pushMsg("Simo","I’m here. Pick a mode — or just talk.");
  input.focus();
</script>
</body>
</html>
