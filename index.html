<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simo</title>
  <style>
    :root{
      --bg:#0b1020; --text:#eaf0ff; --muted:#a9b6d3;
      --line:rgba(255,255,255,.10);
      --card:rgba(255,255,255,.04);
      --pill:rgba(255,255,255,.06);
      --pillOn:rgba(42,102,255,.22);
      --btn:#2a66ff; --btn2:#1f4dd6;
      --good:#39d98a;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:radial-gradient(1200px 700px at 20% 0%, #162a66 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{max-width:1180px;margin:0 auto;padding:18px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 16px;border:1px solid var(--line);border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      position:sticky;top:12px;z-index:10;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background:linear-gradient(135deg, rgba(42,102,255,.9), rgba(0,255,200,.25));
      border:1px solid rgba(255,255,255,.14);
    }
    .brand h1{font-size:22px;margin:0;line-height:1}
    .brand small{display:block;color:var(--muted);margin-top:3px}

    .rightControls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .toggle{
      display:flex;gap:10px;align-items:center;
      padding:8px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(0,0,0,.15);
    }
    .toggle span{color:var(--muted);font-size:13px}
    .switch{
      width:44px;height:24px;border-radius:999px;position:relative;cursor:pointer;
      background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.12);
    }
    .switch::after{
      content:"";position:absolute;top:50%;transform:translateY(-50%);
      left:3px;width:18px;height:18px;border-radius:999px;background:rgba(255,255,255,.85);
      transition:.18s ease;
    }
    .switch.on{background:rgba(57,217,138,.25);border-color:rgba(57,217,138,.35)}
    .switch.on::after{left:22px;background:rgba(57,217,138,.95)}
    .btn{
      padding:10px 14px;border-radius:12px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);color:var(--text);cursor:pointer;
      font-weight:650;letter-spacing:.2px;
    }
    .btn.primary{background:linear-gradient(180deg, var(--btn), var(--btn2));border-color:rgba(42,102,255,.45)}

    .grid{display:grid;grid-template-columns: 1fr 1fr; gap:14px; margin-top:14px}
    .panel{
      border:1px solid var(--line);border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height:620px;
    }
    .panelHead{
      padding:14px 14px;border-bottom:1px solid var(--line);
      display:flex;justify-content:space-between;align-items:center;
      background:rgba(0,0,0,.12);
    }
    .panelHead h2{margin:0;font-size:18px;letter-spacing:.3px}
    .tabs{display:flex;gap:8px}
    .tab{
      padding:8px 12px;border-radius:999px;border:1px solid var(--line);
      background:var(--pill);cursor:pointer;color:var(--text);
      font-weight:650;font-size:13px;
      opacity:.85;
    }
    .tab.on{background:var(--pillOn);border-color:rgba(42,102,255,.45);opacity:1}
    .panelBody{display:flex;flex-direction:column;height:calc(100% - 56px)}
    .chatlog{padding:14px;overflow:auto;flex:1}
    .msg{max-width:86%;padding:12px;border-radius:16px;margin:10px 0;border:1px solid var(--line)}
    .msg.you{margin-left:auto;background:rgba(42,102,255,.14);border-color:rgba(42,102,255,.35)}
    .msg.simo{background:rgba(255,255,255,.04)}
    .msg .who{font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:700}
    .msg .txt{white-space:pre-wrap;line-height:1.35}

    .composer{
      border-top:1px solid var(--line);
      padding:12px;display:flex;gap:10px;align-items:flex-end;
      background:rgba(0,0,0,.10);
    }
    textarea{
      flex:1;min-height:44px;max-height:140px;resize:none;
      border-radius:14px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);color:var(--text);
      padding:10px 12px;font-size:14px;outline:none;
    }
    .sendRow{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
    .status{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:12px;padding-right:4px}
    .dot{width:8px;height:8px;border-radius:99px;background:var(--good);box-shadow:0 0 0 4px rgba(57,217,138,.10)}
    .dot.off{background:rgba(255,255,255,.22);box-shadow:none}
    .hint{color:var(--muted);font-size:12px;padding:0 14px 12px}

    .previewTools{display:flex;gap:10px;flex-wrap:wrap}
    .previewWrap{padding:14px;height:100%;display:flex;flex-direction:column;gap:10px}
    .previewTop{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .pillSmall{
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(0,0,0,.15);color:var(--text);font-weight:700;font-size:12px;
    }
    .previewBox{
      flex:1;border:1px solid var(--line);border-radius:16px;overflow:hidden;background:rgba(0,0,0,.12)
    }
    iframe{width:100%;height:100%;border:0;background:#0b1020}

    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.18);
      padding:10px 12px;border-radius:12px;color:var(--text);
      display:none;gap:10px;align-items:center;
      backdrop-filter: blur(10px);
      max-width: 92vw;
    }
    .toast.show{display:flex}
    .toast .ticon{color:var(--good);font-weight:900}

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .panel{min-height:560px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Simo</h1>
          <small>best friend + builder</small>
        </div>
      </div>
      <div class="rightControls">
        <div class="toggle" title="Pro mode turns on auto-preview + advanced tools (when available)">
          <span><b>Pro Mode</b></span>
          <div id="proSwitch" class="switch"></div>
        </div>
        <button id="resetBtn" class="btn">Reset</button>
        <button id="libraryBtn" class="btn">Library</button>
      </div>
    </div>

    <div class="grid">
      <!-- CHAT -->
      <div class="panel">
        <div class="panelHead">
          <h2>CHAT</h2>
          <div class="tabs">
            <button class="tab" data-mode="venting">Venting</button>
            <button class="tab" data-mode="solving">Solving</button>
            <button class="tab on" data-mode="building">Building</button>
          </div>
        </div>

        <div class="panelBody">
          <div id="chatlog" class="chatlog"></div>

          <div class="composer">
            <textarea id="input" placeholder="Type here… (Enter to send, Shift+Enter for new line)"></textarea>
            <div class="sendRow">
              <button id="sendBtn" class="btn primary">Send</button>
              <div class="status">
                <div id="dot" class="dot"></div>
                <span id="statusText">Ready</span>
              </div>
            </div>
          </div>
          <div class="hint">
            Tip: in <b>Building</b> mode, ask for a layout/app/site and I’ll render a preview.
          </div>
        </div>
      </div>

      <!-- PREVIEW -->
      <div class="panel">
        <div class="panelHead">
          <h2>PREVIEW</h2>
          <div class="previewTools">
            <button id="saveBuildBtn" class="btn">Save Build</button>
            <button id="openLibraryBtn" class="btn">Library</button>
            <button id="copyHtmlBtn" class="btn">Copy HTML</button>
            <button id="downloadBtn" class="btn">Download</button>
          </div>
        </div>

        <div class="panelBody">
          <div class="previewWrap">
            <div class="previewTop">
              <div class="cur">Current: <b id="curName">Untitled preview</b></div>
              <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                <span id="modePill" class="pillSmall">Building</span>
                <span id="proPill" class="pillSmall">PRO enabled</span>
              </div>
            </div>

            <div class="previewBox">
              <iframe id="previewFrame" title="Preview"></iframe>
            </div>

            <div style="color:var(--muted);font-size:12px">Library is saved on this device</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"><span class="ticon">●</span><span id="toastTxt"></span></div>

<script>
(() => {
  const API_URL = "/.netlify/functions/simon";

  const els = {
    chatlog: document.getElementById("chatlog"),
    input: document.getElementById("input"),
    sendBtn: document.getElementById("sendBtn"),
    dot: document.getElementById("dot"),
    statusText: document.getElementById("statusText"),
    tabs: Array.from(document.querySelectorAll(".tab")),
    proSwitch: document.getElementById("proSwitch"),
    resetBtn: document.getElementById("resetBtn"),
    libraryBtn: document.getElementById("libraryBtn"),
    openLibraryBtn: document.getElementById("openLibraryBtn"),
    saveBuildBtn: document.getElementById("saveBuildBtn"),
    copyHtmlBtn: document.getElementById("copyHtmlBtn"),
    downloadBtn: document.getElementById("downloadBtn"),
    curName: document.getElementById("curName"),
    previewFrame: document.getElementById("previewFrame"),
    toast: document.getElementById("toast"),
    toastTxt: document.getElementById("toastTxt"),
    modePill: document.getElementById("modePill"),
    proPill: document.getElementById("proPill"),
  };

  const state = {
    mode: "building",
    pro: true,
    current: { name: "Untitled preview", html: "", kind: "none" },
    library: []
  };

  // Persisted state
  try {
    const saved = JSON.parse(localStorage.getItem("simo_library_v1") || "[]");
    if (Array.isArray(saved)) state.library = saved;
  } catch {}
  try {
    const pro = localStorage.getItem("simo_pro_v1");
    if (pro !== null) state.pro = (pro === "1");
  } catch {}

  const toast = (msg) => {
    els.toastTxt.textContent = msg;
    els.toast.classList.add("show");
    setTimeout(() => els.toast.classList.remove("show"), 1600);
  };

  const setBusy = (busy, label) => {
    els.dot.classList.toggle("off", !!busy);
    els.statusText.textContent = label || (busy ? "Thinking" : "Ready");
    els.sendBtn.disabled = !!busy;
    els.input.disabled = !!busy;
  };

  const renderMsg = (who, text) => {
    const wrap = document.createElement("div");
    wrap.className = "msg " + (who === "You" ? "you" : "simo");
    wrap.innerHTML = `<div class="who">${who}</div><div class="txt"></div>`;
    wrap.querySelector(".txt").textContent = text;
    els.chatlog.appendChild(wrap);
    els.chatlog.scrollTop = els.chatlog.scrollHeight;
  };

  const defaultEmptyPreviewHTML = () => `
<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{margin:0;background:#0b1020;color:#eaf0ff;font-family:system-ui;display:flex;align-items:center;justify-content:center;height:100vh}
  .card{border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:22px;background:rgba(255,255,255,.04);max-width:520px}
  h1{margin:0 0 8px 0;font-size:22px}
  p{margin:0;color:rgba(234,240,255,.75)}
</style></head>
<body><div class="card">
  <h1>No preview yet.</h1>
  <p>Switch to <b>Building</b> and ask: “build a landing page preview”.</p>
</div></body></html>`;

  const setPreview = ({name, html, kind}) => {
    state.current = { name: name || "Untitled preview", html: html || "", kind: kind || "html" };
    els.curName.textContent = state.current.name;
    els.previewFrame.srcdoc = state.current.html || defaultEmptyPreviewHTML();
  };

  const applyMode = (m) => {
    state.mode = m;
    els.tabs.forEach(t => t.classList.toggle("on", t.dataset.mode === m));
    els.modePill.textContent = m[0].toUpperCase() + m.slice(1);
  };

  const applyPro = (on) => {
    state.pro = !!on;
    els.proSwitch.classList.toggle("on", state.pro);
    els.proPill.textContent = state.pro ? "PRO enabled" : "PRO off";
    localStorage.setItem("simo_pro_v1", state.pro ? "1" : "0");
  };

  const saveToLibrary = () => {
    if (!state.current.html) return toast("No HTML to save yet.");
    const item = {
      id: crypto.randomUUID(),
      name: state.current.name || "Saved build",
      html: state.current.html,
      kind: state.current.kind || "html",
      savedAt: new Date().toISOString()
    };
    state.library.unshift(item);
    localStorage.setItem("simo_library_v1", JSON.stringify(state.library.slice(0, 100)));
    toast("Saved to Library.");
  };

  const openLibrary = () => {
    if (!state.library.length) return toast("Library is empty.");
    const list = state.library.slice(0, 10).map((x, i) => `${i+1}. ${x.name}`).join("\n");
    const pick = prompt("Open which saved build?\n\n" + list + "\n\nEnter 1-" + Math.min(10, state.library.length));
    const n = Number(pick);
    if (!Number.isFinite(n) || n < 1 || n > Math.min(10, state.library.length)) return;
    const item = state.library[n-1];
    setPreview({name: item.name, html: item.html, kind: item.kind});
    toast("Loaded: " + item.name);
  };

  const copyHTML = async () => {
    if (!state.current.html) return toast("No HTML to copy yet.");
    try {
      await navigator.clipboard.writeText(state.current.html);
      toast("Copied HTML.");
    } catch {
      toast("Copy blocked. Use Download.");
    }
  };

  const downloadHTML = () => {
    if (!state.current.html) return toast("No HTML to download yet.");
    const blob = new Blob([state.current.html], {type: "text/html"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    const safe = (state.current.name || "build").replace(/[^a-z0-9-_]+/gi, "_").toLowerCase();
    a.download = safe + ".html";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(a.href), 500);
    toast("Downloaded.");
  };

  const callSimo = async (message) => {
    const payload = { message, mode: state.mode, pro: state.pro };
    const res = await fetch(API_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error("Server error");
    return await res.json();
  };

  const handleSend = async () => {
    const text = els.input.value.trim();
    if (!text) return;

    els.input.value = "";
    renderMsg("You", text);
    setBusy(true, "Thinking");

    try {
      const data = await callSimo(text);
      renderMsg("Simo", data?.reply || "Okay.");

      if (data?.preview?.html) {
        setPreview({
          name: data.preview.name || "Preview",
          html: data.preview.html,
          kind: data.preview.kind || "html"
        });
      }
    } catch {
      renderMsg("Simo", "⚠️ Server error");
    } finally {
      setBusy(false, "Ready");
    }
  };

  // Events
  els.sendBtn.addEventListener("click", handleSend);
  els.input.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); handleSend(); }
  });

  els.tabs.forEach(t => t.addEventListener("click", () => applyMode(t.dataset.mode)));
  els.proSwitch.addEventListener("click", () => applyPro(!state.pro));

  els.resetBtn.addEventListener("click", () => {
    els.chatlog.innerHTML = "";
    renderMsg("Simo", "I’m here. Pick a mode — or just talk.");
    setPreview({name:"Untitled preview", html:"", kind:"none"});
    toast("Reset.");
  });

  els.libraryBtn.addEventListener("click", openLibrary);
  els.openLibraryBtn.addEventListener("click", openLibrary);
  els.saveBuildBtn.addEventListener("click", saveToLibrary);
  els.copyHtmlBtn.addEventListener("click", copyHTML);
  els.downloadBtn.addEventListener("click", downloadHTML);

  // Init
  applyMode("building");
  applyPro(state.pro);
  renderMsg("Simo", "I’m here. Pick a mode — or just talk.");
  setPreview({name:"Untitled preview", html:"", kind:"none"});
})();
</script>
</body>
</html>
