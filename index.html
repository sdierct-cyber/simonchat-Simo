<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simo</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg:#0b1020; --panel:#0f1730; --panel2:#0c1328;
      --text:#eaf0ff; --muted:#a9b6d3; --line:rgba(255,255,255,.10);
      --btn:#2a66ff; --btn2:#1f4dd6;
      --good:#39ff7a; --bad:#ff4d4d; --warn:#ffd24a;
      --shadow:0 14px 34px rgba(0,0,0,.35);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:radial-gradient(1200px 700px at 20% 0%, #162a66 0%, var(--bg) 55%);
      color:var(--text);
    }
    .top{
      position:sticky; top:0; z-index:5;
      background:linear-gradient(180deg, rgba(15,23,48,.92), rgba(15,23,48,.55));
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
      padding:14px 16px;
    }
    .bar{
      max-width:1240px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      display:flex; align-items:flex-start; gap:10px;
      min-width:220px;
    }
    .dot{width:12px;height:12px;border-radius:50%;background:var(--btn);box-shadow:0 0 0 4px rgba(42,102,255,.18)}
    .brand h1{margin:0;font-size:22px;line-height:1}
    .sub{margin:2px 0 0; font-size:12px; color:var(--muted)}
    .pills{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      border-radius:999px;
      padding:8px 12px;
      font-size:14px;
      display:flex; align-items:center; gap:8px;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.03);
    }
    .led{width:10px;height:10px;border-radius:50%; background:#666}
    .led.good{background:var(--good); box-shadow:0 0 18px rgba(57,255,122,.25)}
    .led.bad{background:var(--bad); box-shadow:0 0 18px rgba(255,77,77,.25)}
    .btn{
      border:0;
      border-radius:14px;
      padding:10px 14px;
      font-weight:700;
      color:white;
      cursor:pointer;
      background:linear-gradient(180deg,var(--btn),var(--btn2));
      box-shadow:var(--shadow);
    }
    .btn.gray{
      background:rgba(255,255,255,.08);
      border:1px solid var(--line);
      box-shadow:none;
      font-weight:650;
    }
    .btn.danger{
      background:linear-gradient(180deg,#ff5a5a,#d52a2a);
    }
    .wrap{
      max-width:1240px;
      margin:18px auto;
      padding:0 16px 22px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .brand{min-width:auto}
    }
    .card{
      border:1px solid var(--line);
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.15);
    }
    .cardHead h2{margin:0; font-size:18px}
    .small{font-size:13px;color:var(--muted)}
    .chatBody{
      padding:12px 14px;
      height:60vh;
      overflow:auto;
    }
    .msg{
      display:flex; gap:10px; margin:10px 0;
      align-items:flex-start;
    }
    .avatar{
      width:28px;height:28px;border-radius:10px;
      background:rgba(255,255,255,.08);
      border:1px solid var(--line);
      display:flex; align-items:center; justify-content:center;
      font-weight:800;
      color:var(--muted);
      flex:0 0 auto;
    }
    .bubble{
      max-width:820px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      border-radius:16px;
      padding:10px 12px;
      line-height:1.35;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .composer{
      padding:12px 14px;
      border-top:1px solid var(--line);
      background:rgba(0,0,0,.10);
    }
    .row{display:flex; gap:10px; align-items:flex-end}
    textarea{
      width:100%;
      min-height:48px;
      max-height:160px;
      resize:vertical;
      border-radius:14px;
      padding:12px 12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    .actions{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .chip{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:650;
    }
    .chip[disabled]{opacity:.45; cursor:not-allowed}
    .tags{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .tag{
      font-size:12px; color:var(--muted);
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      padding:6px 10px;
      border-radius:999px;
    }

    /* Preview */
    .previewBox{
      padding:12px 14px;
      height:calc(60vh + 144px);
    }
    .previewShell{
      position:relative;
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(0,0,0,.18);
      height:100%;
      overflow:hidden;
    }
    iframe{
      width:100%;
      height:100%;
      border:0;
      background:#fff;
    }
    /* SINGLE placeholder only (no duplicates) */
    #previewPlaceholder{
      position:absolute; inset:0;
      display:flex;
      align-items:center; justify-content:center;
      text-align:center;
      padding:24px;
      color:var(--muted);
      background:linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.35));
      pointer-events:none;
    }
    .phTitle{font-size:18px;color:var(--text); font-weight:800; margin-bottom:6px}
    .phSub{font-size:13px}

    /* Status banner for errors so you NEVER get “silent blank” */
    #fatal{
      display:none;
      position:fixed; left:16px; right:16px; bottom:16px;
      border:1px solid rgba(255,77,77,.45);
      background:rgba(20,0,0,.78);
      color:#ffd7d7;
      padding:12px 14px;
      border-radius:14px;
      z-index:9999;
      box-shadow:var(--shadow);
      white-space:pre-wrap;
      word-break:break-word;
    }
    #fatal strong{color:#fff}
  </style>
</head>
<body>
  <div class="top">
    <div class="bar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <h1>Simo</h1>
          <div class="sub">Checkpoint V1.B — stable UI • single-file • Pro gated • preview safe</div>
        </div>
      </div>

      <div class="pills">
        <button class="btn danger" id="btnReset" type="button">Reset</button>

        <div class="pill" title="Connection">
          <span class="led good" id="led"></span>
          <span id="statusTxt">Ready</span>
        </div>

        <div class="pill" title="Mode">
          <span class="led good"></span>
          <span>Mode:</span>
          <strong id="modeTxt">solving</strong>
          <button class="btn gray" id="btnMode" type="button">Change</button>
        </div>

        <div class="pill" title="Pro">
          <span class="led bad" id="proLed"></span>
          <span>Pro:</span>
          <strong id="proTxt">OFF</strong>
        </div>

        <button class="btn" id="btnUnlock" type="button">Unlock Pro</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- Chat -->
      <section class="card">
        <div class="cardHead">
          <h2>Chat</h2>
          <div class="small" id="chatState">Ready</div>
        </div>

        <div class="chatBody" id="chat"></div>

        <div class="composer">
          <div class="row">
            <textarea id="input" placeholder="Type here..."></textarea>
            <button class="btn send" id="btnSend" type="button">Send</button>
          </div>

          <div class="actions">
            <button class="chip" id="btnPreview" type="button">Preview</button>
            <button class="chip" id="btnDownload" type="button">Download</button>
            <button class="chip" id="btnSave" type="button" disabled>Save</button>
            <button class="chip" id="btnLibrary" type="button" disabled>Library</button>
          </div>

          <div class="tags">
            <div class="tag" id="tagTopic">topic: general</div>
            <div class="tag" id="tagPreview">preview: locked</div>
          </div>

          <div class="small" style="margin-top:8px;">Enter to send • Shift+Enter for new line</div>
        </div>
      </section>

      <!-- Preview -->
      <section class="card">
        <div class="cardHead">
          <h2>Preview</h2>
          <div class="small" id="previewState">Updated: —</div>
        </div>

        <div class="previewBox">
          <div class="previewShell">
            <iframe id="previewFrame" title="preview"></iframe>
            <div id="previewPlaceholder">
              <div>
                <div class="phTitle">No preview yet.</div>
                <div class="phSub">Ask for a build like “make me a landing page…” then hit Preview.</div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <div id="fatal"></div>

  <script>
  (() => {
    // ======= SAFETY: show fatal errors (prevents silent blank) =======
    const fatal = (msg) => {
      const el = document.getElementById('fatal');
      el.style.display = 'block';
      el.innerHTML = "<strong>UI Error:</strong>\\n" + String(msg || "unknown");
    };
    window.addEventListener('error', (e) => fatal(e?.message || e));
    window.addEventListener('unhandledrejection', (e) => fatal(e?.reason || e));

    // ======= STATE =======
    const $ = (id) => document.getElementById(id);
    const chat = $('chat');
    const input = $('input');
    const led = $('led');
    const statusTxt = $('statusTxt');
    const chatState = $('chatState');
    const modeTxt = $('modeTxt');
    const proLed = $('proLed');
    const proTxt = $('proTxt');
    const tagPreview = $('tagPreview');
    const btnSave = $('btnSave');
    const btnLibrary = $('btnLibrary');
    const previewFrame = $('previewFrame');
    const previewPlaceholder = $('previewPlaceholder');
    const previewState = $('previewState');

    const API = "/.netlify/functions/simon";
    let MODE = "solving";
    let TOPIC = "general";
    let PRO = false;

    let lastHTML = "";
    let library = [];

    // ======= STORAGE =======
    const load = () => {
      try{
        PRO = localStorage.getItem("simo_pro") === "1";
        lastHTML = localStorage.getItem("simo_last_html") || "";
        library = JSON.parse(localStorage.getItem("simo_library") || "[]");
      }catch(e){}
    };
    const save = () => {
      try{
        localStorage.setItem("simo_pro", PRO ? "1" : "0");
        localStorage.setItem("simo_last_html", lastHTML || "");
        localStorage.setItem("simo_library", JSON.stringify(library || []));
      }catch(e){}
    };

    // ======= UI HELPERS =======
    const setStatus = (ok, text) => {
      led.classList.toggle("good", !!ok);
      led.classList.toggle("bad", !ok);
      statusTxt.textContent = text || (ok ? "Ready" : "Error");
      chatState.textContent = statusTxt.textContent;
    };

    const setProUI = () => {
      proLed.classList.toggle("good", PRO);
      proLed.classList.toggle("bad", !PRO);
      proTxt.textContent = PRO ? "ON" : "OFF";
      tagPreview.textContent = PRO ? "preview: unlocked" : "preview: locked";
      btnSave.disabled = !PRO;
      btnLibrary.disabled = !PRO;
    };

    const addMsg = (who, text) => {
      const row = document.createElement("div");
      row.className = "msg";
      const av = document.createElement("div");
      av.className = "avatar";
      av.textContent = who === "user" ? "U" : "S";
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = text;
      row.appendChild(av);
      row.appendChild(bubble);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
    };

    const renderPreview = (html) => {
      // SINGLE source of truth: toggle placeholder, set iframe srcdoc.
      if (!html) {
        previewFrame.srcdoc = "";
        previewPlaceholder.style.display = "flex";
        previewState.textContent = "Updated: —";
        return;
      }
      previewPlaceholder.style.display = "none";
      previewFrame.srcdoc = html;
      previewState.textContent = "Updated: " + new Date().toLocaleTimeString();
    };

    const downloadHTML = (html) => {
      const blob = new Blob([html || ""], {type:"text/html"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "simo_preview.html";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
    };

    // ======= BACKEND CALL =======
    async function callSimo(userText){
      setStatus(true, "Thinking…");
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), 15000);

      try{
        const r = await fetch(API, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ mode: MODE, topic: TOPIC, input: userText }),
          signal: ctrl.signal
        });

        const raw = await r.text();

        let data;
        try { data = JSON.parse(raw); } catch { data = { ok:false, raw }; }

        if (!r.ok || data?.ok === false){
          setStatus(false, "Backend error");
          addMsg("simo", "Backend error. Check Netlify function logs.\\n" + (data?.error || raw.slice(0,240)));
          return { ok:false };
        }

        // expected shape: { ok:true, message:"...", html:"..." }
        const msg = data.message || data.output || data.text || "…";
        addMsg("simo", msg);

        // accept html if present
        if (typeof data.html === "string" && data.html.trim()){
          lastHTML = data.html.trim();
          save();
          // Only update preview when user taps Preview (prevents “random preview changes”)
        }

        setStatus(true, "Ready");
        return { ok:true, data };

      }catch(e){
        setStatus(false, "Network error");
        addMsg("simo", "Network error: " + (e?.name || "") + " " + (e?.message || e));
        return { ok:false };
      }finally{
        clearTimeout(t);
      }
    }

    // ======= ACTIONS =======
    const resetAll = () => {
      chat.innerHTML = "";
      addMsg("simo", "Reset. I’m here.");
      setStatus(true, "Ready");
      // keep PRO state, keep library; clear preview only
      renderPreview("");
    };

    const cycleMode = () => {
      MODE = (MODE === "venting") ? "solving" : (MODE === "solving") ? "building" : "venting";
      modeTxt.textContent = MODE;
    };

    // ======= EVENTS (single bind) =======
    $('btnSend').addEventListener("click", () => send());
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        send();
      }
    });

    function send(){
      const text = (input.value || "").trim();
      if (!text) return;
      input.value = "";
      addMsg("user", text);
      callSimo(text);
    }

    $('btnReset').addEventListener("click", resetAll);
    $('btnMode').addEventListener("click", cycleMode);

    $('btnPreview').addEventListener("click", () => {
      // Always deterministic: show lastHTML only
      renderPreview(lastHTML);
      if (!lastHTML){
        addMsg("simo", "No HTML cached yet. Ask for a build first (example: “build a landing page for a fitness coach”).");
      }
    });

    $('btnDownload').addEventListener("click", () => {
      if (!lastHTML){
        addMsg("simo", "Nothing to download yet. Build something first.");
        return;
      }
      downloadHTML(lastHTML);
    });

    $('btnSave').addEventListener("click", () => {
      if (!PRO) return;
      if (!lastHTML){
        addMsg("simo", "Nothing to save yet. Build something first.");
        return;
      }
      const item = { id: crypto.randomUUID?.() || String(Date.now()), ts: Date.now(), title: "Saved build " + new Date().toLocaleString(), html: lastHTML };
      library.unshift(item);
      library = library.slice(0, 50);
      save();
      addMsg("simo", "Saved to Library.");
    });

    $('btnLibrary').addEventListener("click", () => {
      if (!PRO) return;
      if (!library.length){
        addMsg("simo", "Library is empty.");
        return;
      }
      const list = library.slice(0, 8).map((x,i)=>`${i+1}) ${x.title}`).join("\\n");
      addMsg("simo", "Library:\\n" + list + "\\n\\nType: load 1 (or 2, 3...)");
    });

    // simple "load n" command handled client-side before sending to backend
    async function interceptLoad(text){
      const m = text.match(/^load\\s+(\\d+)$/i);
      if (!m) return false;
      if (!PRO){
        addMsg("simo", "Library is Pro-only.");
        return true;
      }
      const n = Math.max(1, parseInt(m[1],10));
      const item = library[n-1];
      if (!item){
        addMsg("simo", "Not found.");
        return true;
      }
      lastHTML = item.html || "";
      save();
      addMsg("simo", "Loaded: " + item.title + " (tap Preview)");
      return true;
    }

    // wrap send to intercept load
    const origSend = send;
    send = function(){
      const text = (input.value || "").trim();
      if (!text) return;
      input.value = "";
      addMsg("user", text);
      interceptLoad(text).then((handled)=>{
        if (!handled) callSimo(text);
      });
    };

    // ======= INIT =======
    load();
    $('tagTopic').textContent = "topic: " + TOPIC;
    modeTxt.textContent = MODE;
    setProUI();
    resetAll();

    $('btnUnlock').addEventListener("click", async () => {
      const key = prompt("Enter Pro key:");
      if (!key) return;
      // your existing pro function
      try{
        const r = await fetch("/.netlify/functions/pro", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ key })
        });
        const j = await r.json();
        PRO = !!j?.pro;
        save();
        setProUI();
        addMsg("simo", PRO ? "Pro unlocked." : "Invalid key.");
      }catch(e){
        addMsg("simo", "Pro check failed.");
      }
    });
  })();
  </script>
</body>
</html>
