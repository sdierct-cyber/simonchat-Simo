<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simo</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg:#0b1020; --text:#eaf0ff; --muted:#a9b6d3;
      --line:rgba(255,255,255,.10);
      --btn:#2a66ff; --btn2:#1f4dd6;
      --good:#39ff7a;
      --shadow:0 14px 34px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:radial-gradient(1200px 700px at 20% 0%, #162a66 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .header{display:flex;align-items:flex-start;justify-content:space-between;gap:14px;margin-bottom:14px}
    .brand{display:flex;gap:10px;align-items:center}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--good);box-shadow:0 0 16px rgba(57,255,122,.55)}
    .brand h1{margin:0;font-size:20px;line-height:1.1}
    .sub{color:var(--muted);font-weight:800;font-size:12px;margin-top:2px}
    .toggles{display:flex;gap:10px;align-items:center}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      color:var(--text); font-weight:950; font-size:12px;
      cursor:pointer; user-select:none;
    }
    .pill .pDot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.35)}
    .pill.on{
      border-color:rgba(57,255,122,.35);
      background:rgba(57,255,122,.12);
      box-shadow:0 0 0 2px rgba(57,255,122,.08) inset, 0 10px 26px rgba(0,0,0,.28);
    }
    .pill.on .pDot{background:var(--good); box-shadow:0 0 14px rgba(57,255,122,.65)}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .panel{
      border:1px solid var(--line);
      border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.14));
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height:620px;
    }
    .panelTop{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 16px;border-bottom:1px solid var(--line);
    }
    .panelTop .title{font-weight:1000}
    .panelTop .rightNote{color:var(--muted);font-weight:900;font-size:12px}

    .chatBody{padding:14px 16px;display:flex;flex-direction:column;height:calc(100% - 58px)}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    .btn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      color:var(--text);
      border-radius:999px;
      padding:9px 12px;
      font-weight:950;font-size:12px;
      cursor:pointer;
    }
    .btn.locked{opacity:.55; cursor:not-allowed}
    .log{
      flex:1;
      border:1px dashed rgba(255,255,255,.12);
      border-radius:16px;
      padding:12px;
      overflow:auto;
      background:rgba(0,0,0,.10);
    }
    .msg{margin:0 0 10px;line-height:1.45}
    .msg .who{font-weight:1000}
    .msg .txt{font-weight:800}
    .composer{
      display:flex;gap:10px;margin-top:12px;
      border-top:1px solid var(--line);padding-top:12px;
    }
    textarea{
      flex:1; resize:none;
      height:56px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:12px;
      font-weight:850;
      outline:none;
    }
    .send{
      width:120px;
      border-radius:16px;
      border:2px solid rgba(255,255,255,.18);
      background:linear-gradient(180deg, var(--btn), var(--btn2));
      color:#fff;font-weight:1000;
      cursor:pointer;
    }
    .send:disabled{opacity:.65; cursor:not-allowed}

    .previewBody{padding:12px 12px 16px}
    .previewHeader{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 12px;border:1px solid var(--line);
      border-radius:16px 16px 0 0;
      background:rgba(0,0,0,.20);
      font-weight:950;
    }
    .frameWrap{
      border:1px solid var(--line);
      border-top:none;
      border-radius:0 0 16px 16px;
      overflow:hidden;
      background:rgba(255,255,255,.04);
      height:540px;
    }
    iframe{width:100%;height:100%;border:0;background:#0b1020}
    .muted{color:var(--muted);font-weight:850}
    .small{font-size:12px}
    .badgeLock{margin-left:6px;opacity:.85}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <h1>Simo</h1>
          <div class="sub">Checkpoint V1 ‚Äî stable chat + preview + Pro gating</div>
        </div>
      </div>

      <div class="toggles">
        <div id="freePill" class="pill on" role="button" aria-label="Free">
          <span class="pDot"></span> Free <span class="muted">$0</span>
        </div>
        <div id="proPill" class="pill" role="button" aria-label="Pro">
          <span class="pDot"></span> Pro <span class="muted">$19</span>
        </div>
      </div>
    </div>

    <div class="grid">
      <section class="panel">
        <div class="panelTop">
          <div class="title">Chat</div>
          <div class="rightNote" id="statusDot">Ready</div>
        </div>

        <div class="chatBody">
          <div class="controls">
            <button id="resetBtn" class="btn">Reset</button>
            <button id="saveBtn" class="btn locked">Save <span class="badgeLock">üîí</span></button>
            <button id="downloadBtn" class="btn locked">Download <span class="badgeLock">üîí</span></button>
            <button id="libraryBtn" class="btn locked">Library <span class="badgeLock">üîí</span></button>
          </div>

          <div id="log" class="log" aria-live="polite">
            <p class="msg simo"><span class="who">Simo:</span> <span class="txt">Reset. I‚Äôm here.</span></p>
          </div>

          <div class="composer">
            <textarea id="input" placeholder="Enter to send ‚Ä¢ Shift+Enter for new line"></textarea>
            <button id="sendBtn" class="send">Send</button>
          </div>
        </div>
      </section>

      <section class="panel">
        <div class="panelTop">
          <div class="title">Preview</div>
          <div class="rightNote">HTML / cover / updates render here</div>
        </div>

        <div class="previewBody">
          <div class="previewHeader">
            <div id="previewTitle">Idle</div>
            <div class="muted small" id="previewMeta">No preview yet</div>
          </div>
          <div class="frameWrap">
            <iframe id="previewFrame" title="Preview frame"></iframe>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const state = {
      tier: "free",
      conversation: [],
      lastPreview: null,
      lastSavedHtml: null,
      isBusy: false,
    };

    function idlePreviewDoc() {
      return `<!doctype html><html><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
  html,body{height:100%;margin:0}
  body{display:grid;place-items:center;font-family:system-ui;background:#0b1020;color:#a9b6d3}
  .box{border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:18px 16px;background:rgba(255,255,255,.04);text-align:center;max-width:360px}
  b{color:#eaf0ff}
</style></head>
<body><div class="box"><b>No preview yet</b><div style="height:6px"></div>
Ask: ‚Äúbuild a landing page for a fitness coach‚Äù</div></body></html>`;
    }

    function setBusy(on) {
      state.isBusy = !!on;
      $("sendBtn").disabled = state.isBusy;
      $("statusDot").textContent = state.isBusy ? "Thinking‚Ä¶" : "Ready";
    }

    function setTier(tier) {
      state.tier = tier === "pro" ? "pro" : "free";
      $("freePill").classList.toggle("on", state.tier === "free");
      $("proPill").classList.toggle("on", state.tier === "pro");

      const proOn = state.tier === "pro";
      ["saveBtn","downloadBtn","libraryBtn"].forEach((id) => {
        const b = $(id);
        b.classList.toggle("locked", !proOn);
        b.innerHTML = proOn
          ? b.textContent.replace("üîí","").trim()
          : (b.textContent.replace("üîí","").trim() + ' <span class="badgeLock">üîí</span>');
      });
    }

    function addMsg(role, text) {
      const p = document.createElement("p");
      p.className = "msg " + (role === "user" ? "user" : "simo");
      p.innerHTML = '<span class="who">'+(role==="user"?"You:":"Simo:")+
        '</span> <span class="txt"></span>';
      p.querySelector(".txt").textContent = text || "";
      $("log").appendChild(p);
      $("log").scrollTop = $("log").scrollHeight;

      state.conversation.push({ role, content: String(text || "") });
      if (state.conversation.length > 30) state.conversation = state.conversation.slice(-30);
    }

    function setPreview(preview) {
      if (!preview || !preview.html) return;
      state.lastPreview = preview;
      $("previewTitle").textContent = preview.title || "Preview";
      $("previewMeta").textContent = preview.meta || "Updated";
      $("previewFrame").srcdoc = preview.html;
      state.lastSavedHtml = preview.html;
    }

    // -------- Local deterministic landing preview ----------
    function looksLikePreviewAsk(text) {
      const x = (text||"").toLowerCase().trim();
      return (
        x.includes("landing page") ||
        x.includes("marketing page") ||
        x.includes("show me a preview") ||
        x.startsWith("preview") ||
        x.startsWith("build a landing page") ||
        x.startsWith("build me a landing page") ||
        x.includes("make a landing page") ||
        x.includes("create a landing page")
      );
    }
    function extractTopic(text) {
      const t = (text||"").toLowerCase();
      const m =
        t.match(/landing page for (a|an)\s+(.+?)(\.|$)/i) ||
        t.match(/page for (a|an)\s+(.+?)(\.|$)/i) ||
        t.match(/for (a|an)\s+(.+?)(\.|$)/i);
      if (m && m[2]) return (m[2]||"").trim().replace(/\.$/,"");
      if ((text||"").trim().length <= 40) return (text||"").trim();
      return "your offer";
    }
    function sanitize(s){
      return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
    }
    function localLandingHTML(topic){
      const T = sanitize(topic);
      const H = sanitize(`${topic} ‚Äî made simple`);
      return `<!doctype html><html lang="en"><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="color-scheme" content="dark"/>
<title>Simo ‚Äî Landing Page</title>
<style>
:root{--bg:#0b1020;--text:#eaf0ff;--muted:#a9b6d3;--line:rgba(255,255,255,.12);--pro:#39ff7a;--shadow:0 12px 28px rgba(0,0,0,.35)}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;font-family:system-ui;background:radial-gradient(1200px 700px at 20% 0%, #162a66 0%, var(--bg) 55%);color:var(--text)}
.wrap{max-width:980px;margin:0 auto;padding:22px}
.top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:6px 0 18px}
.brand{display:flex;align-items:center;gap:10px;font-weight:900}
.dot{width:10px;height:10px;border-radius:99px;background:var(--pro);box-shadow:0 0 18px rgba(57,255,122,.6)}
.tag{font-size:12px;color:var(--muted);font-weight:800}
.hero{border:1px solid var(--line);border-radius:22px;background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));box-shadow:var(--shadow);padding:22px}
h1{margin:8px 0 10px;font-size:54px;line-height:1.02;letter-spacing:-.02em}
p{color:var(--muted);font-weight:700;line-height:1.5;font-size:16px}
.ctaRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
.btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 14px;border-radius:14px;font-weight:950;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:var(--text);text-decoration:none}
.btn.primary{border-color:rgba(57,255,122,.25);background:rgba(57,255,122,.14);box-shadow:0 10px 20px rgba(0,0,0,.25)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
@media (max-width:860px){h1{font-size:44px}.grid{grid-template-columns:1fr}}
.card{border:1px solid var(--line);border-radius:18px;background:rgba(0,0,0,.18);padding:16px}
.card h3{margin:0 0 6px;font-size:18px}.card p{margin:0}
</style></head>
<body><div class="wrap">
<div class="top"><div class="brand"><span class="dot"></span> <span>Simo</span></div>
<div class="tag">Local preview ‚Ä¢ topic: ${T}</div></div>
<div class="hero">
<div class="tag">Simo Preview</div>
<h1>${H}</h1>
<p>A clean landing page you can export as HTML. Ask me to change sections, CTA, or copy.</p>
<div class="ctaRow"><a class="btn primary" href="#">Get Started</a><a class="btn" href="#">Learn More</a></div>
<div class="grid" style="margin-top:18px"><div class="card"><h3>Fast</h3><p>Clean structure that converts.</p></div>
<div class="card"><h3>Clear</h3><p>Headline ‚Üí value ‚Üí call-to-action.</p></div></div>
</div></div></body></html>`;
    }
    // ------------------------------------------------------

    // -------- Local best-friend fallback (NO "try again") --------
    function localBestFriendFallback(userText) {
      const x = (userText||"").toLowerCase();
      if (x.includes("im stressed") || x.includes("i'm stressed") || x.includes("stressed out")) {
        return "I got you. What‚Äôs the main source ‚Äî work, money, relationship, or just everything stacking? Give me the headline and I‚Äôll help you cut it down.";
      }
      if (x.includes("anxious") || x.includes("panic")) {
        return "Okay. In 4‚Ä¶ hold 2‚Ä¶ out 6. Do that twice. Now: what triggered it in the last 10 minutes?";
      }
      if (x.includes("sad") || x.includes("depressed")) {
        return "I‚Äôm here. What happened today that hit you the hardest? One sentence.";
      }
      if (x.includes("angry") || x.includes("pissed") || x.includes("mad")) {
        return "Alright. What crossed the line? Tell me the one thing that set you off.";
      }
      return "I‚Äôm here. Tell me what you want right now ‚Äî venting, solving, or building.";
    }
    // ------------------------------------------------------------

    async function callBackend(text, timeoutMs) {
      const payload = {
        text,
        tier: state.tier,
        conversation: state.conversation,
        lastPreview: state.lastPreview
      };

      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), timeoutMs);

      try {
        const res = await fetch("/.netlify/functions/simon", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(payload),
          signal: controller.signal,
        });

        const data = await res.json().catch(() => ({}));
        return data;
      } finally {
        clearTimeout(timeout);
      }
    }

    async function send() {
      const text = $("input").value.trim();
      if (!text || state.isBusy) return;

      addMsg("user", text);
      $("input").value = "";

      // Instant preview for landing pages
      if (looksLikePreviewAsk(text)) {
        const topic = extractTopic(text);
        setPreview({ kind:"html", title:"Landing page", meta:"Instant (local)", html: localLandingHTML(topic) });
        addMsg("assistant", "Done. I updated the preview on the right.");
      }

      setBusy(true);

      try {
        const isPrev = looksLikePreviewAsk(text);

        // IMPORTANT: longer timeout for chat at work
        const timeoutMs = isPrev ? 25000 : 25000;

        const data = await callBackend(text, timeoutMs);

        // If server gives a reply, use it
        if (data && typeof data.text === "string" && data.text.trim()) {
          addMsg("assistant", data.text.trim());
        } else {
          // If server returns but empty, still don't dead-end
          addMsg("assistant", localBestFriendFallback(text));
        }

        // If server returns preview, it overwrites local (fine)
        if (data && data.preview && data.preview.kind === "html") {
          setPreview(data.preview);
        }
      } catch (err) {
        // THIS is the fix: never show "try again" for venting
        addMsg("assistant", localBestFriendFallback(text));
      } finally {
        setBusy(false);
      }
    }

    function reset() {
      state.conversation = [];
      state.lastPreview = null;
      state.lastSavedHtml = null;
      $("log").innerHTML = "";
      addMsg("assistant", "Reset. I‚Äôm here.");
      $("previewTitle").textContent = "Idle";
      $("previewMeta").textContent = "No preview yet";
      $("previewFrame").srcdoc = idlePreviewDoc();
    }

    $("sendBtn").addEventListener("click", send);
    $("resetBtn").addEventListener("click", reset);
    $("freePill").addEventListener("click", () => setTier("free"));
    $("proPill").addEventListener("click", () => setTier("pro"));

    $("input").addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

    ["saveBtn","downloadBtn","libraryBtn"].forEach((id) => {
      $(id).addEventListener("click", () => {
        if (state.tier !== "pro") {
          addMsg("assistant", "That‚Äôs a Pro feature üîí (toggle Pro top-right).");
          return;
        }
        addMsg("assistant", "Pro feature placeholder ‚Äî we‚Äôll wire this next.");
      });
    });

    setTier("free");
    $("previewFrame").srcdoc = idlePreviewDoc();
  </script>
</body>
</html>
