<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simo</title>
  <style>
    :root{
      --bg:#0b1020; --text:#eaf0ff; --muted:#a9b6d3;
      --line:rgba(255,255,255,.10);
      --btn:#2a66ff; --btn2:#1f4dd6;
      --bad:#ff4d4d; --good:#39d98a;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:radial-gradient(1200px 700px at 20% 0%, #162a66 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:40px;height:40px;border-radius:14px;background:linear-gradient(145deg,#2a66ff,#5aa5ff);box-shadow:0 12px 30px rgba(42,102,255,.25)}
    .title{font-size:16px;font-weight:800;line-height:1.1}
    .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      font-size:12px;padding:8px 10px;border:1px solid var(--line);border-radius:999px;
      background:rgba(255,255,255,.04);color:var(--muted);display:flex;gap:10px;align-items:center;
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.good{background:var(--good)}
    .dot.bad{background:var(--bad)}
    .card{
      border:1px solid var(--line);border-radius:18px;overflow:hidden;
      background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
      box-shadow:0 16px 50px rgba(0,0,0,.28)
    }
    .head{
      padding:12px 14px;border-bottom:1px solid var(--line);background:rgba(255,255,255,.02);
      display:flex;align-items:center;justify-content:space-between;gap:12px
    }
    .head h2{margin:0;font-size:13px;letter-spacing:.2px}
    .mini{font-size:12px;color:var(--muted)}
    .stamp{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .chat{
      height:520px;overflow:auto;padding:14px;display:flex;flex-direction:column;gap:10px;
      background:linear-gradient(180deg,rgba(0,0,0,.08),rgba(0,0,0,.12))
    }
    .msg{max-width:82%;padding:10px 12px;border-radius:14px;border:1px solid var(--line);white-space:pre-wrap}
    .msg.you{align-self:flex-end;background:rgba(42,102,255,.18);border-color:rgba(42,102,255,.25)}
    .msg.simo{align-self:flex-start;background:rgba(255,255,255,.05)}
    .row{display:flex;gap:10px;padding:12px;border-top:1px solid var(--line);background:rgba(255,255,255,.02)}
    textarea{
      flex:1;resize:none;min-height:44px;max-height:140px;padding:10px 12px;border-radius:14px;
      border:1px solid var(--line);background:rgba(0,0,0,.18);color:var(--text);outline:none
    }
    button{
      border:0;border-radius:14px;padding:0 14px;min-width:110px;font-weight:800;
      background:linear-gradient(180deg,var(--btn),var(--btn2));color:white;cursor:pointer;
      box-shadow:0 12px 26px rgba(42,102,255,.25)
    }
    button:disabled{opacity:.55;cursor:not-allowed}
    .ghostBtn{
      min-width:120px;
      background:rgba(255,255,255,.10);
      color:var(--text);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:none;
    }
    .ghostBtn:hover{background:rgba(255,255,255,.14)}
    /* Preview modal */
    #previewModal{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.65); padding:18px; z-index:9999;
    }
    #previewModal .panel{
      width:min(1000px, 96vw); height:min(680px, 92vh);
      background:rgba(20,30,60,.96);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px; overflow:hidden;
      box-shadow:0 24px 70px rgba(0,0,0,.55);
      display:flex; flex-direction:column;
    }
    #previewModal .bar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.12);
    }
    #previewModal select{
      background:rgba(255,255,255,.08);
      color:#eaf0ff;
      border:1px solid rgba(255,255,255,.14);
      border-radius:12px;
      padding:8px 10px;
    }
    #previewModal iframe{
      flex:1; width:100%; border:0; background:#0b1020;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">Simo</div>
          <div class="sub">Core chat (stable) — preview is isolated (won’t break chat)</div>
        </div>
      </div>

      <div class="right">
        <button id="previewBtn" type="button" class="ghostBtn">Preview</button>

        <div class="pill">
          <span class="dot bad" id="dot"></span>
          <span id="status">Offline (not calling API)</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="head">
        <h2>Chat</h2>
        <div class="mini stamp">BUILD: SIMO_CORE_V1_2026-02-11B + PREVIEW_MODAL_V2 (NO DUP LISTENERS)</div>
      </div>

      <div class="chat" id="chat"></div>

      <div class="row">
        <textarea id="input" placeholder="Type here… (Enter to send, Shift+Enter new line)"></textarea>
        <button id="send" type="button">Send</button>
      </div>
    </div>
  </div>

  <!-- PREVIEW MODAL (frontend-only; does NOT touch chat handlers) -->
  <div id="previewModal" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-label="App Preview">
      <div class="bar">
        <div style="font-weight:900;">App Preview</div>
        <div style="display:flex; gap:10px; align-items:center;">
          <select id="previewSelect" aria-label="Select preview">
            <option value="space">Space Renting (Driveway/Extra Space)</option>
            <option value="bakery">Bakery App (Menu + Order)</option>
            <option value="landing">Simple Landing Page</option>
          </select>

          <button id="closePreviewBtn" type="button" class="ghostBtn" style="min-width:140px;">
            Back to chat
          </button>
        </div>
      </div>

      <iframe id="previewFrame" title="Preview"></iframe>
    </div>
  </div>

  <script>
    // ==========================
    // SIMO CORE (STABLE)
    // ==========================
    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const send = document.getElementById("send");
    const dot = document.getElementById("dot");
    const status = document.getElementById("status");

    function add(role, text) {
      const d = document.createElement("div");
      d.className = "msg " + (role === "you" ? "you" : "simo");
      d.textContent = text;
      chat.appendChild(d);
      chat.scrollTop = chat.scrollHeight;
    }

    function setOnline(on, text){
      dot.classList.remove("good","bad");
      dot.classList.add(on ? "good" : "bad");
      status.textContent = text;
    }

    function autoGrow() {
      input.style.height = "auto";
      input.style.height = Math.min(input.scrollHeight, 140) + "px";
    }

    async function callBackend(message){
      const res = await fetch("/api/simon", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ message })
      });

      if (!res.ok) {
        const t = await res.text().catch(()=> "");
        throw new Error(`API HTTP ${res.status} ${res.statusText}${t ? " — " + t.slice(0,140) : ""}`);
      }

      const data = await res.json().catch(()=> ({}));
      return data.reply || data.text || "Hey — I’m Simo. What’s going on?";
    }

    // ==========================
    // PREVIEW MODAL (ISOLATED)
    // ==========================
    const previewModal = document.getElementById("previewModal");
    const previewBtn = document.getElementById("previewBtn");
    const closePreviewBtn = document.getElementById("closePreviewBtn");
    const previewSelect = document.getElementById("previewSelect");
    const previewFrame = document.getElementById("previewFrame");

    const templates = {
      space: `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
        <title>SpaceRent — Preview</title>
        <style>
          body{margin:0;font-family:system-ui;background:#0b1020;color:#eaf0ff}
          .wrap{max-width:1000px;margin:0 auto;padding:16px}
          .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
          @media(max-width:900px){.grid{grid-template-columns:1fr}}
          .card{border:1px solid rgba(255,255,255,.12);border-radius:16px;background:rgba(255,255,255,.05);overflow:hidden}
          .head{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.10);font-weight:900}
          .pad{padding:12px 14px}
          .row{display:flex;gap:10px;flex-wrap:wrap}
          input{flex:1;min-width:220px;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.25);color:#eaf0ff}
          .chip{padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);font-size:12px}
          .list{display:flex;flex-direction:column;gap:10px}
          .item{border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:12px;background:rgba(0,0,0,.18)}
          .price{font-weight:950}
          .muted{color:rgba(234,240,255,.70);font-size:12px}
          .map{height:220px;border-top:1px solid rgba(255,255,255,.10);background:linear-gradient(135deg,rgba(42,102,255,.25),rgba(0,0,0,.2));
               display:flex;align-items:center;justify-content:center;color:rgba(234,240,255,.80)}
          button{padding:10px 12px;border-radius:12px;border:0;background:linear-gradient(180deg,#2a66ff,#1f4dd6);color:#fff;font-weight:900;cursor:pointer}
        </style></head>
        <body><div class="wrap">
          <div class="card">
            <div class="head">Search</div>
            <div class="pad">
              <div class="row">
                <input placeholder="Search city / ZIP (e.g., 48044)" />
                <button>Search</button>
              </div>
              <div class="row" style="margin-top:10px">
                <div class="chip">Driveway</div><div class="chip">Garage</div><div class="chip">Storage</div>
                <div class="chip">Under $10/day</div><div class="chip">EV-friendly</div>
              </div>
            </div>
            <div class="grid" style="padding:14px">
              <div class="card">
                <div class="head">Listings</div>
                <div class="pad list">
                  <div class="item"><div class="price">$8/day · Driveway Spot</div><div class="muted">0.4 mi · Available today · 6am–10pm</div></div>
                  <div class="item"><div class="price">$12/day · Covered Spot</div><div class="muted">1.2 mi · Available Fri–Sun · 24/7 access</div></div>
                  <div class="item"><div class="price">$20/day · Storage Corner</div><div class="muted">2.0 mi · Weekly only · Secure area</div></div>
                </div>
              </div>
              <div class="card">
                <div class="head">Booking</div>
                <div class="pad">
                  <div class="muted">Selected: Driveway Spot</div>
                  <div class="row" style="margin-top:10px">
                    <input placeholder="Start date" />
                    <input placeholder="End date" />
                  </div>
                  <div class="row" style="margin-top:10px">
                    <button style="width:100%">Reserve</button>
                  </div>
                  <div class="muted" style="margin-top:10px">Map placeholder:</div>
                </div>
                <div class="map">MAP (Preview)</div>
              </div>
            </div>
          </div>
        </div></body></html>`,

      bakery: `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
        <title>Bakery — Preview</title>
        <style>
          body{margin:0;font-family:system-ui;background:#0b1020;color:#eaf0ff}
          .wrap{max-width:980px;margin:0 auto;padding:16px}
          .grid{display:grid;grid-template-columns:1fr .9fr;gap:14px}
          @media(max-width:900px){.grid{grid-template-columns:1fr}}
          .card{border:1px solid rgba(255,255,255,.12);border-radius:16px;background:rgba(255,255,255,.05);overflow:hidden}
          .head{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.10);font-weight:950}
          .pad{padding:12px 14px}
          .row{display:flex;gap:10px;flex-wrap:wrap}
          input{flex:1;min-width:220px;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.25);color:#eaf0ff}
          .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
          .chip{padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);font-size:12px}
          .menu{display:flex;flex-direction:column;gap:10px}
          .item{border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:12px;background:rgba(0,0,0,.18);display:flex;justify-content:space-between;gap:10px;align-items:center}
          .name{font-weight:950}
          .muted{color:rgba(234,240,255,.70);font-size:12px}
          button{padding:10px 12px;border-radius:12px;border:0;background:linear-gradient(180deg,#2a66ff,#1f4dd6);color:#fff;font-weight:900;cursor:pointer}
          .total{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
        </style></head>
        <body><div class="wrap">
          <div class="card">
            <div class="head">Bakery App Preview</div>
            <div class="pad">
              <div class="row">
                <input placeholder="Search items (croissant, sourdough…)" />
                <button>Search</button>
              </div>
              <div class="chips">
                <div class="chip">Bread</div><div class="chip">Pastries</div><div class="chip">Cakes</div><div class="chip">Coffee</div><div class="chip">Gluten-free</div>
              </div>
            </div>

            <div class="grid" style="padding:14px">
              <div class="card">
                <div class="head">Menu</div>
                <div class="pad menu">
                  <div class="item"><div><div class="name">Sourdough Loaf</div><div class="muted">Fresh daily · 2lb</div></div><div><div class="name">$8</div><button style="margin-top:6px">Add</button></div></div>
                  <div class="item"><div><div class="name">Butter Croissant</div><div class="muted">Flaky · best-seller</div></div><div><div class="name">$4</div><button style="margin-top:6px">Add</button></div></div>
                  <div class="item"><div><div class="name">Chocolate Cake Slice</div><div class="muted">Rich · dark cocoa</div></div><div><div class="name">$6</div><button style="margin-top:6px">Add</button></div></div>
                </div>
              </div>

              <div class="card">
                <div class="head">Cart</div>
                <div class="pad">
                  <div class="muted">2 items</div>
                  <div class="item" style="margin-top:10px"><div><div class="name">Sourdough Loaf</div><div class="muted">Qty: 1</div></div><div class="name">$8</div></div>
                  <div class="item"><div><div class="name">Butter Croissant</div><div class="muted">Qty: 1</div></div><div class="name">$4</div></div>
                  <div class="total"><div class="name">Total</div><div class="name">$12</div></div>
                  <button style="width:100%;margin-top:10px">Checkout</button>
                </div>
              </div>
            </div>
          </div>
        </div></body></html>`,

      landing: `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
        <title>Landing — Preview</title>
        <style>
          body{margin:0;font-family:system-ui;background:#0b1020;color:#eaf0ff}
          .hero{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;
            background:radial-gradient(1200px 700px at 20% 0%, #162a66 0%, #0b1020 55%);}
          .card{max-width:820px;border:1px solid rgba(255,255,255,.12);border-radius:20px;background:rgba(255,255,255,.05);padding:18px}
          .h{font-size:34px;font-weight:950;line-height:1.05;margin:0}
          .p{color:rgba(234,240,255,.75);margin:10px 0 16px;line-height:1.4}
          button{padding:12px 14px;border-radius:14px;border:0;background:linear-gradient(180deg,#2a66ff,#1f4dd6);color:#fff;font-weight:900;cursor:pointer}
        </style></head>
        <body><div class="hero"><div class="card">
          <h1 class="h">Make what’s in your head real.</h1>
          <div class="p">Simo is your guide. Builder tools show up when you need them.</div>
          <button>Start</button>
        </div></div></body></html>`
    };

    function renderPreview(kind){
      previewFrame.srcdoc = templates[kind] || templates.space;
    }

    function openPreview(){
      renderPreview(previewSelect.value);
      previewModal.style.display = "flex";
      previewModal.setAttribute("aria-hidden","false");
      if (document.activeElement && document.activeElement.blur) document.activeElement.blur();
    }

    function closePreview(){
      previewModal.style.display = "none";
      previewModal.setAttribute("aria-hidden","true");
      input.focus();
    }

    previewBtn.addEventListener("click", openPreview);
    closePreviewBtn.addEventListener("click", closePreview);

    previewModal.addEventListener("click", (e) => {
      if (e.target === previewModal) closePreview();
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && previewModal.style.display === "flex") closePreview();
    });

    previewSelect.addEventListener("change", () => renderPreview(previewSelect.value));

    // ==========================
    // ONE SEND FUNCTION (NO DUP LISTENERS)
    // ==========================
    function isPreviewCommand(raw){
      const lower = (raw || "").trim().toLowerCase();
      return (
        lower === "preview" ||
        lower === "show preview" ||
        lower.includes("app preview")
      );
    }

    async function handleSend(){
      const raw = (input.value || "").trim();
      if (!raw) return;

      // Preview commands never call API
      if (isPreviewCommand(raw)) {
        add("you", raw);
        input.value = "";
        autoGrow();
        add("simo", "Alright — opening a preview.");
        openPreview();
        return;
      }

      add("you", raw);
      input.value = "";
      autoGrow();
      send.disabled = true;

      try{
        setOnline(true, "Calling API…");
        const reply = await callBackend(raw);
        add("simo", reply);
        setOnline(true, "Online");
      } catch(e){
        add("simo",
          `UI is working, but backend failed:\n${e.message}\n\nThat means /api/simon isn’t reachable from this deploy.`
        );
        setOnline(false, "Backend error");
      } finally {
        send.disabled = false;
        input.focus();
      }
    }

    // Attach listeners ONCE
    send.addEventListener("click", handleSend);

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    input.addEventListener("input", autoGrow);

    // Boot
    add("simo", "Hey — I’m Simo. What’s going on?");
    setOnline(false, "Offline (not calling API)");
    input.focus();
  </script>
</body>
</html>
