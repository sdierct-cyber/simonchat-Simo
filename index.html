<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simo</title>
  <style>
    :root{
      --bg:#0b1020; --text:#eaf0ff; --muted:#a9b6d3;
      --line:rgba(255,255,255,.10);
      --card:rgba(255,255,255,.06);
      --btn:#2a66ff; --btn2:#1f4dd6;
      --good:#39d98a; --warn:#ffcc66; --bad:#ff4d4d;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:radial-gradient(1200px 700px at 20% 0%, #162a66 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    h1{margin:0 0 12px 0; font-size:22px; letter-spacing:.2px}
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .panel{
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      border-radius:14px;
      overflow:hidden;
      min-height: 600px;
    }
    .panelHeader{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between;
      background:rgba(0,0,0,.18);
      gap:10px;
    }
    .panelTitle{font-weight:800}
    .panelSub{color:var(--muted); font-size:12px; margin-top:2px}
    .headerLeft{display:flex; flex-direction:column}
    .pills{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:4px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--muted); font-size:12px;
      white-space:nowrap;
    }

    /* Chat */
    #chat{
      height: 440px;
      overflow:auto;
      padding:14px;
      line-height:1.45;
      font-size:14px;
      white-space:pre-wrap;
    }
    .msg{margin:0 0 10px 0}
    .you{color:#7fb0ff}
    .simo{color:var(--good)}
    .sys{color:var(--muted)}

    .composer{
      border-top:1px solid var(--line);
      padding:12px;
      background:rgba(0,0,0,.18);
    }
    textarea{
      width:100%;
      min-height:82px;
      resize:vertical;
      border-radius:10px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.35);
      color:var(--text);
      padding:10px;
      outline:none;
      font-size:14px;
    }
    .row{display:flex; gap:10px; margin-top:10px}
    button{
      border:1px solid var(--line);
      background:linear-gradient(180deg,var(--btn),var(--btn2));
      color:white;
      padding:9px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
    }
    button.secondary{
      background:rgba(255,255,255,.07);
    }

    /* Workspace */
    #workspace{
      height: 560px;
      display:flex;
      flex-direction:column;
    }
    .workspaceBody{
      flex:1;
      position:relative;
      background:rgba(0,0,0,.10);
    }
    #workspaceFrame{
      width:100%;
      height:100%;
      border:0;
      background:transparent;
      display:none; /* shown when we have preview_html */
    }
    .workspaceEmpty{
      padding:16px;
      color:var(--muted);
      font-size:13px;
    }
    .results{
      padding:14px;
      display:none; /* shown when we have links/results */
      overflow:auto;
      height:100%;
    }
    .resultCard{
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      border-radius:12px;
      padding:12px;
      margin-bottom:10px;
    }
    .resultCard a{
      color:#9fc1ff;
      text-decoration:none;
      word-break:break-word;
    }
    .resultTitle{
      font-weight:800;
      margin-bottom:6px;
    }
    .resultMeta{
      color:rgba(234,240,255,.70);
      font-size:12px;
      margin-top:6px;
    }
    .workspaceFooter{
      border-top:1px solid var(--line);
      background:rgba(0,0,0,.18);
      padding:10px 14px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .statusGood{color:var(--good)}
    .statusWarn{color:var(--warn)}
    .statusBad{color:var(--bad)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Simo</h1>

    <div class="grid">
      <!-- LEFT: Chat -->
      <div class="panel">
        <div class="panelHeader">
          <div class="headerLeft">
            <div class="panelTitle">Chat</div>
            <div class="panelSub">Enter to send • Shift+Enter for new line</div>
          </div>
          <div class="pills">
            <div class="pill" id="modePill">mode: auto</div>
          </div>
        </div>

        <div id="chat"></div>

        <div class="composer">
          <textarea id="input" placeholder="Say something..."></textarea>
          <div class="row">
            <button id="sendBtn">Send</button>
            <button id="clearBtn" class="secondary">Clear</button>
          </div>
        </div>
      </div>

      <!-- RIGHT: Workspace -->
      <div class="panel">
        <div class="panelHeader">
          <div class="headerLeft">
            <div class="panelTitle">Workspace</div>
            <div class="panelSub" id="workSub">Waiting…</div>
          </div>
          <div class="pills">
            <div class="pill" id="topicPill">context: none</div>
          </div>
        </div>

        <div id="workspace">
          <div class="workspaceBody">
            <iframe id="workspaceFrame" title="workspace"></iframe>

            <div class="results" id="resultsBox"></div>

            <div class="workspaceEmpty" id="workspaceEmpty">
              This panel shows whatever you ask to see (mockups, links, results, code, etc.).<br><br>
              Try:
              <ul style="margin:10px 0 0 18px; line-height:1.5;">
                <li><b>show me a preview</b></li>
                <li><b>show me high res images of saturn</b></li>
                <li><b>make me a landing page layout</b></li>
              </ul>
            </div>
          </div>

          <div class="workspaceFooter">
            <span id="workStatus">status: <span class="statusWarn">idle</span></span>
            <span id="workHint">Tip: say “show me a preview” to render a mockup.</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const chatEl = document.getElementById("chat");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");
    const clearBtn = document.getElementById("clearBtn");

    const modePill = document.getElementById("modePill");
    const topicPill = document.getElementById("topicPill");

    const workSub = document.getElementById("workSub");
    const workStatus = document.getElementById("workStatus");
    const workHint = document.getElementById("workHint");

    const workspaceFrame = document.getElementById("workspaceFrame");
    const workspaceEmpty = document.getElementById("workspaceEmpty");
    const resultsBox = document.getElementById("resultsBox");

    const state = {
      history: [],
      mode: "auto",
      context: "none",   // free-text “last goal”
      lastUserText: ""
    };

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[s]));
    }

    function addLine(who, text, cls){
      const p = document.createElement("p");
      p.className = "msg " + (cls || "");
      p.innerHTML = `<span class="${who === 'You' ? 'you' : who === 'Simo' ? 'simo' : 'sys'}">${who}:</span> ${escapeHtml(text)}`;
      chatEl.appendChild(p);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function normalize(s){ return String(s||"").toLowerCase().trim(); }

    function detectModeAndContext(userText){
      const t = normalize(userText);

      // Mode detection (lightweight; backend also decides)
      if (/\bswitch topics?\b/.test(t)) {
        state.mode = "auto";
      } else if (/(stressed|anxious|tired|overwhelmed|upset|fight|argument)/.test(t)) {
        if (state.mode === "auto") state.mode = "venting";
      } else if (/(show me a preview|preview|mockup|wireframe|design|build|create|generate|make)/.test(t)) {
        state.mode = "building";
      }

      // Context: store the user’s last “goal” as free text (not a hardcoded topic)
      // This keeps it unlimited and ChatGPT-like.
      if (t.length > 0 && !/\bswitch topics?\b/.test(t)) {
        // keep short and human
        state.context = userText.slice(0, 60);
      }

      modePill.textContent = `mode: ${state.mode}`;
      topicPill.textContent = `context: ${state.context === "none" ? "none" : state.context}`;
    }

    function setWorkspaceIdle(){
      workSub.textContent = "Waiting…";
      workStatus.innerHTML = `status: <span class="statusWarn">idle</span>`;
      workHint.textContent = `Tip: say “show me a preview” to render a mockup.`;
      workspaceFrame.style.display = "none";
      resultsBox.style.display = "none";
      workspaceEmpty.style.display = "block";
      workspaceFrame.srcdoc = "";
      resultsBox.innerHTML = "";
    }

    function setWorkspacePreview(html){
      workSub.textContent = "Mockup • rendered";
      workStatus.innerHTML = `status: <span class="statusGood">showing preview</span>`;
      workHint.textContent = `Ask for tweaks (layout, colors, filters, etc.).`;
      workspaceEmpty.style.display = "none";
      resultsBox.style.display = "none";
      workspaceFrame.style.display = "block";
      workspaceFrame.srcdoc = html;
    }

    function extractUrls(text){
      const urls = (text.match(/https?:\/\/[^\s)]+/g) || []);
      // de-dupe
      return [...new Set(urls)];
    }

    function looksLikeImageUrl(url){
      return /\.(png|jpg|jpeg|webp|gif)(\?|#|$)/i.test(url);
    }

    function setWorkspaceResults(urls){
      workSub.textContent = "Results • links";
      workStatus.innerHTML = `status: <span class="statusGood">showing results</span>`;
      workHint.textContent = `Click a link to open it. Want me to narrow it down?`;
      workspaceEmpty.style.display = "none";
      workspaceFrame.style.display = "none";
      resultsBox.style.display = "block";

      const cards = urls.map((u, i) => {
        const isImg = looksLikeImageUrl(u);
        const title = isImg ? `Image link ${i+1}` : `Link ${i+1}`;
        return `
          <div class="resultCard">
            <div class="resultTitle">${escapeHtml(title)}</div>
            <a href="${escapeHtml(u)}" target="_blank" rel="noopener noreferrer">${escapeHtml(u)}</a>
          </div>
        `;
      }).join("");

      resultsBox.innerHTML = cards || `<div class="workspaceEmpty">No links found.</div>`;
    }

    async function callBackend(userText){
      const url = "/.netlify/functions/simon";
      const payload = {
        message: userText,
        mode: state.mode === "venting" ? "bestfriend" : state.mode === "building" ? "builder" : "auto",
        topic: state.context,          // free text context
        history: state.history.slice(-14)
      };

      try{
        const res = await fetch(url, {
          method:"POST",
          headers:{ "content-type":"application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(()=> ({}));
        if(!res.ok) throw new Error(data?.error || `HTTP ${res.status}`);
        return data;
      }catch(err){
        return { ok:false, error:String(err?.message || err) };
      }
    }

    function fallbackReply(userText){
      const t = normalize(userText);
      if (/\bswitch topics?\b/.test(t)) return "Bet. What do you wanna do now — venting, solving, or building?";
      if (/(stressed|anxious|tired|overwhelmed|upset|fight|argument)/.test(t))
        return "I got you. What part is hitting you the hardest right now?";
      if (/(preview|mockup|ui|layout)/.test(t))
        return "Say “show me a preview” and I’ll render something in the Workspace.";
      return "I’m here. Tell me what you want next — venting, solving, or building.";
    }

    async function onSend(){
      const text = inputEl.value.trim();
      if(!text) return;

      inputEl.value = "";
      state.lastUserText = text;

      addLine("You", text);

      detectModeAndContext(text);

      // optimistic UI: if user asked for preview, show a “loading” state
      workStatus.innerHTML = `status: <span class="statusWarn">thinking…</span>`;
      workSub.textContent = "Working…";
      workHint.textContent = "If you asked for a preview, it’ll render here.";

      state.history.push({ role:"user", content:text });

      const data = await callBackend(text);

      let reply = "";
      if (data && data.ok && typeof data.reply === "string") {
        reply = data.reply;
      } else {
        reply = fallbackReply(text);
      }

      // Update mode pill from backend if provided
      if (data && data.ok && typeof data.mode === "string") {
        const m = data.mode.toLowerCase();
        if (m === "builder") state.mode = "building";
        if (m === "bestfriend") state.mode = "venting"; // bestfriend-ish
        modePill.textContent = `mode: ${m === "builder" ? "building" : m === "bestfriend" ? "venting" : "auto"}`;
      }

      addLine("Simo", reply);

      state.history.push({ role:"assistant", content: reply });

      // Workspace render priority:
      // 1) preview_html from backend
      if (data && data.ok && typeof data.preview_html === "string" && data.preview_html.trim()) {
        setWorkspacePreview(data.preview_html);
        return;
      }

      // 2) If reply contains links, show them in Results
      const urls = extractUrls(reply);
      if (urls.length) {
        setWorkspaceResults(urls);
        return;
      }

      // 3) Otherwise idle
      setWorkspaceIdle();
    }

    sendBtn.addEventListener("click", onSend);

    clearBtn.addEventListener("click", () => {
      chatEl.innerHTML = "";
      state.history = [];
      state.mode = "auto";
      state.context = "none";
      modePill.textContent = "mode: auto";
      topicPill.textContent = "context: none";
      setWorkspaceIdle();
      addLine("Simo", "Reset. I’m here.", "sys");
    });

    inputEl.addEventListener("keydown", (e) => {
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        onSend();
      }
    });

    // Boot
    setWorkspaceIdle();
    addLine("Simo", "Reset. I’m here.", "sys");
  </script>
</body>
</html>
