<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simo</title>
  <style>
    :root{
      --bg:#0a1020;
      --panel:#0f1933;
      --panel2:#0c1530;
      --text:#eaf0ff;
      --muted:#a9b6d6;
      --line:rgba(255,255,255,.10);
      --accent:#66a6ff;
      --good:#55d38a;
      --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1100px 700px at 20% 0%, #142a6b 0%, var(--bg) 55%, #070b16 100%);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:22px;
    }
    .app{
      width:min(980px, 100%);
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border-radius:18px;
      overflow:hidden;
      box-shadow: 0 25px 80px rgba(0,0,0,.45);
    }
    header{
      padding:18px 18px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.12);
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:center;
      min-width:0;
    }
    .dot{
      width:12px;height:12px;border-radius:999px;background:var(--good);
      box-shadow:0 0 0 6px rgba(85,211,138,.12);
      flex:0 0 auto;
    }
    .title{
      display:flex;flex-direction:column;min-width:0;
    }
    .title b{
      font-size:15px;
      letter-spacing:.2px;
    }
    .title span{
      font-size:12px;color:var(--muted);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .controls{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;
    }
    .pill{
      display:flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(10,16,32,.55);
      font-size:12px;color:var(--muted);
    }
    .pill input{
      width:88px;
      background:transparent;border:none;outline:none;color:var(--text);
      font-size:12px;
    }
    button{
      border:1px solid var(--line);
      background: rgba(102,166,255,.14);
      color:var(--text);
      padding:9px 12px;border-radius:10px;
      cursor:pointer;
      transition:.12s ease;
      font-weight:600;
      font-size:12px;
    }
    button:hover{ transform: translateY(-1px); background: rgba(102,166,255,.20); }
    button:active{ transform: translateY(0px); }

    main{
      display:grid;
      grid-template-columns: 1fr;
      gap:0;
      padding:0;
      background: rgba(0,0,0,.06);
    }

    #chat{
      height:min(68vh, 640px);
      overflow:auto;
      padding:18px;
    }
    .msg{
      display:flex; gap:10px;
      margin:10px 0;
      max-width: 820px;
    }
    .msg.you{ margin-left:auto; flex-direction:row-reverse; }
    .avatar{
      width:34px;height:34px;border-radius:12px;
      background: rgba(255,255,255,.08);
      display:flex;align-items:center;justify-content:center;
      border:1px solid var(--line);
      flex:0 0 auto;
    }
    .bubble{
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(10,16,32,.58);
      line-height:1.35;
      font-size:14px;
      white-space:pre-wrap;
    }
    .msg.you .bubble{
      background: rgba(102,166,255,.14);
    }
    .meta{
      margin-top:6px;
      font-size:11px;
      color:var(--muted);
    }
    .row{
      display:flex;
      gap:10px;
      padding:14px;
      border-top:1px solid var(--line);
      background: rgba(0,0,0,.12);
    }
    textarea{
      flex:1;
      min-height:44px;
      max-height:140px;
      resize:vertical;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(10,16,32,.62);
      color:var(--text);
      padding:11px 12px;
      outline:none;
      font-size:14px;
      line-height:1.35;
    }
    .hint{
      padding:0 14px 14px;
      color:var(--muted);
      font-size:12px;
    }
    .tag{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      margin-right:6px;
      margin-top:6px;
      font-size:11px;
      color:var(--muted);
    }
    .err{
      color: var(--bad);
      font-size:12px;
      padding:8px 14px 14px;
      display:none;
    }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="dot" id="statusDot" title="status"></div>
        <div class="title">
          <b>Hey — I’m Simo.</b>
          <span id="sub">What’s going on?</span>
        </div>
      </div>

      <div class="controls">
        <div class="pill" title="Timezone used for time replies">
          TZ:
          <input id="tz" value="America/Detroit" />
        </div>
        <div class="pill" title="ZIP used for weather replies (optional)">
          ZIP:
          <input id="zip" placeholder="48044" />
        </div>
        <button id="clearBtn" type="button">Clear</button>
      </div>
    </header>

    <main>
      <div id="chat"></div>

      <div class="row">
        <textarea id="input" placeholder="Talk to Simo… (Enter to send, Shift+Enter for a new line)"></textarea>
        <button id="sendBtn" type="button">Send</button>
      </div>

      <div class="hint">
        <span class="tag">math: “217*22”</span>
        <span class="tag">time: “what time is it”</span>
        <span class="tag">weather: “weather 48044”</span>
        <span class="tag">vent: “I’m tired of this argument loop”</span>
        <span class="tag">build: “help me design an app”</span>
      </div>

      <div class="err" id="err"></div>
    </main>
  </div>

<script>
(function () {
  const chatEl = document.getElementById("chat");
  const inputEl = document.getElementById("input");
  const sendBtn = document.getElementById("sendBtn");
  const clearBtn = document.getElementById("clearBtn");
  const tzEl = document.getElementById("tz");
  const zipEl = document.getElementById("zip");
  const errEl = document.getElementById("err");
  const statusDot = document.getElementById("statusDot");
  const sub = document.getElementById("sub");

  const STORAGE_KEY = "simo_chat_v1";
  let history = [];

  function setStatus(ok, text){
    statusDot.style.background = ok ? "var(--good)" : "var(--bad)";
    statusDot.style.boxShadow = ok ? "0 0 0 6px rgba(85,211,138,.12)" : "0 0 0 6px rgba(255,107,107,.12)";
    if (text) sub.textContent = text;
  }

  function showErr(msg){
    errEl.style.display = "block";
    errEl.textContent = msg;
  }
  function clearErr(){
    errEl.style.display = "none";
    errEl.textContent = "";
  }

  function escapeHTML(s){
    return s.replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
  }

  function addMessage(role, content){
    const wrap = document.createElement("div");
    wrap.className = `msg ${role === "user" ? "you" : "simo"}`;

    const avatar = document.createElement("div");
    avatar.className = "avatar";
    avatar.textContent = role === "user" ? "You" : "S";

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.innerHTML = escapeHTML(content);

    const block = document.createElement("div");
    block.appendChild(bubble);

    wrap.appendChild(avatar);
    wrap.appendChild(block);

    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      history,
      tz: tzEl.value || "America/Detroit",
      zip: zipEl.value || ""
    }));
  }
  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const data = JSON.parse(raw);
      history = Array.isArray(data.history) ? data.history : [];
      if (data.tz) tzEl.value = data.tz;
      if (data.zip) zipEl.value = data.zip;
    }catch(e){}
  }

  function render(){
    chatEl.innerHTML = "";
    if (history.length === 0){
      addMessage("assistant", "What’s going on?");
      return;
    }
    for (const m of history){
      addMessage(m.role, m.content);
    }
  }

  async function send(){
    const text = (inputEl.value || "").trim();
    if(!text) return;

    clearErr();
    setStatus(true, "Thinking…");

    history.push({ role:"user", content:text });
    addMessage("user", text);
    inputEl.value = "";
    save();

    try{
      const res = await fetch("/api/simon", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({
          message: text,
          history: history.slice(-24),
          tz: tzEl.value || "America/Detroit",
          zip: zipEl.value || ""
        })
      });

      const data = await res.json().catch(() => ({}));
      if(!res.ok){
        throw new Error(data?.error || `HTTP ${res.status}`);
      }

      const reply = (data.reply || "").trim() || "…";
      history.push({ role:"assistant", content: reply });
      addMessage("assistant", reply);
      save();
      setStatus(true, "What’s going on?");
    } catch (e){
      setStatus(false, "I couldn’t reach my brain for a second. Try again.");
      showErr(String(e.message || e));
      // keep the chat usable even if API fails
      history.push({ role:"assistant", content:"I couldn’t reach my brain for a second. Try again." });
      addMessage("assistant", "I couldn’t reach my brain for a second. Try again.");
      save();
    }
  }

  sendBtn.addEventListener("click", send);
  clearBtn.addEventListener("click", () => {
    history = [];
    localStorage.removeItem(STORAGE_KEY);
    render();
  });

  inputEl.addEventListener("keydown", (e) => {
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      send();
    }
  });

  load();
  render();
  setStatus(true, "What’s going on?");
})();
</script>
</body>
</html>
