<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simo</title>
  <style>
    :root{
      --bg:#0b1020; --text:#eaf0ff; --muted:#a9b6d3;
      --line:rgba(255,255,255,.10);
      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --panel: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      --btn:#2a66ff; --btn2:#1f4dd6;
      --good:#39d98a; --bad:#ff4d4d;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:radial-gradient(1200px 700px at 20% 0%, #162a66 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:14px 16px;border:1px solid var(--line);border-radius:18px;
      background:var(--panel); box-shadow:var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:12px;background:rgba(255,255,255,.08);border:1px solid var(--line)}
    .name{font-weight:900;font-size:22px;line-height:1}
    .tag{color:rgba(234,240,255,.70);font-size:13px;margin-top:3px}
    .topActions{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .pill{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      font-weight:800;
    }
    .toggle{
      width:48px;height:26px;border-radius:999px;border:1px solid var(--line);
      background:rgba(0,0,0,.25);position:relative;cursor:pointer;
    }
    .toggle.on{background:rgba(57,217,138,.18);border-color:rgba(57,217,138,.4)}
    .knob{
      width:22px;height:22px;border-radius:50%;
      background:rgba(255,255,255,.85);position:absolute;top:1px;left:1px;
      transition:transform .15s ease;
    }
    .toggle.on .knob{transform:translateX(22px)}
    .btn{
      padding:10px 14px;border-radius:12px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);color:var(--text);font-weight:900;cursor:pointer;
    }
    .btn.primary{background:linear-gradient(180deg,var(--btn),var(--btn2));border-color:rgba(42,102,255,.45)}
    .grid{
      display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;
    }
    .panel{
      border:1px solid var(--line);border-radius:18px;background:var(--panel);
      box-shadow:var(--shadow); overflow:hidden;
    }
    .panelHeader{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:14px 16px;border-bottom:1px solid var(--line);
    }
    .panelTitle{font-weight:900;letter-spacing:.4px}
    .modes{display:flex;gap:10px}
    .modeBtn{
      padding:8px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);color:rgba(234,240,255,.85);cursor:pointer;font-weight:900;
    }
    .modeBtn.active{background:rgba(42,102,255,.22);border-color:rgba(42,102,255,.45);color:var(--text)}
    .chatBody{padding:14px 16px; height:520px; overflow:auto;}
    .msg{border:1px solid var(--line);background:rgba(0,0,0,.14);border-radius:16px;padding:12px 12px;margin-bottom:12px}
    .who{font-weight:900;font-size:13px;color:rgba(234,240,255,.72);margin-bottom:6px}
    .you{background:rgba(42,102,255,.16);border-color:rgba(42,102,255,.35)}
    .sys{border-color:rgba(255,77,77,.35)}
    .chatFooter{
      padding:12px;border-top:1px solid var(--line);
      display:flex;gap:10px;align-items:flex-end;
    }
    textarea{
      flex:1;min-height:46px;max-height:160px;resize:vertical;
      padding:12px 12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(0,0,0,.20);color:var(--text);
      outline:none;
    }
    .hint{padding:0 16px 14px;color:rgba(234,240,255,.55);font-size:12px}
    .previewHeaderRight{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);font-weight:900;font-size:12px;color:rgba(234,240,255,.85);
    }
    .chip.good{border-color:rgba(57,217,138,.35);background:rgba(57,217,138,.12)}
    .previewBody{height:570px;background:rgba(0,0,0,.18)}
    iframe{width:100%;height:100%;border:0;background:#0b1020}
    .empty{
      padding:18px;color:rgba(234,240,255,.75);
    }
    @media (max-width:980px){ .grid{grid-template-columns:1fr} .chatBody{height:420px} .previewBody{height:420px} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="name">Simo</div>
          <div class="tag">best friend + builder</div>
        </div>
      </div>

      <div class="topActions">
        <div class="pill">
          <span>Pro Mode</span>
          <div id="proToggle" class="toggle"><div class="knob"></div></div>
        </div>
        <button id="resetBtn" class="btn">Reset</button>
      </div>
    </div>

    <div class="grid">
      <!-- CHAT -->
      <div class="panel">
        <div class="panelHeader">
          <div class="panelTitle">CHAT</div>
          <div class="modes">
            <button class="modeBtn" data-mode="venting">Venting</button>
            <button class="modeBtn" data-mode="solving">Solving</button>
            <button class="modeBtn active" data-mode="building">Building</button>
          </div>
        </div>

        <div id="chatBody" class="chatBody"></div>

        <div class="chatFooter">
          <textarea id="input" placeholder="Type here... (Enter to send, Shift+Enter for new line)"></textarea>
          <button id="sendBtn" class="btn primary">Send</button>
        </div>
        <div class="hint">Tip: In Building mode, ask for a layout/app/site and I’ll render a preview (Pro).</div>
      </div>

      <!-- PREVIEW -->
      <div class="panel">
        <div class="panelHeader">
          <div class="panelTitle">PREVIEW</div>
          <div class="previewHeaderRight">
            <span id="previewName" class="chip">Untitled preview</span>
            <span id="previewMode" class="chip">Building</span>
            <span id="previewPro" class="chip good">PRO enabled</span>
          </div>
        </div>
        <div class="previewBody">
          <iframe id="previewFrame" title="preview"></iframe>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- state ----------
    const state = {
      mode: "building",
      pro: true,
      // server can return a "state" object; we store it and send back for edits
      serverState: {},
      lastPreview: null, // {name, kind, html}
    };

    const chatBody = document.getElementById("chatBody");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");
    const resetBtn = document.getElementById("resetBtn");

    const proToggle = document.getElementById("proToggle");
    const previewFrame = document.getElementById("previewFrame");
    const previewName = document.getElementById("previewName");
    const previewMode = document.getElementById("previewMode");
    const previewPro = document.getElementById("previewPro");

    function addMsg(who, text, cls="") {
      const el = document.createElement("div");
      el.className = "msg " + (cls || "");
      el.innerHTML = `<div class="who">${who}</div><div>${escapeHtml(text).replace(/\\n/g,"<br/>")}</div>`;
      chatBody.appendChild(el);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function escapeHtml(s="") {
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function setMode(mode) {
      state.mode = mode;
      document.querySelectorAll(".modeBtn").forEach(b => {
        b.classList.toggle("active", b.dataset.mode === mode);
      });
      previewMode.textContent = mode.charAt(0).toUpperCase() + mode.slice(1);
    }

    function setPro(on) {
      state.pro = !!on;
      proToggle.classList.toggle("on", state.pro);
      previewPro.textContent = state.pro ? "PRO enabled" : "PRO off";
      previewPro.classList.toggle("good", state.pro);
    }

    function setPreview(preview) {
      state.lastPreview = preview || null;

      if (!preview) {
        previewName.textContent = "Untitled preview";
        previewFrame.srcdoc = `<div style="padding:18px;color:#eaf0ff;font-family:system-ui;background:#0b1020">No preview yet.</div>`;
        return;
      }
      previewName.textContent = preview.name || "preview";
      if (preview.kind === "html" && preview.html) {
        previewFrame.srcdoc = preview.html;
      } else {
        previewFrame.srcdoc = `<div style="padding:18px;color:#eaf0ff;font-family:system-ui;background:#0b1020">Unsupported preview.</div>`;
      }
    }

    async function sendMessage() {
      const message = input.value.trim();
      if (!message) return;
      input.value = "";
      addMsg("You", message, "you");

      sendBtn.disabled = true;
      sendBtn.textContent = "…";

      try {
        const payload = {
          message,
          mode: state.mode,
          pro: state.pro,
          state: {
            ...state.serverState,
            lastPreview: state.lastPreview ? { name: state.lastPreview.name } : null
          }
        };

        const res = await fetch("/api/simon", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok || !data.ok) {
          const err = (data && (data.error || data.details)) ? `${data.error || "Error"}: ${data.details || ""}` : `HTTP ${res.status}`;
          addMsg("Simo", err, "sys");
          return;
        }

        // Save server state (important for edits)
        if (data.state && typeof data.state === "object") state.serverState = data.state;

        addMsg("Simo", data.reply || "Okay.");
        if (data.preview) setPreview(data.preview);

      } catch (e) {
        addMsg("Simo", "Network error: " + (e && e.message ? e.message : String(e)), "sys");
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = "Send";
      }
    }

    // ---------- events ----------
    document.querySelectorAll(".modeBtn").forEach(b => {
      b.addEventListener("click", () => setMode(b.dataset.mode));
    });

    proToggle.addEventListener("click", () => setPro(!state.pro));

    sendBtn.addEventListener("click", sendMessage);

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    resetBtn.addEventListener("click", () => {
      chatBody.innerHTML = "";
      state.serverState = {};
      state.lastPreview = null;
      setMode("building");
      setPro(true);
      setPreview(null);
      addMsg("Simo", "I’m here. Pick a mode — or just talk.");
    });

    // boot
    setPro(true);
    setPreview(null);
    addMsg("Simo", "I’m here. Pick a mode — or just talk.");
  </script>
</body>
</html>
