<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simo</title>

<style>
:root{
  --bg:#0b1020;
  --panel:#121933;
  --panel2:#0e1530;
  --text:#eaf0ff;
  --muted:#a9b6d3;
  --line:rgba(255,255,255,.10);
  --accent:#2a66ff;
  --accent2:#1f4dd6;
  --warn:#ffcc66;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:radial-gradient(1200px 700px at 20% 0%, #162a66 0%, var(--bg) 55%);
  color:var(--text);
}
.wrap{max-width:980px;margin:0 auto;padding:18px}
.top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
.brand{font-size:22px;font-weight:700;letter-spacing:.2px}
.sub{font-size:12px;color:var(--muted);margin-top:2px}
.badgeRow{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.badge{
  font-size:12px;color:var(--muted);
  border:1px solid var(--line);padding:6px 10px;border-radius:999px;
  background:rgba(255,255,255,.04);
}
.badge strong{color:var(--text);font-weight:700}
.grid{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
@media (max-width: 920px){ .grid{grid-template-columns:1fr} }
.card{
  background:rgba(255,255,255,.03);
  border:1px solid var(--line);
  border-radius:14px;
  overflow:hidden;
}
.cardHeader{
  padding:12px 12px 10px;
  border-bottom:1px solid var(--line);
  display:flex;align-items:center;justify-content:space-between;gap:10px;
}
.cardTitle{font-weight:700}
.cardHint{color:var(--muted);font-size:12px}
.chat{height:520px;overflow:auto;padding:12px}
.msg{margin:0 0 12px 0;line-height:1.5;font-size:14px}
.msg .who{display:inline-block;font-weight:700;margin-right:8px}
.msg.user .who{color:#fff}
.msg.simo .who{color:var(--muted)}
.bubble{
  display:inline-block;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.02);
  max-width:95%;
  white-space:pre-wrap;
}
.msg.user .bubble{
  background:rgba(42,102,255,.10);
  border-color:rgba(42,102,255,.25);
}
.controls{
  padding:12px;
  border-top:1px solid var(--line);
  display:flex;gap:8px;align-items:flex-end;
  background:rgba(0,0,0,.10);
}
textarea{
  flex:1;height:52px;resize:none;
  border-radius:12px;border:1px solid var(--line);
  background:var(--panel2);
  color:var(--text);
  padding:10px 12px;
  font-size:14px;outline:none;
}
button{
  border:none;padding:12px 14px;border-radius:12px;
  font-weight:800;cursor:pointer;color:#fff;background:var(--accent);
}
button:hover{background:var(--accent2)}
.secondaryBtn{
  background:rgba(255,255,255,.06);
  border:1px solid var(--line);
  color:var(--text);
}
.secondaryBtn:hover{background:rgba(255,255,255,.10)}
.side{padding:12px}
.kv{
  display:flex;justify-content:space-between;gap:10px;
  padding:10px 10px;border:1px solid var(--line);
  border-radius:12px;background:rgba(255,255,255,.02);
  margin-bottom:10px;font-size:13px;
}
.kv span{color:var(--muted)}
.small{color:var(--muted);font-size:12px;line-height:1.4}
hr.sep{border:none;border-top:1px solid var(--line);margin:12px 0}
.previewWrap{padding:12px}
.previewCard{
  background:#fff;color:#111;
  border-radius:14px;padding:14px;
  border:1px solid rgba(0,0,0,.10);
}
.previewTitle{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
.previewTitle h3{margin:0;font-size:16px}
.previewTitle .tag{
  font-size:11px;padding:6px 10px;border-radius:999px;
  border:1px solid rgba(0,0,0,.12);
  background:#f3f4f6;
}
.previewSub{color:#444;font-size:12px;margin:6px 0 10px}
.pillRow{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 10px}
.pill{
  font-size:11px;padding:6px 10px;border-radius:999px;
  border:1px solid #c7d2fe;background:#eef2ff;
}
.blockTitle{font-size:12px;font-weight:800;margin:12px 0 8px;color:#222}
.box{
  border:1px solid #e5e7eb;border-radius:12px;
  padding:10px;background:#f9fafb;margin-bottom:8px;
}
.grayBox{height:140px;background:#e5e7eb;border-radius:12px}
.modalBackdrop{
  position:fixed;inset:0;background:rgba(0,0,0,.55);
  display:none;align-items:center;justify-content:center;
  padding:20px;
}
.modal{
  width:min(520px, 100%);
  border-radius:16px;border:1px solid var(--line);
  background:rgba(18,25,51,.98);
  padding:14px;
}
.modal h3{margin:0 0 6px 0}
.modal p{margin:0 0 12px 0;color:var(--muted);line-height:1.45;font-size:13px}
.modal .row{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
.warnLine{
  border:1px dashed rgba(255,204,102,.45);
  background:rgba(255,204,102,.08);
  color:#ffe7b3;
  padding:10px 12px;border-radius:12px;
  font-size:12px;margin-top:10px;
}
</style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div>
      <div class="brand">Hey — I’m Simo.</div>
      <div class="sub">Best friend vibes by default. Previews adapt to what you ask for.</div>
    </div>
    <div class="badgeRow">
      <div class="badge">Plan: <strong id="planBadge">Free</strong></div>
      <div class="badge">Mode: <strong id="modeBadge">Friend</strong></div>
      <div class="badge">Focus: <strong id="focusBadge">—</strong></div>
      <div class="badge">Domain: <strong id="domainBadge">—</strong></div>
      <div class="badge">Preview: <strong id="previewBadge">Ready</strong></div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="cardHeader">
        <div>
          <div class="cardTitle">Chat</div>
          <div class="cardHint">Enter to send • Shift+Enter for a new line</div>
        </div>
        <button class="secondaryBtn" id="clearBtn" type="button">Clear</button>
      </div>

      <div id="chat" class="chat"></div>

      <div class="controls">
        <textarea id="input" placeholder="Talk to Simo…"></textarea>
        <button id="sendBtn" type="button">Send</button>
      </div>
    </div>

    <div class="card">
      <div class="cardHeader">
        <div>
          <div class="cardTitle">Preview</div>
          <div class="cardHint">Say “show me…” + what you want</div>
        </div>
        <button class="secondaryBtn" id="togglePlanBtn" type="button">Toggle Pro</button>
      </div>

      <div class="side">
        <div class="kv"><span>Last intent</span><strong id="intentKV">—</strong></div>
        <div class="kv"><span>Project/topic</span><strong id="topicKV">—</strong></div>
        <div class="kv"><span>Preview modules</span><strong id="modulesKV">—</strong></div>

        <div class="small">
          Tip: “switch topics” resets pending questions and stages.
        </div>

        <hr class="sep" />

        <div id="previewArea" class="previewWrap">
          <div class="small">No preview yet. Ask for one.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="modalBackdrop" class="modalBackdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <h3>That’s a Pro action</h3>
    <p>
      I can do that — but in the Free plan I keep it light. Toggle Pro to simulate paid upgrades.
      (Payment wiring comes later; this is UI + logic gate.)
    </p>
    <div class="row">
      <button class="secondaryBtn" id="closeModalBtn" type="button">Not now</button>
      <button id="enableProBtn" type="button">Enable Pro</button>
    </div>
    <div class="warnLine">
      This doesn’t charge anyone. It only flips the plan state.
    </div>
  </div>
</div>

<script>
const state = {
  plan: "free",
  mode: "friend",
  focus: "",                 // vent | solve | build
  domain: "",                // physical | digital | general
  pending: "",               // home_story | home_bedplan | home_lotwidth | app_user | app_core | app_platform
  expectingLaneChoice: false,
  lastSimoKey: "",
  history: [],
  memory: {
    lastIntent: "",
    lastTopic: "",
    lastPreviewSpec: null,
    home: { story:"", bedplan:"", lotWidth:"", garage:"", sqft:"", beds:"", baths:"" },
    app:  { user:"", core:"", platform:"" }
  }
};

const chatEl = document.getElementById("chat");
const inputEl = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");
const clearBtn = document.getElementById("clearBtn");
const togglePlanBtn = document.getElementById("togglePlanBtn");

const planBadge = document.getElementById("planBadge");
const modeBadge = document.getElementById("modeBadge");
const focusBadge = document.getElementById("focusBadge");
const domainBadge = document.getElementById("domainBadge");
const previewBadge = document.getElementById("previewBadge");

const intentKV = document.getElementById("intentKV");
const topicKV = document.getElementById("topicKV");
const modulesKV = document.getElementById("modulesKV");
const previewArea = document.getElementById("previewArea");

const modalBackdrop = document.getElementById("modalBackdrop");
const closeModalBtn = document.getElementById("closeModalBtn");
const enableProBtn = document.getElementById("enableProBtn");

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function nowTs(){ return new Date().toISOString(); }

function setBadges(){
  planBadge.textContent = state.plan === "pro" ? "Pro" : "Free";
  modeBadge.textContent = state.mode === "builder" ? "Builder" : "Friend";
  focusBadge.textContent = state.focus ? state.focus.toUpperCase() : "—";
  domainBadge.textContent = state.domain ? state.domain.toUpperCase() : "—";
}
function setContextCards(){
  intentKV.textContent = state.memory.lastIntent || "—";
  topicKV.textContent = state.memory.lastTopic || "—";
  modulesKV.textContent = state.memory.lastPreviewSpec?.modules?.length
    ? state.memory.lastPreviewSpec.modules.join(", ")
    : "—";
}
function openModal(){ modalBackdrop.style.display = "flex"; }
function closeModal(){ modalBackdrop.style.display = "none"; }

function addMessage(role, text, key=""){
  state.history.push({ role, text, ts: nowTs() });

  const msg = document.createElement("div");
  msg.className = "msg " + (role === "user" ? "user" : "simo");

  const who = document.createElement("span");
  who.className = "who";
  who.textContent = role === "user" ? "You:" : "Simo:";

  const bubble = document.createElement("span");
  bubble.className = "bubble";
  bubble.innerHTML = escapeHtml(text);

  msg.appendChild(who);
  msg.appendChild(bubble);
  chatEl.appendChild(msg);
  chatEl.scrollTop = chatEl.scrollHeight;

  if (role === "simo" && key) state.lastSimoKey = key;
}

/* ---------- Domain + intent ---------- */
function detectDomain(text){
  const t = (text || "").toLowerCase();
  const physicalHits = [
    "home","house","floor plan","layout","blueprint","garage","bedroom","bath",
    "sq ft","square feet","kitchen","living room","foundation","lot","roof",
    "ranch","two-story","2 story","story","upstairs","downstairs"
  ];
  const digitalHits = [
    "app","website","web app","saas","software","ui","ux","screen","dashboard",
    "login","api","database","frontend","backend"
  ];
  let p=0, d=0;
  for (const w of physicalHits) if (t.includes(w)) p++;
  for (const w of digitalHits) if (t.includes(w)) d++;
  if (p >= 2 && p >= d) return "physical";
  if (d >= 2 && d > p) return "digital";
  return "general";
}

function detectIntent(text){
  const t = (text || "").toLowerCase().trim();

  if (/^(switch topics|new topic|change topic|switch topic)$/i.test(t)) return "switch_topics";

  // "where's the layout" / "wheres the layout" should re-show preview
  if ((t.includes("where") || t.includes("wheres") || t.includes("where's")) && t.includes("layout")) return "preview";

  if (/\bshow me\b/.test(t) && (t.includes("layout") || t.includes("floor plan") || t.includes("home") || t.includes("house") || t.includes("mockup") || t.includes("preview") || t.includes("wireframe"))) return "preview";
  if (/(preview|mockup|wireframe)\b/i.test(text)) return "preview";

  if (/(write|draft|email|resume|cover letter|bio|script|story|book)/i.test(text)) return "write";
  if (/(code|html|css|js|javascript|react|bug|fix|error)/i.test(text)) return "code";

  if (/(stressed|tired|argument|anxious|overwhelmed|mad|upset|drained)/i.test(text)) return "vent";

  // lane words
  if (/\bvent(ing)?\b/.test(t)) return "lane_vent";
  if (/\b(problem\s*solv|solv(ing|e))\b/.test(t)) return "lane_solve";
  if (/\b(build(ing)?|create|design)\b/.test(t)) return "lane_build";

  // app intent
  if (/\b(app|software|saas|website|web app)\b/.test(t)) return "app_request";

  return "chat";
}

function cleanTopic(s){
  return (s || "")
    .replace(/[?.!]+$/g, "")
    .replace(/\b(show me|a|an|the|quick|simple|one-page|ui|mockup|preview)\b/ig, "")
    .replace(/\s+/g, " ")
    .trim();
}
function shorten(s){
  if (!s) return "";
  return s.length > 56 ? (s.slice(0, 56).trim() + "…") : s;
}
function inferTopic(text){
  const raw = (text || "").trim();
  if (!raw) return "";
  const m = raw.match(/(?:show me|preview|mockup|layout|floor plan)\s+(?:a|an|the)?\s*(.+)$/i);
  if (m && m[1]) return shorten(cleanTopic(m[1]));
  return shorten(raw);
}

/* ---------- Preview rendering ---------- */
function renderHomePreview(title, notes){
  const story = state.memory.home.story || "—";
  const bedplan = state.memory.home.bedplan || "—";
  const lot = state.memory.home.lotWidth || "—";

  previewArea.innerHTML = `
    <div class="previewCard">
      <div class="previewTitle">
        <div>
          <h3>${escapeHtml(title)}</h3>
          <div class="previewSub">${escapeHtml(notes)}</div>
        </div>
        <div class="tag">Floor Plan</div>
      </div>

      <div class="pillRow">
        <div class="pill">Style: modern</div>
        <div class="pill">Story: ${escapeHtml(story)}</div>
        <div class="pill">Beds plan: ${escapeHtml(bedplan)}</div>
        <div class="pill">Lot width: ${escapeHtml(lot)}</div>
      </div>

      <div class="blockTitle">Simple concept layout (not to scale)</div>
      <div class="box">
        <div style="display:grid;gap:10px;">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div class="box" style="background:#fff;">Bedroom 2</div>
            <div class="box" style="background:#fff;">Bedroom 3</div>
          </div>
          <div class="box" style="background:#fff;">Bath + Laundry (central)</div>
          <div class="box" style="background:#fff;">Primary Suite (bed + bath + closet)</div>
          <div style="display:grid;grid-template-columns:1.3fr .7fr;gap:10px;">
            <div class="box" style="background:#fff;">Open Kitchen + Dining + Living</div>
            <div class="box" style="background:#fff;">Entry / Mudroom</div>
          </div>
          <div class="box" style="background:#fff;">Attached 2-Car Garage (front/side)</div>
        </div>
      </div>

      <div class="blockTitle">Next refinements</div>
      <div class="pillRow">
        <div class="pill">kitchen size</div>
        <div class="pill">pantry</div>
        <div class="pill">mudroom</div>
        <div class="pill">basement?</div>
      </div>
    </div>
  `;
}

function renderAppPreview(){
  const user = state.memory.app.user || "—";
  const core = state.memory.app.core || "—";
  const platform = state.memory.app.platform || "—";

  previewArea.innerHTML = `
    <div class="previewCard">
      <div class="previewTitle">
        <div>
          <h3>Dream Home Design App — Concept</h3>
          <div class="previewSub">User: ${escapeHtml(user)} • Core: ${escapeHtml(core)} • Platform: ${escapeHtml(platform)}</div>
        </div>
        <div class="tag">App</div>
      </div>

      <div class="blockTitle">Main screens</div>
      <div class="box"><strong>Start</strong><br/>Pick template • Enter dimensions • Choose style</div>
      <div class="box"><strong>Design Canvas</strong><br/>Drag rooms • Snap to grid • Resize</div>
      <div class="box"><strong>AI Assist</strong><br/>“Make it modern” • “Add pantry” • “Optimize flow”</div>
      <div class="box"><strong>Export</strong><br/>Share link • PDF plan • Materials list</div>

      <div class="blockTitle">Preview area</div>
      <div class="grayBox"></div>
    </div>
  `;
}

/* ---------- Flow helpers ---------- */
function resetPending(){ state.pending = ""; }
function resetTopicState(){
  state.focus = "";
  state.domain = "";
  state.mode = "friend";
  state.expectingLaneChoice = false;
  state.lastSimoKey = "";
  resetPending();
  state.memory.home = { story:"", bedplan:"", lotWidth:"", garage:"", sqft:"", beds:"", baths:"" };
  state.memory.app = { user:"", core:"", platform:"" };
}

function setFocusBuild(domain){
  state.focus = "build";
  state.mode = "builder";
  state.domain = domain;
  state.expectingLaneChoice = false;
  setBadges();
}

/* ---------- Pending answer router ---------- */
function handlePendingAnswer(userText){
  const t = (userText || "").trim().toLowerCase();

  // HOME: choose story
  if (state.pending === "home_story"){
    if (t.includes("ranch") || t.includes("single") || t.includes("one") || t.includes("1")){
      state.memory.home.story = "single-story ranch";
      state.pending = "home_lotwidth";
      renderHomePreview(state.memory.lastPreviewSpec?.title || "Home Layout", "Locked: single-story ranch. Next: lot width.");
      addMessage("simo","Nice. What’s the lot width? (example: 50ft, 60ft)","home_lot_q");
      return true;
    }
    if (t.includes("two") || t.includes("2") || t.includes("story") || t.includes("upstairs")){
      state.memory.home.story = "two-story";
      state.pending = "home_bedplan";
      renderHomePreview(state.memory.lastPreviewSpec?.title || "Home Layout", "Locked: two-story. Next: bedroom placement.");
      addMessage("simo","Cool — two-story. Do you want all 3 bedrooms upstairs, or primary on main?","home_bed_q");
      return true;
    }
    addMessage("simo","Quick confirm: single-story ranch, or two-story?","home_story_retry");
    return true;
  }

  // HOME: bedroom plan
  if (state.pending === "home_bedplan"){
    // accept anything as bedplan
    state.memory.home.bedplan = userText.trim();
    state.pending = "home_lotwidth";
    renderHomePreview(state.memory.lastPreviewSpec?.title || "Home Layout", "Got it. Next: lot width.");
    addMessage("simo","Perfect. What’s the lot width? (example: 50ft, 60ft)","home_lot_q2");
    return true;
  }

  // HOME: lot width
  if (state.pending === "home_lotwidth"){
    state.memory.home.lotWidth = userText.trim();
    resetPending();
    renderHomePreview(state.memory.lastPreviewSpec?.title || "Home Layout", "Updated with your lot width. Want garage front-facing or side-entry?");
    addMessage("simo","Layout updated on the right. Garage: front-facing or side-entry?","home_garage_q");
    return true;
  }

  // APP: user choice A/B/C
  if (state.pending === "app_user"){
    if (t === "a" || t.includes("homeowner")) state.memory.app.user = "homeowners";
    else if (t === "b" || t.includes("contract")) state.memory.app.user = "contractors/designers";
    else if (t === "c" || t.includes("both")) state.memory.app.user = "both";
    else {
      addMessage("simo","Just reply A, B, or C (homeowners / contractors / both).","app_user_retry");
      return true;
    }
    state.pending = "app_core";
    addMessage("simo","Core experience:\n(A) drag-and-drop floor plan\n(B) AI suggestions from a prompt\n(C) templates + customize\nReply A/B/C.","app_core_q");
    return true;
  }

  // APP: core A/B/C
  if (state.pending === "app_core"){
    if (t === "a") state.memory.app.core = "drag-and-drop floor plan";
    else if (t === "b") state.memory.app.core = "AI suggestions from prompt";
    else if (t === "c") state.memory.app.core = "templates + customize";
    else {
      addMessage("simo","Reply A/B/C for the core experience.","app_core_retry");
      return true;
    }
    state.pending = "app_platform";
    addMessage("simo","Platform:\n(A) mobile first\n(B) web first\n(C) both\nReply A/B/C.","app_platform_q");
    return true;
  }

  // APP: platform A/B/C
  if (state.pending === "app_platform"){
    if (t === "a") state.memory.app.platform = "mobile first";
    else if (t === "b") state.memory.app.platform = "web first";
    else if (t === "c") state.memory.app.platform = "both";
    else {
      addMessage("simo","Reply A/B/C for platform.","app_platform_retry");
      return true;
    }
    resetPending();
    previewBadge.textContent = "Shown";
    renderAppPreview();
    setContextCards();
    addMessage("simo","Preview’s on the right. What’s the first feature you want users to touch?","app_feature1");
    return true;
  }

  return false;
}

/* ---------- Pro gating stub ---------- */
function isProAction(text){
  const t = (text || "").toLowerCase();
  if (/(export|download|pdf|docx|pptx)/i.test(t)) return true;
  if (/(connect|api key|openai|billing|stripe)/i.test(t)) return true;
  return false;
}

/* ---------- Main reply ---------- */
function simoReply(userText){
  const intent = detectIntent(userText);
  state.memory.lastIntent = intent;

  // If we're waiting on a pending answer, handle it FIRST
  if (state.pending){
    handlePendingAnswer(userText);
    setBadges();
    setContextCards();
    return;
  }

  // Update domain continuously
  state.domain = detectDomain(userText);

  // Track topic
  const topic = inferTopic(userText);
  if (topic) state.memory.lastTopic = topic;

  // switch topics hard reset
  if (intent === "switch_topics"){
    resetTopicState();
    setBadges();
    setContextCards();
    addMessage("simo","Got you — switching topics. What are we doing: venting, solving, or building?","ask_lane");
    state.expectingLaneChoice = true;
    return;
  }

  // If bot is expecting lane choice, DON'T block app/home requests.
  // Let app/home take over immediately.
  if (state.expectingLaneChoice){
    const t = (userText || "").toLowerCase();
    if (/\b(app|software|saas|website|web app)\b/.test(t)){
      state.expectingLaneChoice = false;
      setFocusBuild("digital");
      state.pending = "app_user";
      addMessage("simo","Alright — app build.\nWho’s the main user?\n(A) homeowners (B) contractors/designers (C) both\nReply A/B/C.","app_user_q");
      return;
    }
    if (t.includes("home") || t.includes("layout") || t.includes("floor plan") || t.includes("house")){
      state.expectingLaneChoice = false;
      // fall through to preview/build below
    } else if (t.includes("vent")) {
      state.expectingLaneChoice = false;
      state.focus = "vent"; state.mode="friend";
      setBadges();
      addMessage("simo","Alright. Vent. What happened?","vent_start");
      return;
    } else if (t.includes("solve") || t.includes("problem")) {
      state.expectingLaneChoice = false;
      state.focus = "solve"; state.mode="builder";
      setBadges();
      addMessage("simo","Alright — solve mode. What’s the goal and what’s blocking you?","solve_start");
      return;
    } else if (t.includes("build") || t.includes("create") || t.includes("design")) {
      state.expectingLaneChoice = false;
      state.focus = "build"; state.mode="builder";
      setBadges();
      addMessage("simo","Alright — build. What are we making?","build_start");
      return;
    }
  }

  // Pro gating
  if (state.plan !== "pro" && isProAction(userText)){
    addMessage("simo",
      "I can do that — but that’s a paid-upgrade type action.\nToggle Pro (top right) and I’ll treat it like the upgraded plan.",
      "pro_gate"
    );
    openModal();
    setBadges();
    setContextCards();
    return;
  }

  // Preview intent
  if (intent === "preview"){
    // If we already have a home preview spec, re-render it instead of getting stuck
    const domainNow = detectDomain(userText);
    if (domainNow === "physical" || (state.memory.lastPreviewSpec?.modules || []).includes("floor plan")){
      setFocusBuild("physical");
      state.memory.lastPreviewSpec = {
        title: state.memory.lastPreviewSpec?.title || ("Home Layout: " + (state.memory.lastTopic || "Modern Home")),
        modules: ["floor plan","rooms","notes"],
        notes: "Simple concept layout. Choose: single-story ranch or two-story."
      };
      previewBadge.textContent = "Shown";
      renderHomePreview(state.memory.lastPreviewSpec.title, state.memory.lastPreviewSpec.notes);
      setContextCards();
      state.pending = "home_story";
      addMessage("simo","Preview’s on the right. Want single-story ranch, or two-story with bedrooms upstairs?","home_story_q");
      return;
    }

    // Otherwise just show app preview starter
    setFocusBuild("digital");
    previewBadge.textContent = "Shown";
    renderAppPreview();
    setContextCards();
    addMessage("simo","Preview’s on the right. Want this for homeowners, contractors, or both? (A/B/C)","app_user_hint");
    state.pending = "app_user";
    return;
  }

  // App request (even if they didn't say “preview”)
  if (intent === "app_request"){
    setFocusBuild("digital");
    state.pending = "app_user";
    addMessage("simo","Alright — app build.\nWho’s the main user?\n(A) homeowners (B) contractors/designers (C) both\nReply A/B/C.","app_user_q");
    return;
  }

  // If they mention home/layout generally, guide them toward preview
  const low = (userText || "").toLowerCase();
  if (detectDomain(userText) === "physical" && (low.includes("home") || low.includes("layout") || low.includes("floor plan") || low.includes("house"))){
    setFocusBuild("physical");
    addMessage("simo","Say: “show me the layout” and I’ll drop the floor plan preview on the right.","nudge_layout");
    return;
  }

  // If nothing matched, ask lane once (and set expectingLaneChoice)
  state.expectingLaneChoice = true;
  addMessage("simo","What do you want right now: venting, solving, or building?","ask_lane");
}

/* ---------- Sending ---------- */
function sendMessage(){
  const text = inputEl.value.trim();
  if (!text) return;
  addMessage("user", text);
  inputEl.value = "";
  simoReply(text);
}
sendBtn.addEventListener("click", sendMessage);
inputEl.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

/* ---------- Buttons ---------- */
clearBtn.addEventListener("click", () => {
  state.history = [];
  resetTopicState();
  state.memory.lastIntent = "";
  state.memory.lastTopic = "";
  state.memory.lastPreviewSpec = null;

  chatEl.innerHTML = "";
  previewArea.innerHTML = `<div class="small">No preview yet. Ask for one.</div>`;
  previewBadge.textContent = "Ready";
  setContextCards();
  setBadges();
  addMessage("simo", "Clean slate. I’m still here. What’s up?", "clean_slate");
});

togglePlanBtn.addEventListener("click", () => {
  state.plan = (state.plan === "pro") ? "free" : "pro";
  setBadges();
});

closeModalBtn.addEventListener("click", closeModal);
modalBackdrop.addEventListener("click", (e) => {
  if (e.target === modalBackdrop) closeModal();
});
enableProBtn.addEventListener("click", () => {
  state.plan = "pro";
  setBadges();
  closeModal();
  addMessage("simo","Alright — Pro is on. Now tell me exactly what you want me to generate.","pro_on");
});

/* ---------- Boot ---------- */
setBadges();
setContextCards();
addMessage("simo",
  "Hey. I’m here.\nIf you want visuals, say: “show me…” and include what you want on it.",
  "boot"
);
</script>
</body>
</html>
