<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simo</title>
  <style>
    :root{
      --bg:#0b1020; --text:#eaf0ff; --muted:#a9b6d3;
      --line:rgba(255,255,255,.10);
      --btn:#2a66ff; --btn2:#1f4dd6;
      --card:rgba(255,255,255,.04);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:radial-gradient(1200px 700px at 20% 0%, #162a66 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{font-weight:900;letter-spacing:.3px}
    .modes{display:flex;gap:8px;flex-wrap:wrap}
    .pill{
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:8px 10px;border-radius:999px;
      cursor:pointer;font-weight:800;
      opacity:.9;
    }
    .pill.active{background:linear-gradient(180deg,var(--btn),var(--btn2));border-color:rgba(42,102,255,.45)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
    .panel{
      border:1px solid var(--line);
      background:var(--card);
      border-radius:16px;
      padding:12px;
      min-height:560px;
    }
    .chatlog{height:450px;overflow:auto;padding:8px}
    .msg{margin:8px 0;padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:rgba(0,0,0,.14)}
    .msg.you{background:rgba(42,102,255,.14);border-color:rgba(42,102,255,.25)}
    .row{display:flex;gap:8px;margin-top:10px}
    input{
      flex:1;padding:12px 12px;border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    button{
      padding:12px 14px;border-radius:12px;border:1px solid rgba(42,102,255,.45);
      background:linear-gradient(180deg,var(--btn),var(--btn2));
      color:var(--text);font-weight:900;cursor:pointer;
    }
    .subrow{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:8px;color:var(--muted);font-size:13px}
    iframe{width:100%;height:520px;border:0;border-radius:12px;background:transparent}
    .hint{color:var(--muted);font-size:13px;margin-top:6px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} .panel{min-height:520px} iframe{height:480px} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">Simo</div>
      <div class="modes">
        <div class="pill active" data-mode="building">Building</div>
        <div class="pill" data-mode="solving">Solving</div>
        <div class="pill" data-mode="venting">Venting</div>
        <div class="pill" data-pro="toggle">Pro: <span id="proState">OFF</span></div>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <div class="chatlog" id="chatlog"></div>
        <div class="row">
          <input id="msg" placeholder='Try: "build landing page" then "change price to 19"' />
          <button id="send">Send</button>
        </div>
        <div class="subrow">
          <div>Mode: <span id="modeLabel">building</span></div>
          <div class="hint">Preview appears on the right when Pro is ON and Building mode is active.</div>
        </div>
      </div>

      <div class="panel">
        <iframe id="preview" title="preview"></iframe>
        <div class="hint" id="previewHint">No preview yet. Turn Pro ON + Building mode, then ask: “build landing page”.</div>
      </div>
    </div>
  </div>

<script>
(() => {
  const chatlog = document.getElementById("chatlog");
  const msg = document.getElementById("msg");
  const send = document.getElementById("send");
  const preview = document.getElementById("preview");
  const previewHint = document.getElementById("previewHint");
  const modeLabel = document.getElementById("modeLabel");
  const proState = document.getElementById("proState");

  let mode = "building";
  let pro = false;

  // Keep last preview so backend can edit it deterministically
  let current = {
    preview_html: "",
    preview_name: "landing_page"
  };

  function add(role, text) {
    const div = document.createElement("div");
    div.className = "msg " + (role === "you" ? "you" : "simo");
    div.textContent = (role === "you" ? "You: " : "Simo: ") + text;
    chatlog.appendChild(div);
    chatlog.scrollTop = chatlog.scrollHeight;
  }

  function setMode(next) {
    mode = next;
    modeLabel.textContent = mode;
    document.querySelectorAll(".pill[data-mode]").forEach(p => {
      p.classList.toggle("active", p.dataset.mode === mode);
    });
  }

  function setPro(next) {
    pro = next;
    proState.textContent = pro ? "ON" : "OFF";
  }

  document.querySelectorAll(".pill[data-mode]").forEach(p => {
    p.addEventListener("click", () => setMode(p.dataset.mode));
  });

  document.querySelector('.pill[data-pro="toggle"]').addEventListener("click", () => {
    setPro(!pro);
  });

  async function sendMsg() {
    const text = msg.value.trim();
    if (!text) return;
    msg.value = "";
    add("you", text);

    const payload = {
      message: text,
      mode,
      pro,
      current_preview_html: current.preview_html,
      current_preview_name: current.preview_name,
    };

    let data;
    try {
      const res = await fetch("/.netlify/functions/simon", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(payload),
      });
      data = await res.json();
    } catch (e) {
      add("simo", "Network error. Check your deploy.");
      return;
    }

    add("simo", data.reply || "Okay.");

    // Accept BOTH formats (old + new)
    const html = (data.preview && data.preview.html) || data.preview_html || "";
    const name = (data.preview && data.preview.name) || data.preview_name || "landing_page";

    if (html && mode === "building" && pro) {
      current.preview_html = html;
      current.preview_name = name;

      // IMPORTANT: render HTML in iframe srcdoc
      preview.srcdoc = html;
      previewHint.textContent = "Preview loaded.";
    }
  }

  send.addEventListener("click", sendMsg);
  msg.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMsg();
    }
  });

  add("simo", "Reset. I’m here.");
})();
</script>
</body>
</html>
