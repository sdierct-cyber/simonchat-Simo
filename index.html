<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Simo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; background:#0f172a; color:#e5e7eb; margin:0; display:flex; flex-direction:column; height:100vh; }
    header { padding:16px; font-size:18px; font-weight:600; background:#020617; }
    #chat { flex:1; padding:16px; overflow-y:auto; }
    .msg { margin-bottom:12px; line-height:1.4; white-space:pre-wrap; }
    .user { color:#93c5fd; }
    .simo { color:#e5e7eb; }
    form { display:flex; padding:12px; background:#020617; gap:8px; }
    input { flex:1; padding:12px; font-size:16px; border-radius:10px; border:none; outline:none; }
    button { padding:12px 16px; font-size:16px; border-radius:10px; border:none; cursor:pointer; background:#2563eb; color:white; }
    .meta { opacity:.55; font-size:12px; margin-top:4px; }
  </style>
</head>
<body>

<header>Hey — I’m Simo. What’s going on?</header>

<div id="chat"></div>

<form id="form">
  <input id="input" placeholder="Talk to Simo…" autocomplete="off" />
  <button type="submit">Send</button>
</form>

<script>
  const chatEl = document.getElementById("chat");
  const form = document.getElementById("form");
  const input = document.getElementById("input");

  // Keep the last ~20 turns to send as context
  const history = [];

  function add(role, text, meta) {
    const div = document.createElement("div");
    div.className = "msg " + role;
    div.textContent = (role === "user" ? "You: " : "Simo: ") + text;
    if (meta) {
      const m = document.createElement("div");
      m.className = "meta";
      m.textContent = meta;
      div.appendChild(m);
    }
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function pushHistory(role, content) {
    history.push({ role, content });
    if (history.length > 20) history.splice(0, history.length - 20);
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text) return;

    add("user", text);
    pushHistory("user", text);
    input.value = "";

    try {
      const res = await fetch("/.netlify/functions/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text, history })
      });

      const data = await res.json();
      const reply = (data && typeof data.reply === "string" && data.reply.trim()) ? data.reply : "…";

      add("simo", reply, data?.route ? `route: ${data.route}` : "");
      pushHistory("assistant", reply);

    } catch {
      add("simo", "I’m having trouble responding right now.");
      pushHistory("assistant", "I’m having trouble responding right now.");
    }
  });
</script>

</body>
</html>
