<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Simo</title>

<style>
:root{
  --bg:#0b1020;
  --panel:#121933;
  --panel2:#0e1530;
  --text:#eaf0ff;
  --muted:#a9b6d3;
  --line:rgba(255,255,255,.10);
  --accent:#2a66ff;
  --accent2:#1f4dd6;
  --warn:#ffcc66;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:radial-gradient(1200px 700px at 20% 0%, #162a66 0%, var(--bg) 55%);
  color:var(--text);
}

.wrap{max-width:980px;margin:0 auto;padding:18px}

.top{
  display:flex;align-items:center;justify-content:space-between;
  gap:12px;margin-bottom:12px;
}

.brand{
  font-size:22px;font-weight:700;letter-spacing:.2px;
}
.sub{font-size:12px;color:var(--muted);margin-top:2px}

.badgeRow{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
.badge{
  font-size:12px;color:var(--muted);
  border:1px solid var(--line);padding:6px 10px;border-radius:999px;
  background:rgba(255,255,255,.04);
}
.badge strong{color:var(--text);font-weight:700}

.grid{
  display:grid;
  grid-template-columns: 1.2fr .8fr;
  gap:12px;
}

@media (max-width: 920px){
  .grid{grid-template-columns: 1fr}
}

.card{
  background:rgba(255,255,255,.03);
  border:1px solid var(--line);
  border-radius:14px;
  overflow:hidden;
}

.cardHeader{
  padding:12px 12px 10px;
  border-bottom:1px solid var(--line);
  display:flex;align-items:center;justify-content:space-between;gap:10px;
}

.cardTitle{font-weight:700}
.cardHint{color:var(--muted);font-size:12px}

.chat{
  height:520px;
  overflow:auto;
  padding:12px;
}

.msg{
  margin:0 0 12px 0;
  line-height:1.5;
  font-size:14px;
}

.msg .who{
  display:inline-block;
  font-weight:700;
  margin-right:8px;
}

.msg.user .who{color:#fff}
.msg.simo .who{color:var(--muted)}

.bubble{
  display:inline-block;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.02);
  max-width: 95%;
  white-space:pre-wrap;
}

.msg.user .bubble{
  background:rgba(42,102,255,.10);
  border-color:rgba(42,102,255,.25);
}

.controls{
  padding:12px;
  border-top:1px solid var(--line);
  display:flex;
  gap:8px;
  align-items:flex-end;
  background:rgba(0,0,0,.10);
}

textarea{
  flex:1;
  height:52px;
  resize:none;
  border-radius:12px;
  border:1px solid var(--line);
  background:var(--panel2);
  color:var(--text);
  padding:10px 12px;
  font-size:14px;
  outline:none;
}

button{
  border:none;
  padding:12px 14px;
  border-radius:12px;
  font-weight:800;
  cursor:pointer;
  color:#fff;
  background:var(--accent);
}
button:hover{background:var(--accent2)}

.secondaryBtn{
  background:rgba(255,255,255,.06);
  border:1px solid var(--line);
  color:var(--text);
}
.secondaryBtn:hover{background:rgba(255,255,255,.10)}

.side{
  padding:12px;
}

.kv{
  display:flex;justify-content:space-between;gap:10px;
  padding:10px 10px;
  border:1px solid var(--line);
  border-radius:12px;
  background:rgba(255,255,255,.02);
  margin-bottom:10px;
  font-size:13px;
}
.kv span{color:var(--muted)}

.small{
  color:var(--muted);
  font-size:12px;
  line-height:1.4;
}

hr.sep{
  border:none;border-top:1px solid var(--line);
  margin:12px 0;
}

.previewWrap{
  padding:12px;
}

.previewCard{
  background:#fff;color:#111;
  border-radius:14px;
  padding:14px;
  border:1px solid rgba(0,0,0,.10);
}

.previewTitle{
  display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
}
.previewTitle h3{margin:0;font-size:16px}
.previewTitle .tag{
  font-size:11px;padding:6px 10px;border-radius:999px;
  border:1px solid rgba(0,0,0,.12);
  background:#f3f4f6;
}

.previewSub{color:#444;font-size:12px;margin:6px 0 10px}

.pillRow{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 10px}
.pill{
  font-size:11px;padding:6px 10px;border-radius:999px;
  border:1px solid #c7d2fe;
  background:#eef2ff;
}

.blockTitle{
  font-size:12px;
  font-weight:800;
  margin:12px 0 8px;
  color:#222;
}

.box{
  border:1px solid #e5e7eb;
  border-radius:12px;
  padding:10px;
  background:#f9fafb;
  margin-bottom:8px;
}

.grayBox{height:140px;background:#e5e7eb;border-radius:12px}

.modalBackdrop{
  position:fixed;inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;justify-content:center;
  padding:20px;
}

.modal{
  width:min(520px, 100%);
  border-radius:16px;
  border:1px solid var(--line);
  background:rgba(18,25,51,.98);
  padding:14px;
}

.modal h3{margin:0 0 6px 0}
.modal p{margin:0 0 12px 0;color:var(--muted);line-height:1.45;font-size:13px}
.modal .row{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}

.warnLine{
  border:1px dashed rgba(255,204,102,.45);
  background:rgba(255,204,102,.08);
  color:#ffe7b3;
  padding:10px 12px;
  border-radius:12px;
  font-size:12px;
  margin-top:10px;
}
</style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div>
      <div class="brand">Hey — I’m Simo.</div>
      <div class="sub">Best friend vibes by default. Builder + previews when you ask.</div>
    </div>
    <div class="badgeRow">
      <div class="badge">Plan: <strong id="planBadge">Free</strong></div>
      <div class="badge">Mode: <strong id="modeBadge">Friend</strong></div>
      <div class="badge">Focus: <strong id="focusBadge">—</strong></div>
      <div class="badge">Preview: <strong id="previewBadge">Ready</strong></div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="cardHeader">
        <div>
          <div class="cardTitle">Chat</div>
          <div class="cardHint">Enter to send • Shift+Enter for a new line</div>
        </div>
        <button class="secondaryBtn" id="clearBtn" type="button">Clear</button>
      </div>

      <div id="chat" class="chat"></div>

      <div class="controls">
        <textarea id="input" placeholder="Talk to Simo…"></textarea>
        <button id="sendBtn" type="button">Send</button>
      </div>
    </div>

    <div class="card">
      <div class="cardHeader">
        <div>
          <div class="cardTitle">Preview</div>
          <div class="cardHint">Ask: “show me a preview / mockup” + what you want on it</div>
        </div>
        <button class="secondaryBtn" id="togglePlanBtn" type="button">Toggle Pro</button>
      </div>

      <div class="side">
        <div class="kv"><span>Last intent</span><strong id="intentKV">—</strong></div>
        <div class="kv"><span>Project/topic</span><strong id="topicKV">—</strong></div>
        <div class="kv"><span>Preview modules</span><strong id="modulesKV">—</strong></div>

        <div class="small">
          You can switch gears anytime: “switch to venting / switch to solving / switch to building”.
        </div>

        <hr class="sep" />

        <div id="previewArea" class="previewWrap">
          <div class="small">No preview yet. Ask for one.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="modalBackdrop" class="modalBackdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <h3>That’s a Pro action</h3>
    <p>
      I can do that — but in the Free plan I keep it light. Toggle Pro to simulate paid upgrades.
      (Payment wiring comes later; this is UI + logic gate.)
    </p>
    <div class="row">
      <button class="secondaryBtn" id="closeModalBtn" type="button">Not now</button>
      <button id="enableProBtn" type="button">Enable Pro</button>
    </div>
    <div class="warnLine">
      This doesn’t charge anyone. It only flips the plan state.
    </div>
  </div>
</div>

<script>
const state = {
  plan: "free",              // free | pro (simulated)
  mode: "friend",            // friend | builder
  focus: "",                 // vent | solve | build (session focus)
  expectingLaneChoice: false,
  lastSimoKey: "",
  history: [],
  memory: {
    lastIntent: "",
    lastTopic: "",
    lastPreviewSpec: null,
  }
};

const chatEl = document.getElementById("chat");
const inputEl = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");

const clearBtn = document.getElementById("clearBtn");
const togglePlanBtn = document.getElementById("togglePlanBtn");

const planBadge = document.getElementById("planBadge");
const modeBadge = document.getElementById("modeBadge");
const focusBadge = document.getElementById("focusBadge");
const previewBadge = document.getElementById("previewBadge");

const intentKV = document.getElementById("intentKV");
const topicKV = document.getElementById("topicKV");
const modulesKV = document.getElementById("modulesKV");
const previewArea = document.getElementById("previewArea");

const modalBackdrop = document.getElementById("modalBackdrop");
const closeModalBtn = document.getElementById("closeModalBtn");
const enableProBtn = document.getElementById("enableProBtn");

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function nowTs(){ return new Date().toISOString(); }

function setBadges(){
  planBadge.textContent = state.plan === "pro" ? "Pro" : "Free";
  modeBadge.textContent = state.mode === "builder" ? "Builder" : "Friend";
  focusBadge.textContent = state.focus ? state.focus.toUpperCase() : "—";
}

function setContextCards(){
  intentKV.textContent = state.memory.lastIntent || "—";
  topicKV.textContent = state.memory.lastTopic || "—";
  modulesKV.textContent = state.memory.lastPreviewSpec?.modules?.length
    ? state.memory.lastPreviewSpec.modules.join(", ")
    : "—";
}

function openModal(){ modalBackdrop.style.display = "flex"; }
function closeModal(){ modalBackdrop.style.display = "none"; }

function addMessage(role, text, key=""){
  state.history.push({ role, text, ts: nowTs() });

  const msg = document.createElement("div");
  msg.className = "msg " + (role === "user" ? "user" : "simo");

  const who = document.createElement("span");
  who.className = "who";
  who.textContent = role === "user" ? "You:" : "Simo:";

  const bubble = document.createElement("span");
  bubble.className = "bubble";
  bubble.innerHTML = escapeHtml(text);

  msg.appendChild(who);
  msg.appendChild(bubble);
  chatEl.appendChild(msg);
  chatEl.scrollTop = chatEl.scrollHeight;

  if (role === "simo" && key) state.lastSimoKey = key;
}

function detectIntent(text){
  const t = text.toLowerCase();

  // Explicit lane choices / switching
  if (/(switch to|let's|lets)\s+(vent|venting)/i.test(text) || /\bvent(ing)?\b/.test(t)) return "lane_vent";
  if (/(switch to|let's|lets)\s+(solve|solving|problem solve|problem solving)/i.test(text) || /\b(problem\s*solv|solv(ing|e))\b/.test(t)) return "lane_solve";
  if (/(switch to|let's|lets)\s+(build|building|create|design)/i.test(text) || /\b(build(ing)?|create|design)\b/.test(t)) return "lane_build";

  if (/(show me|make|build).*(preview|mockup)/i.test(text) || /(preview|mockup)/i.test(text)) return "preview";
  if (/(write|draft|email|resume|cover letter|bio|script|story|book)/i.test(text)) return "write";
  if (/(code|html|css|js|javascript|react|bug|fix|error)/i.test(text)) return "code";
  if (/(design|ui|ux|layout|wireframe)/i.test(text)) return "design";
  if (/(stressed|tired|argument|anxious|overwhelmed|mad|upset|drained)/i.test(text)) return "vent";

  // “help me with my idea / software idea” is SOLVE/BUILD leaning
  if (/(help me|idea|software idea|startup|app idea|business idea)/i.test(text)) return "solve";

  return "chat";
}

function inferTopic(text){
  const raw = (text || "").trim();
  if (!raw) return "";

  const m1 = raw.match(/(?:preview|mockup)\s+(?:of|for)\s+(.+)$/i);
  if (m1 && m1[1]) return shorten(cleanTopic(m1[1]));

  const m2 = raw.match(/(?:build|create|design)\s+(?:me|a|an)\s+(.+)$/i);
  if (m2 && m2[1]) return shorten(cleanTopic(m2[1]));

  // If they say “my software idea” we keep it, but short
  return shorten(raw);
}

function cleanTopic(s){
  return s
    .replace(/[?.!]+$/g, "")
    .replace(/\b(show me|a|an|the|quick|simple|one-page|ui|mockup|preview)\b/ig, "")
    .replace(/\s+/g, " ")
    .trim();
}

function shorten(s){
  if (!s) return "";
  return s.length > 56 ? (s.slice(0, 56).trim() + "…") : s;
}

function parsePreviewModules(text){
  const t = (text || "").toLowerCase();
  const modules = [];
  if (t.includes("search")) modules.push("search");
  if (t.includes("filter") || t.includes("chip")) modules.push("filters");
  if (t.includes("card") || t.includes("listing") || t.includes("results")) modules.push("cards");
  if (t.includes("map") || t.includes("image") || t.includes("visual")) modules.push("map");
  if (t.includes("booking") || t.includes("checkout") || t.includes("reserve") || t.includes("submit")) modules.push("action panel");
  if (t.includes("profile")) modules.push("profile");
  if (t.includes("settings")) modules.push("settings");
  if (modules.length === 0) modules.push("search","filters","cards","map","action panel");
  return [...new Set(modules)];
}

function renderPreview(spec){
  const title = spec.title || "UI Mockup Template";
  const modules = spec.modules || [];
  const notes = spec.notes || "Generic preview template (adapts to your request).";
  const parts = [];

  parts.push(`
    <div class="previewCard">
      <div class="previewTitle">
        <div>
          <h3>${escapeHtml(title)}</h3>
          <div class="previewSub">${escapeHtml(notes)}</div>
        </div>
        <div class="tag">Preview</div>
      </div>
  `);

  if (modules.includes("search")){
    parts.push(`<div class="blockTitle">Search / Input</div><div class="box">Type here…</div>`);
  }
  if (modules.includes("filters")){
    parts.push(`
      <div class="blockTitle">Filters</div>
      <div class="pillRow">
        <div class="pill">Filter A</div><div class="pill">Filter B</div><div class="pill">Filter C</div>
      </div>
    `);
  }
  if (modules.includes("cards")){
    parts.push(`
      <div class="blockTitle">Results / Cards</div>
      <div class="box"><strong>Item One</strong><br/>Short description • status/price • CTA</div>
      <div class="box"><strong>Item Two</strong><br/>Short description • status/price • CTA</div>
      <div class="box"><strong>Item Three</strong><br/>Short description • status/price • CTA</div>
    `);
  }
  if (modules.includes("map")){
    parts.push(`<div class="blockTitle">Main Visual / Map / Image Area</div><div class="grayBox"></div>`);
  }
  if (modules.includes("action panel")){
    parts.push(`<div class="blockTitle">Action Panel</div><div class="box">Primary action: Book / Submit / Checkout / Save</div>`);
  }
  if (modules.includes("profile")){
    parts.push(`<div class="blockTitle">Profile</div><div class="box">Avatar • Name • Bio • Saved items</div>`);
  }
  if (modules.includes("settings")){
    parts.push(`<div class="blockTitle">Settings</div><div class="box">Notifications • Privacy • Account</div>`);
  }

  parts.push(`</div>`);
  previewArea.innerHTML = parts.join("");
}

function isProAction(text){
  const t = text.toLowerCase();
  if (/(generate|create|build).*(full|complete).*(code|website|app)/i.test(text)) return true;
  if (/(make|generate).*(image|logo|cover|art)/i.test(text)) return true;
  if (/(export|download|pdf|docx|pptx)/i.test(text)) return true;
  if (/(connect|api key|openai|billing|stripe)/i.test(text)) return true;
  return false;
}

/* ==========
   Focus helpers
========== */
function setFocus(f){
  state.focus = f;               // vent | solve | build
  state.expectingLaneChoice = false;
  setBadges();
}

function askLaneOnce(){
  // If we already asked this last time, don't repeat it.
  if (state.lastSimoKey === "ask_lane") return;

  state.expectingLaneChoice = true;
  addMessage("simo",
    "I’m here.\nTell me what you want right now: venting, solving, or building?",
    "ask_lane"
  );
}

function handleLaneChoice(intent){
  if (intent === "lane_vent"){ setFocus("vent"); return true; }
  if (intent === "lane_solve"){ setFocus("solve"); return true; }
  if (intent === "lane_build"){ setFocus("build"); return true; }
  return false;
}

function nextPromptForFocus(){
  if (state.focus === "vent"){
    state.mode = "friend";
    setBadges();
    addMessage("simo", "Alright — vent. What happened, and what part hit you the hardest?", "vent_prompt");
    return;
  }
  if (state.focus === "solve"){
    state.mode = "builder";
    setBadges();
    addMessage("simo",
      "Alright — problem solving.\nGive me:\n1) the goal (one sentence)\n2) what’s blocking you\n3) what you’ve tried",
      "solve_prompt"
    );
    return;
  }
  if (state.focus === "build"){
    state.mode = "builder";
    setBadges();
    addMessage("simo",
      "Alright — we’re building.\nWhat is it, who’s it for, and your top 3 must-haves?",
      "build_prompt"
    );
    return;
  }
}

function simoReply(userText){
  const intent = detectIntent(userText);
  state.memory.lastIntent = intent;

  const topic = inferTopic(userText);
  if (topic) state.memory.lastTopic = topic;

  // Lane choice or switch
  if (handleLaneChoice(intent)){
    setContextCards();
    nextPromptForFocus();
    return;
  }

  // If Simo asked for lane choice and user answered in plain English like "problem solving"
  if (state.expectingLaneChoice){
    // detectIntent already maps "problem solving" to lane_solve via regex, but keep a safety net:
    const t = userText.toLowerCase();
    if (t.includes("problem") || t.includes("solve") || t.includes("solving")){
      setFocus("solve");
      setContextCards();
      nextPromptForFocus();
      return;
    }
    if (t.includes("vent") || t.includes("talk") || t.includes("feel")){
      setFocus("vent");
      setContextCards();
      nextPromptForFocus();
      return;
    }
    if (t.includes("build") || t.includes("create") || t.includes("design")){
      setFocus("build");
      setContextCards();
      nextPromptForFocus();
      return;
    }
    // If they didn't choose, ask once (no loop)
    askLaneOnce();
    setContextCards();
    return;
  }

  // Preview
  if (intent === "preview"){
    const modules = parsePreviewModules(userText);
    const title = state.memory.lastTopic ? `Mockup: ${state.memory.lastTopic}` : "UI Mockup Template";
    state.memory.lastPreviewSpec = {
      title,
      modules,
      notes: "Tell me what you want changed (sections, layout, flow)."
    };
    previewBadge.textContent = "Shown";
    renderPreview(state.memory.lastPreviewSpec);
    setContextCards();

    // Focus stays; preview is just a tool
    addMessage("simo",
      "Preview’s on the right. What should I adjust first — layout, features, or the user flow?",
      "preview_next"
    );
    return;
  }

  // Pro gating
  if (state.plan !== "pro" && isProAction(userText)){
    addMessage("simo",
      "I can do that — but that’s a paid-upgrade type action.\nToggle Pro (top right) and I’ll treat it like the upgraded plan.",
      "pro_gate"
    );
    openModal();
    setContextCards();
    return;
  }

  // If user says “hello?” don’t throw the lane question again—respond naturally
  if (/^(hello|hi|hey|\?+|hello\?)$/i.test(userText.trim())){
    if (state.focus){
      addMessage("simo", `Hey. I’m here. We’re in ${state.focus.toUpperCase()} — want to continue?`, "hello_focus");
    } else {
      addMessage("simo", "Hey. I’m here. What do you need right now?", "hello_plain");
      // don’t auto ask lane; let them talk
    }
    setContextCards();
    return;
  }

  // If we already have a focus, keep moving in that direction instead of asking lane again.
  if (state.focus){
    setContextCards();
    if (state.focus === "solve"){
      state.mode = "builder"; setBadges();
      addMessage("simo",
        "Okay. Give me the details:\n• Goal\n• Constraints\n• What success looks like\nThen I’ll map the next steps.",
        "solve_continue"
      );
      return;
    }
    if (state.focus === "build"){
      state.mode = "builder"; setBadges();
      addMessage("simo",
        "Okay. What are we building — and what’s the first screen the user sees?",
        "build_continue"
      );
      return;
    }
    if (state.focus === "vent"){
      state.mode = "friend"; setBadges();
      addMessage("simo",
        "Talk to me. What set it off?",
        "vent_continue"
      );
      return;
    }
  }

  // Otherwise: ask lane ONCE (no repetition)
  setContextCards();
  askLaneOnce();
}

function sendMessage(){
  const text = inputEl.value.trim();
  if (!text) return;
  addMessage("user", text);
  inputEl.value = "";
  simoReply(text);
}

sendBtn.addEventListener("click", sendMessage);

inputEl.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

clearBtn.addEventListener("click", () => {
  state.history = [];
  state.focus = "";
  state.expectingLaneChoice = false;
  state.lastSimoKey = "";
  state.memory.lastIntent = "";
  state.memory.lastTopic = "";
  state.memory.lastPreviewSpec = null;

  chatEl.innerHTML = "";
  previewArea.innerHTML = `<div class="small">No preview yet. Ask for one.</div>`;
  previewBadge.textContent = "Ready";
  setContextCards();
  setBadges();

  addMessage("simo", "Clean slate. I’m still here. What’s up?", "clean_slate");
});

togglePlanBtn.addEventListener("click", () => {
  state.plan = (state.plan === "pro") ? "free" : "pro";
  setBadges();
});

closeModalBtn.addEventListener("click", closeModal);
modalBackdrop.addEventListener("click", (e) => {
  if (e.target === modalBackdrop) closeModal();
});
enableProBtn.addEventListener("click", () => {
  state.plan = "pro";
  setBadges();
  closeModal();
  addMessage("simo", "Alright — Pro is on. Now tell me exactly what you want me to generate.", "pro_on");
});

setBadges();
setContextCards();
addMessage("simo",
  "Hey. I’m here.\nIf you want visuals, say: “show me a preview” and include what you want on it.",
  "boot"
);
</script>
</body>
</html>
