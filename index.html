<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simo</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg:#0b1020; --text:#eaf0ff; --muted:#a9b6d3;
      --line:rgba(255,255,255,.10);
      --btn:#2a66ff; --btn2:#1f4dd6;
      --good:#39ff7a;
      --bad:#ff4d4d;
      --shadow:0 14px 34px rgba(0,0,0,.35);
      --card:rgba(255,255,255,.06);
      --chip:rgba(255,255,255,.08);
      --chip2:rgba(57,255,122,.12);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:radial-gradient(1200px 700px at 20% 0%, #162a66 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{max-width:1120px;margin:0 auto;padding:18px}
    .top{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:800; letter-spacing:.3px;
    }
    .dot{
      width:12px;height:12px;border-radius:99px;
      background:linear-gradient(180deg,var(--btn),#7aa2ff);
      box-shadow:0 0 0 5px rgba(42,102,255,.15);
    }
    .statusRow{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      background:var(--chip);
      border:1px solid var(--line);
      color:var(--muted);
      font-size:13px;
      user-select:none;
    }
    .chip strong{color:var(--text); font-weight:700}
    .chip.good{background:var(--chip2); border-color:rgba(57,255,122,.25); color:rgba(234,240,255,.95)}
    .chip .pill{
      width:8px;height:8px;border-radius:99px;background:rgba(255,255,255,.35);
    }
    .chip.good .pill{background:var(--good); box-shadow:0 0 12px rgba(57,255,122,.55)}
    .btn{
      border:1px solid var(--line);
      background:linear-gradient(180deg,var(--btn),var(--btn2));
      color:white;
      padding:10px 12px;
      border-radius:12px;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 10px 24px rgba(42,102,255,.25);
    }
    .btn:active{transform:translateY(1px)}
    .btn.ghost{
      background:transparent;
      box-shadow:none;
      color:var(--text);
    }
    .btn.small{padding:8px 10px; border-radius:12px; font-size:13px}
    .btn.locked{
      opacity:.55; cursor:not-allowed;
      background:rgba(255,255,255,.06);
      box-shadow:none;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background:linear-gradient(180deg,var(--card),rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.10);
    }
    .cardHead .title{
      font-weight:800; letter-spacing:.2px;
      display:flex; align-items:center; gap:8px;
    }
    .subtle{color:var(--muted); font-size:13px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

    /* Chat */
    .chat{display:flex; flex-direction:column; height:600px;}
    .log{padding:14px; overflow:auto; flex:1;}
    .msg{display:flex; gap:10px; margin:10px 0; align-items:flex-start;}
    .bubble{
      max-width:88%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      line-height:1.35;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .me .bubble{background:rgba(42,102,255,.18); border-color:rgba(42,102,255,.35);}
    .who{
      width:34px;height:34px;border-radius:12px;
      display:grid; place-items:center;
      background:rgba(255,255,255,.07);
      border:1px solid var(--line);
      color:rgba(234,240,255,.9);
      font-weight:900;
      flex:0 0 auto;
    }
    .me .who{background:rgba(42,102,255,.16); border-color:rgba(42,102,255,.35);}
    .composer{
      border-top:1px solid var(--line);
      padding:12px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      background:rgba(0,0,0,.12);
    }
    textarea{
      width:100%;
      min-height:44px;
      max-height:140px;
      resize:vertical;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--text);
      padding:10px 12px;
      outline:none;
      font:inherit;
    }
    textarea:focus{border-color:rgba(42,102,255,.55); box-shadow:0 0 0 4px rgba(42,102,255,.16)}
    .actions{
      display:flex; gap:8px; align-items:flex-end; flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* Preview */
    .preview{height:600px; display:flex; flex-direction:column;}
    .frameWrap{flex:1; background:rgba(0,0,0,.2);}
    iframe{width:100%; height:100%; border:0; background:transparent;}
    .hint{
      padding:10px 12px;
      border-top:1px solid var(--line);
      color:var(--muted);
      font-size:13px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      background:rgba(0,0,0,.10);
    }
    .tag{
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--muted);
      font-size:12px;
    }
    .tag.good{
      border-color:rgba(57,255,122,.28);
      background:rgba(57,255,122,.10);
      color:rgba(234,240,255,.92);
    }

    /* Modals */
    .modalOverlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{
      width:min(520px, 100%);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border:1px solid var(--line);
      border-radius:20px;
      box-shadow:0 20px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHead{
      padding:14px 14px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.10);
    }
    .modalBody{padding:14px}
    .row{display:flex; gap:10px; align-items:center}
    input[type="text"]{
      width:100%;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--text);
      padding:10px 12px;
      outline:none;
      font:inherit;
    }
    input[type="text"]:focus{border-color:rgba(42,102,255,.55); box-shadow:0 0 0 4px rgba(42,102,255,.16)}
    .note{color:var(--muted); font-size:13px; margin-top:10px; line-height:1.35}
    .list{margin:10px 0 0; padding:0; list-style:none;}
    .list li{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
      padding:10px 10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      border-radius:14px;
      margin-bottom:10px;
    }
    .list .name{font-weight:800}
    .list .meta{color:var(--muted); font-size:12px}
    .danger{
      background:rgba(255,77,77,.12);
      border-color:rgba(255,77,77,.28);
      color:rgba(234,240,255,.95);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <span class="dot"></span>
        <div>
          <div style="font-size:18px; line-height:1; font-weight:900;">Simo</div>
          <div class="subtle" style="margin-top:3px;">Checkpoint V1.1 — intent stability</div>
        </div>
      </div>

      <div class="statusRow">
        <div id="modeChip" class="chip"><span class="pill"></span> Mode: <strong id="modeText">building</strong></div>
        <div id="proChip" class="chip"><span class="pill"></span> Pro: <strong id="proText">OFF</strong></div>
        <button id="proBtn" class="btn small">Unlock Pro</button>
      </div>
    </div>

    <div class="grid">
      <!-- Chat -->
      <div class="card chat">
        <div class="cardHead">
          <div class="title">Chat</div>
          <div class="subtle" id="statusText">Ready</div>
        </div>

        <div id="log" class="log"></div>

        <div class="composer">
          <textarea id="input" placeholder="Enter to send • Shift+Enter for new line"></textarea>
          <div class="actions">
            <button id="previewBtn" class="btn ghost small">Preview</button>
            <button id="downloadBtn" class="btn ghost small">Download</button>
            <button id="saveBtn" class="btn ghost small locked" title="Pro required">Save</button>
            <button id="libraryBtn" class="btn ghost small locked" title="Pro required">Library</button>
            <button id="sendBtn" class="btn">Send</button>
          </div>
        </div>
      </div>

      <!-- Preview -->
      <div class="card preview">
        <div class="cardHead">
          <div class="title">Preview</div>
          <div class="subtle mono" id="previewLabel">No preview yet</div>
        </div>

        <div class="frameWrap">
          <!-- IMPORTANT: srcdoc prevents white block even if JS fails -->
          <iframe
            id="frame"
            sandbox="allow-scripts allow-forms allow-same-origin"
            srcdoc="<!doctype html><html><head><meta charset='utf-8'><style>body{margin:0;font-family:system-ui;background:#0b1020;color:#a9b6d3;display:grid;place-items:center;height:100vh} .box{border:1px solid rgba(255,255,255,.12);padding:14px 16px;border-radius:14px;background:rgba(255,255,255,.05)}</style></head><body><div class='box'>No preview yet.</div></body></html>"
          ></iframe>
        </div>

        <div class="hint">
          <div>
            <span class="tag" id="topicTag">topic: none</span>
            <span class="tag" id="draftTag">draft: none</span>
          </div>
          <div class="subtle">Tip: say “show me a preview” in Build mode</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Pro Modal -->
  <div id="proModal" class="modalOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <div style="font-weight:900;">Unlock Pro</div>
        <button id="proClose" class="btn ghost small">Close</button>
      </div>
      <div class="modalBody">
        <div class="subtle">Enter your license key to enable Pro features (Save / Library).</div>
        <div class="row" style="margin-top:10px;">
          <input id="proKey" type="text" placeholder="SIMO-XXXX-XXXX" autocomplete="off" />
          <button id="proVerify" class="btn small">Verify</button>
        </div>
        <div id="proMsg" class="note"></div>
        <div class="note">Pro status is saved in this browser.</div>
      </div>
    </div>
  </div>

  <!-- Library Modal -->
  <div id="libModal" class="modalOverlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHead">
        <div style="font-weight:900;">Library</div>
        <button id="libClose" class="btn ghost small">Close</button>
      </div>
      <div class="modalBody">
        <div class="subtle">Saved builds (Pro)</div>
        <ul id="libList" class="list"></ul>
        <button id="libClear" class="btn ghost small danger">Clear Library</button>
      </div>
    </div>
  </div>

  <script>
    (() => {
      // -------------------------
      // Helpers
      // -------------------------
      const $ = (id) => document.getElementById(id);
      const sleep = (ms) => new Promise(r => setTimeout(r, ms));
      const nowISO = () => new Date().toISOString();

      function safeJSONParse(s, fallback) {
        try { return JSON.parse(s); } catch { return fallback; }
      }

      function stripCodeFences(text){
        const fence = /```(?:html)?\s*([\s\S]*?)```/i.exec(text || "");
        if (fence && fence[1]) return fence[1].trim();
        return null;
      }

      function looksLikeHTML(s){
        if(!s) return false;
        const t = s.trim().toLowerCase();
        return t.startsWith("<!doctype html") || t.startsWith("<html") || t.includes("<head") || t.includes("<body");
      }

      function makeFilename(){
        const d = new Date();
        const pad = (n)=>String(n).padStart(2,"0");
        return `simo_build_${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}.html`;
      }

      // -------------------------
      // State (Intent Stability Layer)
      // -------------------------
      const STATE_KEY = "simo_state_v11";
      const PRO_KEY   = "simo_pro_v1";
      const LIB_KEY   = "simo_library_v1";

      const defaultState = {
        mode: "building",        // "venting" | "solving" | "building"
        topic: "",               // short anchor
        lastUser: "",
        lastAssistant: "",
        draftHtml: "",           // current working HTML
        draftName: "",
        draftUpdatedAt: "",
        buildHistory: []
      };

      let state = Object.assign({}, defaultState, safeJSONParse(localStorage.getItem(STATE_KEY), {}));
      let pro   = safeJSONParse(localStorage.getItem(PRO_KEY), { pro:false, key:"" });

      // -------------------------
      // Elements
      // -------------------------
      const logEl = $("log");
      const inputEl = $("input");
      const sendBtn = $("sendBtn");
      const previewBtn = $("previewBtn");
      const downloadBtn = $("downloadBtn");
      const saveBtn = $("saveBtn");
      const libraryBtn = $("libraryBtn");
      const frameEl = $("frame");
      const statusText = $("statusText");
      const previewLabel = $("previewLabel");
      const proChip = $("proChip");
      const proText = $("proText");
      const proBtn = $("proBtn");
      const proModal = $("proModal");
      const proClose = $("proClose");
      const proKey = $("proKey");
      const proVerify = $("proVerify");
      const proMsg = $("proMsg");

      const libModal = $("libModal");
      const libClose = $("libClose");
      const libList = $("libList");
      const libClear = $("libClear");

      const modeChip = $("modeChip");
      const modeText = $("modeText");
      const topicTag = $("topicTag");
      const draftTag = $("draftTag");

      // Prevent double-boot (Netlify can sometimes rehydrate fast)
      let booted = false;

      // -------------------------
      // Render functions
      // -------------------------
      function saveState(){
        localStorage.setItem(STATE_KEY, JSON.stringify(state));
      }

      function setStatus(s){
        statusText.textContent = s;
      }

      function setMode(mode){
        state.mode = mode;
        saveState();
        modeText.textContent = mode;
        if(mode === "building"){
          modeChip.classList.add("good");
        }else{
          modeChip.classList.remove("good");
        }
      }

      function setTopic(t){
        state.topic = (t || "").trim();
        saveState();
        topicTag.textContent = `topic: ${state.topic || "none"}`;
      }

      function setDraftMeta(){
        draftTag.textContent = `draft: ${state.draftName || "none"}`;
        previewLabel.textContent = state.draftUpdatedAt ? `Updated ${state.draftUpdatedAt}` : "No preview yet";
      }

      function setProUI(){
        const isPro = !!pro.pro;
        proText.textContent = isPro ? "ON" : "OFF";
        proChip.classList.toggle("good", isPro);
        proBtn.textContent = isPro ? "Pro Enabled" : "Unlock Pro";
        proBtn.classList.toggle("locked", isPro);

        saveBtn.classList.toggle("locked", !isPro);
        libraryBtn.classList.toggle("locked", !isPro);
        saveBtn.title = isPro ? "" : "Pro required";
        libraryBtn.title = isPro ? "" : "Pro required";
      }

      function addMsg(who, text){
        const row = document.createElement("div");
        row.className = "msg " + (who === "me" ? "me" : "simo");
        const whoEl = document.createElement("div");
        whoEl.className = "who";
        whoEl.textContent = who === "me" ? "You" : "S";
        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.textContent = text;
        row.appendChild(whoEl);
        row.appendChild(bubble);
        logEl.appendChild(row);
        logEl.scrollTop = logEl.scrollHeight;
      }

      function setPreview(html){
        if(!html || !looksLikeHTML(html)) return false;
        frameEl.srcdoc = html;
        state.draftHtml = html;
        state.draftUpdatedAt = new Date().toLocaleString();
        if(!state.draftName) state.draftName = "untitled";
        saveState();
        setDraftMeta();
        return true;
      }

      // -------------------------
      // Intent inference
      // -------------------------
      function inferMode(text){
        const t = (text || "").toLowerCase().trim();
        if(!t) return state.mode;

        if(/\bvent(ing)?\b/.test(t)) return "venting";
        if(/\bsolv(ing|e)?\b/.test(t)) return "solving";
        if(/\bbuild(ing)?\b/.test(t)) return "building";

        if(/\b(stressed|anxious|sad|tired|overwhelmed|hurt|upset|mad|angry|depressed|lonely)\b/.test(t)) return "venting";
        if(/\b(help me|what should i do|how do i|steps|fix|debug|error|issue|problem|troubleshoot|why)\b/.test(t)) return "solving";
        if(/\b(build|make|create|design|landing page|website|app|ui|mockup|preview|html|css|pricing|testimonials|faq)\b/.test(t)) return "building";

        return state.mode;
      }

      function inferTopic(text){
        const t = (text || "").trim();
        if(!t) return state.topic;

        const low = t.toLowerCase();
        if(low.startsWith("switch topics")){
          return t.replace(/switch topics[:,]?\s*/i, "").trim() || "";
        }
        if(/landing page/i.test(t)) return "landing page";
        if(/\bfitness\b/i.test(t)) return "fitness site";
        if(/\bspace renting\b/i.test(t)) return "space renting app";
        if(/\bresume\b/i.test(t)) return "resume";
        if(/\b2 story\b|\bfloor plan\b|\bhome layout\b/i.test(t)) return "home layout";
        if(/\bbook cover\b/i.test(t)) return "book cover";
        return state.topic;
      }

      function userWantsPreview(text){
        const t = (text || "").toLowerCase();
        return /\b(show|open|render|update)\b.*\bpreview\b/.test(t) || /\bpreview\b/.test(t);
      }

      function shouldAutoPreview(text){
        const wants = userWantsPreview(text);
        if(state.mode !== "building") return wants;

        const t = (text || "").toLowerCase();
        if(wants) return true;

        const editCmd =
          t.startsWith("headline:") ||
          t.startsWith("cta:") ||
          t.startsWith("price:") ||
          t.includes("add faq") || t.includes("remove faq") ||
          t.includes("add pricing") || t.includes("remove pricing") ||
          t.includes("add testimonials") || t.includes("remove testimonials") ||
          t.includes("continue") || t.includes("update") || t.includes("revise");

        return editCmd;
      }

      // -------------------------
      // Library (Pro)
      // -------------------------
      function getLibrary(){
        return safeJSONParse(localStorage.getItem(LIB_KEY), []);
      }
      function setLibrary(items){
        localStorage.setItem(LIB_KEY, JSON.stringify(items || []));
      }

      function renderLibrary(){
        const items = getLibrary();
        libList.innerHTML = "";
        if(!items.length){
          const li = document.createElement("li");
          li.innerHTML = `<div><div class="name">No saved builds</div><div class="meta">Save something first.</div></div>`;
          libList.appendChild(li);
          return;
        }
        items.forEach((it, idx) => {
          const li = document.createElement("li");
          const left = document.createElement("div");
          left.innerHTML = `<div class="name">${it.name || "untitled"}</div><div class="meta">${it.savedAt || ""}</div>`;
          const right = document.createElement("div");
          right.style.display = "flex";
          right.style.gap = "8px";

          const loadBtn = document.createElement("button");
          loadBtn.className = "btn ghost small";
          loadBtn.textContent = "Load";
          loadBtn.onclick = () => {
            state.draftHtml = it.html || "";
            state.draftName = it.name || "untitled";
            state.draftUpdatedAt = new Date().toLocaleString();
            setTopic(it.topic || state.topic);
            saveState();
            if(state.draftHtml) setPreview(state.draftHtml);
            closeLib();
            addMsg("simo", `Loaded “${state.draftName}”. What do you want to change?`);
          };

          const delBtn = document.createElement("button");
          delBtn.className = "btn ghost small danger";
          delBtn.textContent = "Delete";
          delBtn.onclick = () => {
            const next = getLibrary().filter((_, i) => i !== idx);
            setLibrary(next);
            renderLibrary();
          };

          right.appendChild(loadBtn);
          right.appendChild(delBtn);

          li.appendChild(left);
          li.appendChild(right);
          libList.appendChild(li);
        });
      }

      function openLib(){
        if(!pro.pro) return;
        renderLibrary();
        libModal.style.display = "flex";
      }
      function closeLib(){ libModal.style.display = "none"; }

      // -------------------------
      // Pro verification
      // -------------------------
      function openProModal(){
        proMsg.textContent = "";
        proKey.value = "";
        proModal.style.display = "flex";
        setTimeout(()=>proKey.focus(), 50);
      }
      function closeProModal(){ proModal.style.display = "none"; }

      async function verifyProKey(key){
        const res = await fetch("/.netlify/functions/pro", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ key })
        });
        const data = await res.json().catch(()=> ({}));
        if(!res.ok) throw new Error(data?.error || "Verification failed");
        return data;
      }

      // -------------------------
      // Backend chat
      // -------------------------
      async function sendToBackend(userText){
        const payload = {
          message: userText,
          mode: state.mode,
          topic: state.topic,
          draft_html: state.draftHtml || "",
          draft_name: state.draftName || "",
          last_user: state.lastUser || "",
          last_assistant: state.lastAssistant || "",
          pro: !!pro.pro
        };

        const res = await fetch("/.netlify/functions/simon", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(()=> ({}));
        if(!res.ok){
          const msg = data?.error || data?.details || "OpenAI error";
          throw new Error(typeof msg === "string" ? msg : "OpenAI error");
        }
        return data;
      }

      function normalizeAssistantText(data){
        if(!data) return "";
        if(typeof data === "string") return data;
        return data.reply || data.text || data.message || data.output || "";
      }

      function extractHtmlFromResponse(text){
        const fenced = stripCodeFences(text);
        if(fenced && looksLikeHTML(fenced)) return fenced;
        if(looksLikeHTML(text)) return text.trim();
        return null;
      }

      // -------------------------
      // Main send
      // -------------------------
      let sending = false;

      async function onSend(){
        if(sending) return;
        const userText = (inputEl.value || "").trim();
        if(!userText) return;

        const nextMode = inferMode(userText);
        setMode(nextMode);

        const nextTopic = inferTopic(userText);
        if(nextTopic !== state.topic) setTopic(nextTopic);

        addMsg("me", userText);
        inputEl.value = "";
        setStatus("Thinking…");
        sending = true;
        sendBtn.classList.add("locked");
        sendBtn.textContent = "…";

        try{
          const data = await sendToBackend(userText);
          const assistantText = normalizeAssistantText(data) || "(no response)";
          addMsg("simo", assistantText);

          state.lastUser = userText;
          state.lastAssistant = assistantText;
          state.buildHistory = (state.buildHistory || []).slice(-8);
          state.buildHistory.push({ t: nowISO(), mode: state.mode, topic: state.topic });
          saveState();

          const html = extractHtmlFromResponse(assistantText);
          const doPreview = shouldAutoPreview(userText);

          if(html && doPreview){
            if(!state.draftName){
              state.draftName = state.topic ? `${state.topic}` : "untitled";
            }
            setPreview(html);
          }

          if(data && typeof data.html === "string" && looksLikeHTML(data.html)){
            const doPrev2 = shouldAutoPreview(userText);
            if(doPrev2) setPreview(data.html);
          }

          setStatus("Ready");
        }catch(err){
          addMsg("simo", `⚠️ ${err?.message || "Error"}`);
          setStatus("Ready");
        }finally{
          sending = false;
          sendBtn.classList.remove("locked");
          sendBtn.textContent = "Send";
        }
      }

      // -------------------------
      // Other actions
      // -------------------------
      function manualPreview(){
        if(state.draftHtml && looksLikeHTML(state.draftHtml)){
          setPreview(state.draftHtml);
          addMsg("simo", "Preview refreshed.");
        }else{
          addMsg("simo", "No draft HTML yet. Ask me to build something (or say: show me a preview).");
        }
      }

      function downloadHTML(){
        if(!state.draftHtml || !looksLikeHTML(state.draftHtml)){
          addMsg("simo", "Nothing to download yet. Build a page/app first.");
          return;
        }
        const blob = new Blob([state.draftHtml], {type:"text/html;charset=utf-8"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = makeFilename();
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(a.href);
      }

      function saveBuild(){
        if(!pro.pro) return;
        if(!state.draftHtml || !looksLikeHTML(state.draftHtml)){
          addMsg("simo", "Nothing to save yet. Build something first.");
          return;
        }
        const name = (state.draftName || state.topic || "untitled").trim();
        const item = { name, topic: state.topic || "", savedAt: new Date().toLocaleString(), html: state.draftHtml };
        const items = getLibrary();
        items.unshift(item);
        setLibrary(items.slice(0, 25));
        addMsg("simo", `Saved “${name}” to your Library.`);
      }

      // -------------------------
      // Boot
      // -------------------------
      function boot(){
        if(booted) return;
        booted = true;

        setMode(state.mode || "building");
        setTopic(state.topic || "");
        setDraftMeta();
        setProUI();

        // If you have a valid saved draft, render it (otherwise iframe already has dark srcdoc)
        if(state.draftHtml && looksLikeHTML(state.draftHtml)){
          frameEl.srcdoc = state.draftHtml;
        }

        // Seed initial message
        addMsg("simo", "Reset. I’m here.\n\nTell me what you want right now — venting, solving, or building.");

        // Listeners (these are what were missing when DOMContentLoaded didn’t fire)
        sendBtn.addEventListener("click", onSend);

        inputEl.addEventListener("keydown", (e) => {
          if(e.key === "Enter" && !e.shiftKey){
            e.preventDefault();
            onSend();
          }
        });

        previewBtn.addEventListener("click", manualPreview);
        downloadBtn.addEventListener("click", downloadHTML);

        saveBtn.addEventListener("click", () => {
          if(!pro.pro) return;
          saveBuild();
        });

        libraryBtn.addEventListener("click", () => {
          if(!pro.pro) return;
          openLib();
        });

        proBtn.addEventListener("click", () => {
          if(pro.pro) return;
          openProModal();
        });

        proClose.addEventListener("click", closeProModal);
        proModal.addEventListener("click", (e) => {
          if(e.target === proModal) closeProModal();
        });

        proVerify.addEventListener("click", async () => {
          const key = (proKey.value || "").trim();
          if(!key){ proMsg.textContent = "Enter a key."; return; }
          proMsg.textContent = "Verifying…";
          try{
            const data = await verifyProKey(key);
            const ok = !!data?.ok && !!data?.pro;
            if(ok){
              pro = { pro:true, key };
              localStorage.setItem(PRO_KEY, JSON.stringify(pro));
              setProUI();
              proMsg.textContent = "✅ Pro enabled.";
              await sleep(300);
              closeProModal();
              addMsg("simo", "Pro is ON. Save + Library unlocked.");
            }else{
              proMsg.textContent = "❌ Invalid key.";
            }
          }catch(err){
            proMsg.textContent = `⚠️ ${err?.message || "Verification failed"}`;
          }
        });

        libClose.addEventListener("click", closeLib);
        libModal.addEventListener("click", (e) => {
          if(e.target === libModal) closeLib();
        });
        libClear.addEventListener("click", () => {
          setLibrary([]);
          renderLibrary();
        });

        // Final tag reflect
        topicTag.textContent = `topic: ${state.topic || "none"}`;
        draftTag.textContent = `draft: ${state.draftName || "none"}`;
      }

      // ✅ THIS IS THE KEY FIX: boot even if DOMContentLoaded already fired
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", boot);
      } else {
        boot();
      }
    })();
  </script>
</body>
</html>
