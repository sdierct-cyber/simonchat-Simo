<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simo</title>
  <style>
    :root{
      --bg:#050812;
      --bg2:#0b1020;
      --panel:rgba(255,255,255,.04);
      --panel2:rgba(0,0,0,.18);
      --line:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:#a9b6d3;

      --blue:#2a66ff; --blue2:#1f4dd6;

      --neon:#39ff88;
      --neon2:#10d46a;
      --neonGlow:0 0 18px rgba(57,255,136,.22), 0 0 44px rgba(57,255,136,.14);

      --shadow:0 18px 55px rgba(0,0,0,.45);
      --radius:18px;

      --danger:#ff4d4d;
      --good:#39d98a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text);
      background:
        radial-gradient(1100px 650px at 20% 0%, rgba(42,102,255,.28), transparent 60%),
        radial-gradient(900px 520px at 80% 10%, rgba(57,255,136,.10), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:1320px;margin:0 auto;padding:18px}

    /* header */
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
      margin-bottom:12px;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      font-weight:1000;letter-spacing:.3px;font-size:22px;
    }
    .brandDot{
      width:12px;height:12px;border-radius:999px;
      background:linear-gradient(180deg,var(--neon),var(--neon2));
      box-shadow:var(--neonGlow);
    }

    /* pills */
    .pills{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:10px 14px;border-radius:999px;
      cursor:pointer;font-weight:900;
      opacity:.92;
      transition:transform .08s ease, opacity .08s ease, border-color .12s ease;
      user-select:none;
    }
    .pill:hover{transform:translateY(-1px);opacity:1}
    .pill.active{
      border-color:rgba(57,255,136,.55);
      background:rgba(57,255,136,.10);
      box-shadow:var(--neonGlow);
    }
    .pill.proOn{
      border-color:rgba(57,255,136,.65);
      background:rgba(57,255,136,.12);
      box-shadow:var(--neonGlow);
    }

    /* layout */
    .grid{
      display:grid;
      grid-template-columns: 1.06fr .94fr;
      gap:14px;
    }
    .panel{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height:700px;
      position:relative;
    }
    .panelHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.14);
    }
    .panelTitle{font-weight:1000;letter-spacing:.2px; display:flex; align-items:center; gap:10px}
    .panelTools{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

    .badge{
      font-size:12px;
      color:rgba(234,240,255,.85);
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      padding:6px 10px;border-radius:999px;
      user-select:text;
    }
    .badge.neon{
      border-color:rgba(57,255,136,.45);
      background:rgba(57,255,136,.10);
      box-shadow:var(--neonGlow);
    }
    .badge.warn{
      border-color:rgba(255,77,77,.40);
      background:rgba(255,77,77,.10);
    }

    .btn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:8px 10px;border-radius:12px;
      cursor:pointer;font-weight:900;
      transition:transform .08s ease, opacity .08s ease;
      user-select:none;
      font-size:13px;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px);opacity:1}
    .btn.primary{
      border-color:rgba(42,102,255,.45);
      background:linear-gradient(180deg,var(--blue),var(--blue2));
    }
    .btn.neon{
      border-color:rgba(57,255,136,.55);
      background:rgba(57,255,136,.10);
      box-shadow:var(--neonGlow);
    }

    /* chat */
    .chatBody{padding:10px 12px}
    .chatlog{
      height:520px;
      overflow:auto;
      padding:4px 2px 10px;
    }
    .msg{
      margin:10px 0;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.16);
      line-height:1.35;
      white-space:pre-wrap;
    }
    .msg.you{
      background:rgba(42,102,255,.14);
      border-color:rgba(42,102,255,.22);
    }
    .msg.simo{
      background:rgba(57,255,136,.08);
      border-color:rgba(57,255,136,.18);
    }

    .composer{
      display:flex;gap:10px;
      padding:12px;
      border-top:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.14);
      position:absolute;left:0;right:0;bottom:0;
    }
    .input{
      flex:1;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    .send{
      padding:12px 16px;
      border-radius:14px;
      border:1px solid rgba(42,102,255,.45);
      background:linear-gradient(180deg,var(--blue),var(--blue2));
      color:var(--text);
      font-weight:1000;
      cursor:pointer;
    }

    .hint{
      color:rgba(234,240,255,.70);
      font-size:13px;
      padding:10px 12px 0;
    }

    /* preview */
    .previewWrap{
      padding:12px;
      height: calc(700px - 54px);
      background:rgba(0,0,0,.10);
    }
    .neonBox{
      height:100%;
      border-radius:22px;
      border:1px solid rgba(57,255,136,.55);
      background:rgba(0,0,0,.16);
      box-shadow:var(--neonGlow);
      overflow:hidden;
      position:relative;
    }
    .previewTop{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 10px;
      border-bottom:1px solid rgba(57,255,136,.18);
      background:rgba(0,0,0,.18);
      font-size:13px;
      color:rgba(234,240,255,.85);
    }
    .previewMeta{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tag{
      padding:5px 9px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.16);
      font-weight:900;
      color:rgba(234,240,255,.90);
      font-size:12px;
    }
    .tag.neon{
      border-color:rgba(57,255,136,.45);
      background:rgba(57,255,136,.10);
    }
    iframe{
      width:100%;
      height: calc(100% - 44px);
      border:0;
      background:transparent;
    }
    .previewHint{
      position:absolute;left:0;right:0;bottom:0;
      padding:10px 12px;
      font-size:13px;
      color:rgba(234,240,255,.72);
      background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.35));
      pointer-events:none;
    }

    /* modal */
    #libraryModal{
      display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999;
    }
    .modalCard{
      max-width:900px; margin:8vh auto;
      background:rgba(10,14,28,.98);
      border:1px solid rgba(57,255,136,.35);
      box-shadow:0 20px 70px rgba(0,0,0,.6);
      border-radius:18px; overflow:hidden;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modalBody{ padding:12px 14px; }
    .libList{ display:grid; gap:10px; }
    .libItem{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      border-radius:16px;
      padding:12px;
    }
    .libTitle{ font-weight:1000; }
    .libMeta{ color:rgba(234,240,255,.70); font-size:13px; margin-top:6px; }
    .libRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }

    @media (max-width: 1100px){
      .grid{grid-template-columns:1fr}
      .panel{min-height:660px}
      .previewWrap{height: calc(660px - 54px)}
      .chatlog{height:480px}
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="brand"><span class="brandDot"></span> Simo</div>

    <div class="pills">
      <div class="pill active" data-mode="building">Building</div>
      <div class="pill" data-mode="solving">Solving</div>
      <div class="pill" data-mode="venting">Venting</div>
      <div class="pill" id="proPill">Pro: <span id="proState">OFF</span></div>
    </div>
  </div>

  <div class="grid">
    <!-- CHAT -->
    <div class="panel">
      <div class="panelHead">
        <div class="panelTitle">
          Chat
          <span class="badge neon" id="uiBadge">ui: neon-v1</span>
          <span class="badge" id="backendBadge">backend: ?</span>
        </div>
        <div class="panelTools">
          <button class="btn neon" id="resetBtn">Reset</button>
          <button class="btn" id="saveBtn">Save build</button>
          <button class="btn" id="libraryBtn">Library</button>
        </div>
      </div>

      <div class="chatBody">
        <div class="chatlog" id="chatlog"></div>
        <div class="hint" id="chatHint">
          Tip: Pro ON + Building, then say “build landing page”, then “change price to 19”, then “save build”.
        </div>
      </div>

      <div class="composer">
        <input class="input" id="msg" placeholder='Try: "build landing page" then "change price to 19" then "add faq"' />
        <button class="send" id="send">Send</button>
      </div>
    </div>

    <!-- PREVIEW -->
    <div class="panel">
      <div class="panelHead">
        <div class="panelTitle">Preview</div>
        <div class="panelTools">
          <button class="btn primary" id="downloadBtn">Download HTML</button>
          <button class="btn" id="clearPreviewBtn">Clear</button>
        </div>
      </div>

      <div class="previewWrap">
        <div class="neonBox">
          <div class="previewTop">
            <div class="previewMeta">
              <span class="tag neon" id="previewNameTag">none</span>
              <span class="tag" id="modeTag">mode: building</span>
              <span class="tag" id="proTag">pro: off</span>
            </div>
            <span class="tag" id="statusTag">idle</span>
          </div>

          <iframe id="preview" title="preview"></iframe>
          <div class="previewHint" id="previewHint">
            No preview yet. Turn Pro ON + Building mode, then ask: “build landing page”.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- LIBRARY MODAL -->
<div id="libraryModal">
  <div class="modalCard">
    <div class="modalHead">
      <div style="font-weight:1000;">Library</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn" id="exportAllBtn">Export JSON</button>
        <button class="btn neon" id="closeLibraryBtn">Close</button>
      </div>
    </div>
    <div class="modalBody">
      <div style="color:rgba(234,240,255,.75); font-size:13px; margin-bottom:10px;">
        Saved builds are stored locally in your browser (localStorage).
      </div>
      <div class="libList" id="libraryList"></div>
    </div>
  </div>
</div>

<script>
(() => {
  // ---------- state ----------
  let mode = "building";
  let pro = false;

  // last preview (for deterministic edits)
  let current = {
    preview_html: "",
    preview_name: "landing_page"
  };

  // dom
  const chatlog = document.getElementById("chatlog");
  const msg = document.getElementById("msg");
  const send = document.getElementById("send");

  const proPill = document.getElementById("proPill");
  const proState = document.getElementById("proState");

  const preview = document.getElementById("preview");
  const previewHint = document.getElementById("previewHint");
  const previewNameTag = document.getElementById("previewNameTag");
  const modeTag = document.getElementById("modeTag");
  const proTag = document.getElementById("proTag");
  const statusTag = document.getElementById("statusTag");

  const resetBtn = document.getElementById("resetBtn");
  const saveBtn = document.getElementById("saveBtn");
  const libraryBtn = document.getElementById("libraryBtn");
  const downloadBtn = document.getElementById("downloadBtn");
  const clearPreviewBtn = document.getElementById("clearPreviewBtn");

  const backendBadge = document.getElementById("backendBadge");

  const libraryModal = document.getElementById("libraryModal");
  const closeLibraryBtn = document.getElementById("closeLibraryBtn");
  const libraryList = document.getElementById("libraryList");
  const exportAllBtn = document.getElementById("exportAllBtn");

  // helpers
  function setStatus(s){ statusTag.textContent = s; }

  function add(role, text){
    const div = document.createElement("div");
    div.className = "msg " + (role === "you" ? "you" : "simo");
    div.textContent = (role === "you" ? "You: " : "Simo: ") + text;
    chatlog.appendChild(div);
    chatlog.scrollTop = chatlog.scrollHeight;
  }

  function setMode(next){
    mode = next;
    document.querySelectorAll(".pill[data-mode]").forEach(p => {
      p.classList.toggle("active", p.dataset.mode === mode);
    });
    modeTag.textContent = `mode: ${mode}`;
  }

  function setPro(next){
    pro = next;
    proState.textContent = pro ? "ON" : "OFF";
    proPill.classList.toggle("proOn", pro);
    proTag.textContent = `pro: ${pro ? "on" : "off"}`;
  }

  function setPreview(name, html){
    current.preview_name = name || "landing_page";
    current.preview_html = html || "";
    previewNameTag.textContent = current.preview_name || "none";

    if(current.preview_html){
      preview.srcdoc = current.preview_html; // critical fix: render HTML, not JS text
      previewHint.textContent = "Preview loaded.";
    }else{
      preview.srcdoc = "";
      previewHint.textContent = "No preview loaded.";
    }
  }

  function nowId(){
    const d = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  // ----- library -----
  const LS_KEY = "simo_library_v2";

  function loadLibrary(){
    try { return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }
    catch { return []; }
  }
  function saveLibrary(list){
    localStorage.setItem(LS_KEY, JSON.stringify(list));
  }

  function downloadText(text, filename, mime){
    const blob = new Blob([text || ""], { type: (mime || "text/plain") + ";charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename || "download.txt";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  }

  function downloadHtml(html, baseName){
    const safe = (baseName || "build").replace(/[^a-z0-9_\-]+/gi,"_").slice(0,40);
    downloadText(html || "", `${safe}.html`, "text/html");
  }

  function openLibrary(){
    renderLibrary();
    libraryModal.style.display = "block";
  }
  function closeLibrary(){
    libraryModal.style.display = "none";
  }

  function renderLibrary(){
    const list = loadLibrary();
    libraryList.innerHTML = "";

    if(!list.length){
      const empty = document.createElement("div");
      empty.style.color = "rgba(234,240,255,.75)";
      empty.style.padding = "10px";
      empty.textContent = "No saved builds yet. Click “Save build” after you generate a preview.";
      libraryList.appendChild(empty);
      return;
    }

    list.slice().reverse().forEach((item, idxFromEnd) => {
      const idx = list.length - 1 - idxFromEnd;

      const card = document.createElement("div");
      card.className = "libItem";

      const title = document.createElement("div");
      title.className = "libTitle";
      title.textContent = `${item.name || "build"} — ${item.savedAt || ""}`;

      const meta = document.createElement("div");
      meta.className = "libMeta";
      meta.textContent = `Mode: ${item.mode || "building"} • Pro: ${item.pro ? "ON" : "OFF"}`;

      const row = document.createElement("div");
      row.className = "libRow";

      const loadBtn = document.createElement("button");
      loadBtn.className = "btn neon";
      loadBtn.textContent = "Load";
      loadBtn.onclick = () => {
        setMode(item.mode || "building");
        setPro(!!item.pro);
        setPreview(item.preview_name || "landing_page", item.preview_html || "");
        add("simo", `Loaded: ${item.name || "build"}`);
        closeLibrary();
      };

      const dlBtn = document.createElement("button");
      dlBtn.className = "btn primary";
      dlBtn.textContent = "Download HTML";
      dlBtn.onclick = () => downloadHtml(item.preview_html || "", item.preview_name || "build");

      const delBtn = document.createElement("button");
      delBtn.className = "btn";
      delBtn.textContent = "Delete";
      delBtn.onclick = () => {
        const updated = loadLibrary();
        updated.splice(idx,1);
        saveLibrary(updated);
        renderLibrary();
      };

      row.appendChild(loadBtn);
      row.appendChild(dlBtn);
      row.appendChild(delBtn);

      card.appendChild(title);
      card.appendChild(meta);
      card.appendChild(row);

      libraryList.appendChild(card);
    });
  }

  // ----- backend call -----
  async function postToSimo(payload){
    const res = await fetch("/.netlify/functions/simon", {
      method:"POST",
      headers:{ "content-type":"application/json" },
      body: JSON.stringify(payload),
    });
    const data = await res.json().catch(() => ({}));
    return { ok: res.ok, status: res.status, data };
  }

  async function versionCheck(){
    try{
      const { ok, data } = await postToSimo({ message: "version check", mode: "building", pro: false });
      if(ok && data && data.version){
        backendBadge.textContent = `backend: ${data.version}`;
        backendBadge.classList.add("neon");
      }else{
        backendBadge.textContent = "backend: unknown";
        backendBadge.classList.add("warn");
      }
    }catch{
      backendBadge.textContent = "backend: unreachable";
      backendBadge.classList.add("warn");
    }
  }

  async function sendMsg(){
    const text = msg.value.trim();
    if(!text) return;

    msg.value = "";
    add("you", text);
    setStatus("thinking...");

    const payload = {
      message: text,
      mode,
      pro,
      current_preview_html: current.preview_html,
      current_preview_name: current.preview_name,
    };

    let result;
    try{
      result = await postToSimo(payload);
    }catch(e){
      add("simo", "Network error. Check deploy / function path.");
      setStatus("error");
      return;
    }

    const data = result.data || {};
    add("simo", data.reply || "Okay.");

    // Accept BOTH preview formats
    const html = (data.preview && data.preview.html) || data.preview_html || "";
    const name = (data.preview && data.preview.name) || data.preview_name || "";

    if(html && mode === "building" && pro){
      setPreview(name || "landing_page", html);
      setStatus("ready");
    }else{
      setStatus("ready");
    }
  }

  // ----- events -----
  document.querySelectorAll(".pill[data-mode]").forEach(p => {
    p.addEventListener("click", () => setMode(p.dataset.mode));
  });

  proPill.addEventListener("click", () => setPro(!pro));

  send.addEventListener("click", sendMsg);
  msg.addEventListener("keydown", (e) => {
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      sendMsg();
    }
  });

  resetBtn.addEventListener("click", () => {
    chatlog.innerHTML = "";
    setPreview("none", "");
    current.preview_name = "landing_page";
    current.preview_html = "";
    add("simo", "Reset. I’m here.");
    setStatus("idle");
  });

  saveBtn.addEventListener("click", () => {
    if(!current.preview_html){
      add("simo", "Nothing to save yet. Turn Pro ON + build a preview first.");
      return;
    }
    const list = loadLibrary();
    list.push({
      id: (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()),
      name: current.preview_name || "build",
      savedAt: nowId(),
      mode,
      pro,
      preview_name: current.preview_name,
      preview_html: current.preview_html
    });
    saveLibrary(list);
    add("simo", "Saved to Library.");
  });

  libraryBtn.addEventListener("click", openLibrary);
  closeLibraryBtn.addEventListener("click", closeLibrary);
  libraryModal.addEventListener("click", (e) => {
    if(e.target === libraryModal) closeLibrary();
  });

  exportAllBtn.addEventListener("click", () => {
    const list = loadLibrary();
    downloadText(JSON.stringify(list, null, 2), "simo_library.json", "application/json");
  });

  downloadBtn.addEventListener("click", () => {
    if(!current.preview_html){
      add("simo", "No preview to download yet.");
      return;
    }
    downloadHtml(current.preview_html, current.preview_name || "build");
  });

  clearPreviewBtn.addEventListener("click", () => {
    setPreview("none", "");
    add("simo", "Preview cleared.");
  });

  // ----- boot -----
  setMode("building");
  setPro(false);
  setStatus("idle");
  add("simo", "Reset. I’m here.");
  versionCheck();
})();
</script>
</body>
</html>
