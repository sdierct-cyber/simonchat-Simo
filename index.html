<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simo</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#0f1730; --text:#eaf0ff; --muted:#a9b6d3;
      --line:rgba(255,255,255,.10);
      --btn:#2a66ff; --btn2:#1f4dd6;
      --good:#39d98a; --bad:#ff4d4d; --warn:#ffcc66;
      --card:rgba(255,255,255,.06);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:radial-gradient(1200px 700px at 20% 0%, #162a66 0%, var(--bg) 55%);
      color:var(--text);
    }
    a{color:#9cc0ff}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .top{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:12px 14px; border:1px solid var(--line);
      background:rgba(255,255,255,.04); border-radius:var(--radius); box-shadow:var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:10px}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--good);box-shadow:0 0 18px rgba(57,217,138,.55)}
    .title{font-weight:700; letter-spacing:.2px}
    .subtitle{color:var(--muted); font-size:12px}
    .modeRow{display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
    .chip{
      border:1px solid var(--line); background:rgba(255,255,255,.04);
      padding:8px 10px; border-radius:999px; cursor:pointer;
      color:var(--text); font-size:12px; user-select:none;
    }
    .chip:hover{background:rgba(255,255,255,.08)}
    .chip.active{border-color:rgba(42,102,255,.75); background:rgba(42,102,255,.15)}
    .toggle{
      display:flex; align-items:center; gap:8px; color:var(--muted); font-size:12px;
      border:1px solid var(--line); background:rgba(255,255,255,.04);
      padding:8px 10px; border-radius:999px;
    }
    .toggle input{accent-color: var(--btn)}
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    .panel{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height:70vh;
      display:flex;
      flex-direction:column;
    }
    .panelHead{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.12);
    }
    .panelHead .h{font-weight:700; font-size:13px}
    .panelHead .mini{color:var(--muted); font-size:12px}
    .chat{
      padding:12px;
      overflow:auto;
      flex:1;
    }
    .msg{
      padding:10px 12px;
      border:1px solid var(--line);
      background:var(--card);
      border-radius:14px;
      margin:10px 0;
      white-space:pre-wrap;
      line-height:1.35;
    }
    .msg.you{background:rgba(42,102,255,.12); border-color:rgba(42,102,255,.25)}
    .msg.simo{background:rgba(255,255,255,.06)}
    .meta{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:6px; color:var(--muted); font-size:12px;
    }
    .row{
      display:flex; gap:10px; padding:12px; border-top:1px solid var(--line);
      background:rgba(0,0,0,.08);
    }
    textarea{
      flex:1; min-height:46px; max-height:140px; resize:vertical;
      border:1px solid var(--line); border-radius:14px;
      background:rgba(0,0,0,.18); color:var(--text);
      padding:10px 12px; outline:none;
    }
    button{
      border:1px solid rgba(42,102,255,.35);
      background:linear-gradient(180deg, var(--btn), var(--btn2));
      color:white; border-radius:14px;
      padding:10px 14px; cursor:pointer; font-weight:700;
    }
    button:disabled{opacity:.55; cursor:not-allowed}
    .status{
      padding:10px 12px; border-top:1px solid var(--line);
      color:var(--muted); font-size:12px; display:flex; gap:10px; align-items:center;
      justify-content:space-between;
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid var(--line); background:rgba(255,255,255,.04);
      padding:6px 10px; border-radius:999px;
    }
    .warn{color:var(--warn)}
    .bad{color:var(--bad)}
    .good{color:var(--good)}
    .previewWrap{
      flex:1; background:rgba(0,0,0,.10);
      display:flex; flex-direction:column;
    }
    .previewBody{
      flex:1; overflow:auto;
      padding:12px;
    }
    .previewEmpty{
      border:1px dashed rgba(255,255,255,.18);
      border-radius:14px;
      padding:14px;
      color:var(--muted);
      background:rgba(255,255,255,.04);
    }
    iframe{
      width:100%;
      height:100%;
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      background:white;
      min-height:55vh;
    }
    .imgGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap:10px;
    }
    .imgCard{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      border-radius:14px;
      overflow:hidden;
    }
    .imgCard img{width:100%; display:block}
    .imgCard .cap{padding:8px 10px; font-size:12px; color:var(--muted)}
    .smallBtns{display:flex; gap:8px; flex-wrap:wrap}
    .ghost{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
    }
    .ghost:hover{background:rgba(255,255,255,.10)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      iframe{min-height:52vh}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="dot" id="dot"></div>
        <div>
          <div class="title">Simo</div>
          <div class="subtitle">Best friend + builder — with live previews</div>
        </div>
      </div>

      <div class="modeRow">
        <div class="chip active" data-view="split" id="viewSplit">Split</div>
        <div class="chip" data-view="chat" id="viewChat">Chat</div>
        <div class="chip" data-view="preview" id="viewPreview">Preview</div>
        <label class="toggle" title="Auto-render preview when Simo outputs HTML or images">
          <input type="checkbox" id="autoPreview" checked />
          Auto-preview
        </label>
      </div>
    </div>

    <div class="grid" id="grid">
      <!-- Chat Panel -->
      <div class="panel" id="chatPanel">
        <div class="panelHead">
          <div>
            <div class="h">Chat</div>
            <div class="mini">Talk normally — switch topics anytime.</div>
          </div>
          <div class="smallBtns">
            <button class="ghost" id="quickPreviewBtn" type="button">Ask for Preview</button>
            <button class="ghost" id="clearBtn" type="button">Clear</button>
          </div>
        </div>

        <div class="chat" id="chat"></div>

        <div class="row">
          <textarea id="input" placeholder="Type here… (Enter to send, Shift+Enter for new line)"></textarea>
          <button id="sendBtn" type="button">Send</button>
        </div>

        <div class="status">
          <div class="pill"><span class="mono">API</span> <span id="apiState" class="warn">idle</span></div>
          <div class="pill"><span class="mono">Preview</span> <span id="previewState" class="warn">none</span></div>
        </div>
      </div>

      <!-- Preview Panel -->
      <div class="panel" id="previewPanel">
        <div class="panelHead">
          <div>
            <div class="h">Preview</div>
            <div class="mini">Renders the last “build” automatically.</div>
          </div>
          <div class="smallBtns">
            <button class="ghost" id="renderLastBtn" type="button">Render Last</button>
            <button class="ghost" id="openNewTabBtn" type="button">Open</button>
          </div>
        </div>

        <div class="previewWrap">
          <div class="previewBody" id="previewBody">
            <div class="previewEmpty">
              Nothing to preview yet.<br><br>
              Try: <span class="mono">build me a simple website</span> or <span class="mono">design an app</span>.
              If Simo outputs HTML or image links, I’ll render them here automatically.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const chatEl = document.getElementById("chat");
  const inputEl = document.getElementById("input");
  const sendBtn = document.getElementById("sendBtn");
  const clearBtn = document.getElementById("clearBtn");
  const apiStateEl = document.getElementById("apiState");
  const previewStateEl = document.getElementById("previewState");

  const gridEl = document.getElementById("grid");
  const chatPanel = document.getElementById("chatPanel");
  const previewPanel = document.getElementById("previewPanel");

  const viewSplit = document.getElementById("viewSplit");
  const viewChat = document.getElementById("viewChat");
  const viewPreview = document.getElementById("viewPreview");
  const autoPreviewEl = document.getElementById("autoPreview");

  const previewBody = document.getElementById("previewBody");
  const renderLastBtn = document.getElementById("renderLastBtn");
  const openNewTabBtn = document.getElementById("openNewTabBtn");
  const quickPreviewBtn = document.getElementById("quickPreviewBtn");

  // ---- State ----
  let lastSimoText = "";
  let lastPreview = { type: "none", html: "", images: [] };
  let lastPreviewBlobUrl = "";

  // ---- Helpers ----
  const nowTime = () => new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});

  function addMsg(role, text){
    const wrap = document.createElement("div");
    wrap.className = "msg " + (role === "you" ? "you" : "simo");

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.innerHTML = `<span><b>${role === "you" ? "You" : "Simo"}</b></span><span>${nowTime()}</span>`;

    const body = document.createElement("div");
    body.textContent = text;

    wrap.appendChild(meta);
    wrap.appendChild(body);
    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function setApiState(text, cls){
    apiStateEl.textContent = text;
    apiStateEl.className = (cls || "warn");
  }

  function setPreviewState(text, cls){
    previewStateEl.textContent = text;
    previewStateEl.className = (cls || "warn");
  }

  function setView(view){
    // view: split | chat | preview
    [viewSplit, viewChat, viewPreview].forEach(x => x.classList.remove("active"));
    if (view === "split") viewSplit.classList.add("active");
    if (view === "chat") viewChat.classList.add("active");
    if (view === "preview") viewPreview.classList.add("active");

    if (view === "split"){
      gridEl.style.gridTemplateColumns = "1fr 1fr";
      chatPanel.style.display = "flex";
      previewPanel.style.display = "flex";
    } else if (view === "chat"){
      gridEl.style.gridTemplateColumns = "1fr";
      chatPanel.style.display = "flex";
      previewPanel.style.display = "none";
    } else {
      gridEl.style.gridTemplateColumns = "1fr";
      chatPanel.style.display = "none";
      previewPanel.style.display = "flex";
    }
  }

  function extractHtmlBlock(text){
    // 1) ```html ... ```
    const fence = text.match(/```html\s*([\s\S]*?)```/i);
    if (fence && fence[1]) return fence[1].trim();

    // 2) any ``` ... ``` that looks like HTML inside
    const anyFence = text.match(/```\s*([\s\S]*?)```/);
    if (anyFence && anyFence[1] && /<\/?[a-z][\s\S]*>/i.test(anyFence[1])) {
      return anyFence[1].trim();
    }

    // 3) raw html hints
    if (/<html[\s>]/i.test(text) || /<!doctype html>/i.test(text) || /<\/div>/i.test(text)) {
      // try to isolate from first "<!doctype" or "<html" onward
      const idx = text.search(/<!doctype html>|<html[\s>]/i);
      if (idx >= 0) return text.slice(idx).trim();
    }

    return "";
  }

  function extractImageUrls(text){
    // Basic URL match
    const urls = (text.match(/https?:\/\/[^\s)"]+/g) || [])
      .map(u => u.replace(/[.,;]+$/,""));

    // Keep common image formats + also allow querystring images
    const img = urls.filter(u =>
      /\.(png|jpg|jpeg|webp|gif)(\?|#|$)/i.test(u) ||
      /image/i.test(u) && /https?:\/\//i.test(u)
    );

    // de-dupe
    return [...new Set(img)];
  }

  function renderPreview(preview){
    // cleanup old blob
    if (lastPreviewBlobUrl){
      URL.revokeObjectURL(lastPreviewBlobUrl);
      lastPreviewBlobUrl = "";
    }

    previewBody.innerHTML = "";

    if (!preview || preview.type === "none"){
      previewBody.innerHTML = `
        <div class="previewEmpty">
          Nothing to preview yet.<br><br>
          Try: <span class="mono">build me a simple website</span>, or click <b>Ask for Preview</b>.
        </div>
      `;
      setPreviewState("none", "warn");
      return;
    }

    if (preview.type === "images"){
      const grid = document.createElement("div");
      grid.className = "imgGrid";
      preview.images.forEach((src, i) => {
        const card = document.createElement("div");
        card.className = "imgCard";
        card.innerHTML = `
          <img src="${src}" alt="preview image ${i+1}" />
          <div class="cap mono">${src}</div>
        `;
        grid.appendChild(card);
      });
      previewBody.appendChild(grid);
      setPreviewState(`images (${preview.images.length})`, "good");
      return;
    }

    if (preview.type === "html"){
      // Render HTML safely in an iframe using srcdoc.
      const iframe = document.createElement("iframe");

      // Some user HTML snippets won't include <html> wrapper — that's fine.
      // We add a base target to keep links from breaking the parent tab.
      const srcdoc = `
<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<base target="_blank">
</head>
<body>
${preview.html}
</body>
</html>`.trim();

      iframe.srcdoc = srcdoc;
      previewBody.appendChild(iframe);
      setPreviewState("html", "good");
      return;
    }
  }

  function updateLastPreviewFromText(text){
    const html = extractHtmlBlock(text);
    const images = extractImageUrls(text);

    if (html){
      lastPreview = { type: "html", html, images: [] };
      return true;
    }
    if (images.length){
      lastPreview = { type: "images", html: "", images };
      return true;
    }

    lastPreview = { type: "none", html: "", images: [] };
    return false;
  }

  async function callSimo(userText){
    setApiState("thinking…", "warn");
    sendBtn.disabled = true;

    try{
      const res = await fetch("/.netlify/functions/simon", {
        method: "POST",
        headers: {"content-type":"application/json"},
        body: JSON.stringify({ message: userText })
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok || data.ok === false){
        const err = data?.error || data?.details || `HTTP ${res.status}`;
        setApiState("error", "bad");
        return `I hit an error: ${err}`;
      }

      // Flexible parsing: backend might return {ok:true, text:"..."} or {reply:"..."} etc.
      const text =
        data?.text ??
        data?.reply ??
        data?.output ??
        data?.message ??
        data?.response ??
        (typeof data === "string" ? data : "");

      setApiState("ok", "good");
      return (text || "").trim() || "…";
    } catch (e){
      setApiState("network error", "bad");
      return `Network error: ${e?.message || e}`;
    } finally {
      sendBtn.disabled = false;
    }
  }

  async function send(){
    const t = (inputEl.value || "").trim();
    if (!t) return;

    inputEl.value = "";
    addMsg("you", t);

    const simoText = await callSimo(t);
    lastSimoText = simoText;
    addMsg("simo", simoText);

    const found = updateLastPreviewFromText(simoText);
    if (autoPreviewEl.checked && found){
      renderPreview(lastPreview);
      setView("split"); // keep it visible
    }
  }

  // ---- Events ----
  sendBtn.addEventListener("click", send);

  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      send();
    }
  });

  clearBtn.addEventListener("click", () => {
    chatEl.innerHTML = "";
    lastSimoText = "";
    lastPreview = { type:"none", html:"", images:[] };
    renderPreview(lastPreview);
  });

  // View toggles
  viewSplit.addEventListener("click", () => setView("split"));
  viewChat.addEventListener("click", () => setView("chat"));
  viewPreview.addEventListener("click", () => setView("preview"));

  // Preview controls
  renderLastBtn.addEventListener("click", () => {
    if (lastSimoText){
      updateLastPreviewFromText(lastSimoText);
    }
    renderPreview(lastPreview);
    setView("preview");
  });

  openNewTabBtn.addEventListener("click", () => {
    if (lastPreview.type !== "html"){
      alert("Open works for HTML previews. Generate a website/app HTML first.");
      return;
    }
    // Create a blob so it opens as a standalone page.
    const html = `
<!doctype html>
<html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/></head>
<body>${lastPreview.html}</body></html>`;
    const blob = new Blob([html], {type:"text/html"});
    lastPreviewBlobUrl = URL.createObjectURL(blob);
    window.open(lastPreviewBlobUrl, "_blank", "noopener,noreferrer");
  });

  quickPreviewBtn.addEventListener("click", async () => {
    inputEl.value = "show me a preview";
    send();
  });

  // Init
  setView("split");
  renderPreview(lastPreview);
  addMsg("simo", "I’m here. Talk normally. If I output HTML or image links, I’ll render it in Preview automatically.");
})();
</script>
</body>
</html>
