<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simo</title>
  <style>
    :root{
      --bg:#0b1020;
      --bg2:#0f1a3a;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(0,0,0,.18);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.70);
      --line:rgba(255,255,255,.12);

      --blue1:#2a66ff;
      --blue2:#1f4dd6;

      --green:#35ff9a;
      --green2:#18c673;

      --bad:#ff4d4d;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --r1:22px;
      --r2:18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 0%, #163075 0%, var(--bg) 55%),
        radial-gradient(900px 520px at 90% 20%, #0a2a2a 0%, transparent 55%),
        var(--bg);
    }

    .wrap{
      max-width: 1320px;
      margin: 0 auto;
      padding: 18px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 260px;
    }

    .logo{
      width:44px;height:44px;
      border-radius:14px;
      background:linear-gradient(180deg, rgba(42,102,255,.35), rgba(42,102,255,.12));
      border:1px solid rgba(42,102,255,.35);
      box-shadow: 0 10px 28px rgba(42,102,255,.12);
      position:relative;
      overflow:hidden;
    }

    /* PRO glow dot in the logo */
    .logo::after{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(18px 18px at 30% 30%, rgba(53,255,154,.75), transparent 70%);
      opacity: var(--proglow, 0);
      transition: opacity .2s ease;
    }

    .brand h1{
      margin:0;
      font-size:26px;
      letter-spacing:.2px;
      line-height:1.1;
    }
    .brand .sub{
      margin-top:2px;
      font-size:12px;
      color:var(--muted);
      letter-spacing:.3px;
    }

    .top-actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      box-shadow: 0 10px 30px rgba(0,0,0,.18);
      user-select:none;
      cursor:pointer;
    }
    .pill strong{ font-size:14px; }

    /* Toggle */
    .toggle{
      width:52px;
      height:28px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.28);
      position:relative;
      flex:0 0 auto;
      transition: background .15s ease, border-color .15s ease, box-shadow .15s ease;
    }
    .toggle::after{
      content:"";
      width:22px;height:22px;
      border-radius:999px;
      position:absolute;
      top:2px; left:3px;
      background:rgba(255,255,255,.88);
      box-shadow: 0 8px 20px rgba(0,0,0,.35);
      transition: transform .15s ease, background .15s ease;
    }

    .pill.pro-on{
      border-color: rgba(53,255,154,.45);
      box-shadow: 0 0 0 2px rgba(53,255,154,.10), 0 14px 40px rgba(0,0,0,.22);
    }
    .pill.pro-on .toggle{
      border-color: rgba(53,255,154,.55);
      background: rgba(24,198,115,.25);
      box-shadow: 0 0 0 2px rgba(53,255,154,.12) inset;
    }
    .pill.pro-on .toggle::after{
      transform: translateX(24px);
      background: rgba(53,255,154,.95);
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      color:var(--text);
      font-weight:800;
      letter-spacing:.2px;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{ filter:brightness(1.06); }
    .btn.primary{
      background:linear-gradient(180deg,var(--blue1),var(--blue2));
      border-color: rgba(42,102,255,.55);
      box-shadow: 0 14px 44px rgba(42,102,255,.18);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.08fr .92fr;
      gap:14px;
      align-items:stretch;
    }

    .card{
      border:1px solid var(--line);
      border-radius: var(--r1);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .card-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.10);
    }

    .tabs{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .tab{
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background: rgba(42,102,255,.20);
      border-color: rgba(42,102,255,.55);
      box-shadow: 0 0 0 2px rgba(42,102,255,.10) inset;
    }

    .body{
      padding:14px;
    }

    /* Chat */
    .chatlog{
      height: 560px;
      overflow:auto;
      padding: 10px;
      border-radius: var(--r2);
      background: rgba(0,0,0,.14);
      border:1px solid rgba(255,255,255,.10);
    }

    .msg{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: 18px;
      padding: 12px 12px 12px;
      margin-bottom: 10px;
    }
    .msg .who{
      font-size:12px;
      color: rgba(234,240,255,.72);
      font-weight:900;
      margin-bottom:6px;
    }
    .msg.you{
      border-color: rgba(42,102,255,.40);
      background: rgba(42,102,255,.10);
    }

    .composer{
      margin-top:12px;
      display:flex;
      gap:10px;
      align-items:flex-end;
    }
    textarea{
      width:100%;
      min-height:54px;
      max-height:140px;
      resize:vertical;
      padding:14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
      font-size:15px;
      line-height:1.25;
    }
    textarea:focus{
      border-color: rgba(42,102,255,.55);
      box-shadow: 0 0 0 3px rgba(42,102,255,.12);
    }

    .statusrow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:10px;
      color: var(--muted);
      font-size:12px;
    }

    .dot{
      width:8px;height:8px;border-radius:999px;display:inline-block;margin-right:8px;
      background: rgba(255,255,255,.35);
      vertical-align:middle;
    }
    .dot.ok{ background: rgba(53,255,154,.85); box-shadow:0 0 0 3px rgba(53,255,154,.12); }
    .dot.bad{ background: rgba(255,77,77,.85); box-shadow:0 0 0 3px rgba(255,77,77,.10); }

    /* Preview */
    .preview-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 0 14px 12px;
    }
    .meta{
      color: var(--muted);
      font-size:13px;
      font-weight:800;
    }
    .chips{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .chip{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      font-weight:900;
      font-size:12px;
      letter-spacing:.2px;
    }
    .chip.pro{
      border-color: rgba(53,255,154,.45);
      background: rgba(24,198,115,.22);
      color: rgba(229,255,245,.95);
    }

    /* This is the key part: the preview frame NEVER white */
    .framewrap{
      border-radius: var(--r2);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      overflow:hidden;
      height: 560px;
      box-shadow: 0 14px 44px rgba(0,0,0,.24);
    }
    iframe{
      width:100%;
      height:100%;
      border:0;
      display:block;
      background: #0b1020; /* kill white flash */
    }

    /* Bottom PRO pill */
    .bottom-pill{
      position: fixed;
      right: 18px;
      bottom: 18px;
      padding: 12px 14px;
      border-radius: 999px;
      border: 1px solid rgba(53,255,154,.45);
      background: rgba(24,198,115,.22);
      font-weight: 1000;
      letter-spacing:.3px;
      box-shadow: 0 14px 44px rgba(0,0,0,.30), 0 0 0 2px rgba(53,255,154,.10) inset;
      color: rgba(229,255,245,.96);
      user-select:none;
    }
    .bottom-pill.off{
      display:none;
    }

    @media (max-width: 1020px){
      .grid{ grid-template-columns: 1fr; }
      .chatlog, .framewrap{ height: 460px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div id="logo" class="logo" aria-hidden="true"></div>
        <div>
          <h1>Simo</h1>
          <div class="sub">best friend + builder</div>
        </div>
      </div>

      <div class="top-actions">
        <div id="proPill" class="pill" title="Toggle Pro Mode">
          <strong>Pro Mode</strong>
          <div class="toggle" aria-hidden="true"></div>
        </div>
        <button id="resetBtn" class="btn">Reset</button>
        <button id="libraryBtn" class="btn">Library</button>
      </div>
    </div>

    <div class="grid">
      <!-- CHAT -->
      <div class="card">
        <div class="card-head">
          <div class="tabs" aria-label="Modes">
            <div class="tab" data-mode="venting">Venting</div>
            <div class="tab" data-mode="solving">Solving</div>
            <div class="tab active" data-mode="building">Building</div>
          </div>
        </div>
        <div class="body">
          <div id="chatlog" class="chatlog" aria-live="polite"></div>

          <div class="composer">
            <textarea id="input" placeholder="Type here... (Enter to send, Shift+Enter for new line)"></textarea>
            <button id="sendBtn" class="btn primary" style="min-width:110px">Send</button>
          </div>

          <div class="statusrow">
            <div><span id="statusDot" class="dot ok"></span><span id="statusText">Ready</span></div>
            <div class="muted">Tip: In <b>Building</b> mode, ask for a layout/app/site and I’ll render a preview (Pro).</div>
          </div>
        </div>
      </div>

      <!-- PREVIEW -->
      <div class="card">
        <div class="card-head">
          <div style="font-weight:1000;letter-spacing:.3px">PREVIEW</div>
          <div class="tabs">
            <button id="saveBuildBtn" class="btn">Save Build</button>
            <button id="copyHtmlBtn" class="btn">Copy HTML</button>
            <button id="downloadBtn" class="btn">Download</button>
          </div>
        </div>

        <div class="preview-head">
          <div class="meta">Current: <span id="currentName">Untitled preview</span></div>
          <div class="chips">
            <div class="chip" id="modeChip">Building</div>
            <div class="chip pro" id="proChip">PRO enabled</div>
          </div>
        </div>

        <div class="body" style="padding-top:0">
          <div class="framewrap">
            <iframe id="frame" title="Preview"></iframe>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="bottomPro" class="bottom-pill">PRO enabled</div>

  <script>
    // ---------- helpers ----------
    const $ = (s) => document.querySelector(s);

    function escapeHtml(s=""){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // Dark placeholder HTML (prevents white block)
    function placeholderHtml(){
      return `<!doctype html>
<html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
  :root{--bg:#0b1020;--text:#eaf0ff;--muted:rgba(234,240,255,.72);--line:rgba(255,255,255,.10);}
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    background:radial-gradient(1200px 700px at 20% 0%, #162a66 0%, var(--bg) 55%);
    color:var(--text);
    display:flex;align-items:center;justify-content:center;
    padding:22px;
  }
  .card{
    width:min(820px, 96vw);
    border:1px solid var(--line);
    border-radius:18px;
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    padding:18px 18px 20px;
  }
  h1{margin:0 0 8px;font-size:28px}
  p{margin:0;color:var(--muted);line-height:1.5}
  code{background:rgba(0,0,0,.22);padding:2px 6px;border-radius:8px;border:1px solid var(--line)}
</style>
</head>
<body>
  <div class="card">
    <h1>No preview yet.</h1>
    <p>In <b>Building</b> mode, ask: <code>build a landing page preview</code></p>
    <p style="margin-top:10px">Then try: <code>change Pro price to $19</code></p>
  </div>
</body></html>`;
    }

    function setStatus(ok, text){
      const dot = $("#statusDot");
      dot.classList.remove("ok","bad");
      dot.classList.add(ok ? "ok" : "bad");
      $("#statusText").textContent = text;
    }

    function addMsg(who, text, isYou=false){
      const box = document.createElement("div");
      box.className = "msg" + (isYou ? " you" : "");
      box.innerHTML = `<div class="who">${escapeHtml(who)}</div><div class="txt">${escapeHtml(text).replaceAll("\n","<br/>")}</div>`;
      $("#chatlog").appendChild(box);
      $("#chatlog").scrollTop = $("#chatlog").scrollHeight;
    }

    function setPreview(name, html){
      $("#currentName").textContent = name || "Untitled preview";
      window.__currentPreviewHtml = html || "";
      $("#frame").srcdoc = html || placeholderHtml();
    }

    function loadLibrary(){
      try { return JSON.parse(localStorage.getItem("simo_library") || "[]"); }
      catch { return []; }
    }
    function saveLibrary(items){
      localStorage.setItem("simo_library", JSON.stringify(items.slice(0, 60)));
    }

    // ---------- state ----------
    const state = {
      mode: localStorage.getItem("simo_mode") || "building",
      pro: (localStorage.getItem("simo_pro") || "1") === "1",
    };

    // ---------- UI wiring ----------
    const proPill = $("#proPill");
    const bottomPro = $("#bottomPro");
    const logo = $("#logo");

    function renderPro(){
      proPill.classList.toggle("pro-on", state.pro);
      $("#proChip").textContent = state.pro ? "PRO enabled" : "PRO disabled";
      $("#proChip").style.display = state.pro ? "inline-flex" : "inline-flex";
      bottomPro.classList.toggle("off", !state.pro);

      // logo glow
      document.documentElement.style.setProperty("--proglow", state.pro ? "1" : "0");
    }

    function renderMode(){
      document.querySelectorAll(".tab").forEach(t=>{
        t.classList.toggle("active", t.dataset.mode === state.mode);
      });
      $("#modeChip").textContent = state.mode.charAt(0).toUpperCase() + state.mode.slice(1);
      localStorage.setItem("simo_mode", state.mode);
    }

    proPill.addEventListener("click", ()=>{
      state.pro = !state.pro;
      localStorage.setItem("simo_pro", state.pro ? "1" : "0");
      renderPro();
    });

    document.querySelectorAll(".tab").forEach(t=>{
      t.addEventListener("click", ()=>{
        state.mode = t.dataset.mode;
        renderMode();
      });
    });

    $("#resetBtn").addEventListener("click", ()=>{
      $("#chatlog").innerHTML = "";
      addMsg("Simo", "Fresh start. I’m here.");
      setStatus(true,"Ready");
      setPreview("Untitled preview", placeholderHtml());
    });

    $("#libraryBtn").addEventListener("click", ()=>{
      const items = loadLibrary();
      if (!items.length){
        addMsg("Simo", "Library is empty. Use “Save Build” after you generate a preview.");
        return;
      }
      // Load last saved item
      const last = items[0];
      setPreview(last.name || "Saved preview", last.html || placeholderHtml());
      addMsg("Simo", `Loaded from Library: ${last.name || "Saved preview"}`);
    });

    $("#saveBuildBtn").addEventListener("click", ()=>{
      const html = window.__currentPreviewHtml;
      if (!html){
        addMsg("Simo", "Nothing to save yet — generate a preview first.");
        return;
      }
      const name = $("#currentName").textContent || "Saved preview";
      const items = loadLibrary();
      items.unshift({ name, html, ts: Date.now() });
      saveLibrary(items);
      addMsg("Simo", `Saved to Library: ${name}`);
    });

    $("#copyHtmlBtn").addEventListener("click", async ()=>{
      const html = window.__currentPreviewHtml;
      if (!html){
        addMsg("Simo", "No HTML to copy yet — generate a preview first.");
        return;
      }
      try{
        await navigator.clipboard.writeText(html);
        addMsg("Simo", "Copied preview HTML to clipboard.");
      }catch(e){
        addMsg("Simo", "Clipboard blocked by browser. Try HTTPS or allow clipboard permissions.");
      }
    });

    $("#downloadBtn").addEventListener("click", ()=>{
      const html = window.__currentPreviewHtml;
      if (!html){
        addMsg("Simo", "No preview to download yet — generate one first.");
        return;
      }
      const blob = new Blob([html], { type: "text/html;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      const safe = ($("#currentName").textContent || "preview").replaceAll(/[^\w\-]+/g,"_");
      a.download = safe + ".html";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 500);
      addMsg("Simo", "Downloaded preview HTML.");
    });

    // Enter to send
    $("#input").addEventListener("keydown", (e)=>{
      if (e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        send();
      }
    });
    $("#sendBtn").addEventListener("click", send);

    async function send(){
      const ta = $("#input");
      const message = ta.value.trim();
      if (!message) return;

      addMsg("You", message, true);
      ta.value = "";
      setStatus(true, "Thinking...");

      try{
        const res = await fetch("/.netlify/functions/simon", {
          method:"POST",
          headers:{ "content-type":"application/json" },
          body: JSON.stringify({
            message,
            mode: state.mode,
            pro: state.pro
          })
        });

        const data = await res.json().catch(()=>({ ok:false, error:"Bad JSON response" }));

        if (!res.ok || !data || data.ok === false){
          setStatus(false, data && (data.error || data.message) ? (data.error || data.message) : "Server error");
          addMsg("Simo", "⚠️ Server error");
          return;
        }

        const reply = (data.reply || "Okay.").trim();
        addMsg("Simo", reply);

        if (data.preview && data.preview.html){
          const name = data.preview.name || "preview";
          setPreview(name, data.preview.html);
        } else {
          // Keep dark placeholder instead of white flash
          if (!window.__currentPreviewHtml) setPreview("Untitled preview", placeholderHtml());
        }

        setStatus(true, "Ready");
      }catch(err){
        setStatus(false, "Network error");
        addMsg("Simo", "⚠️ Network error");
      }
    }

    // ---------- init ----------
    function init(){
      renderMode();
      renderPro();
      $("#chatlog").innerHTML = "";
      addMsg("Simo", "I’m here. Pick a mode — or just talk.");
      setPreview("Untitled preview", placeholderHtml());
      setStatus(true, "Ready");
    }
    init();
  </script>
</body>
</html>
