<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simo</title>
  <style>
    :root{
      --bg:#070c14;
      --panel:#0b1324;
      --panel2:#091022;
      --text:#e9eefc;
      --muted:#9fb0d0;
      --line:rgba(255,255,255,.08);
      --bubble:rgba(255,255,255,.06);
      --bubble2:rgba(255,255,255,.08);
      --btn:#102a59;
      --btn2:#153a7a;
      --good:#4fe39a;
      --bad:#ff6b6b;
      --warn:#f7c948;
      --shadow:0 16px 60px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 900px at 25% 0%, rgba(70,110,255,.12), transparent 60%),
                  radial-gradient(1200px 900px at 75% 20%, rgba(0,255,209,.08), transparent 55%),
                  var(--bg);
      color:var(--text);
    }

    .app{
      height:100%;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:0;
    }

    .col{
      display:flex;
      flex-direction:column;
      min-width:0;
      border-right:1px solid var(--line);
    }
    .col:last-child{ border-right:none; }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 18px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(to bottom, rgba(255,255,255,.03), transparent);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:700;
      letter-spacing:.2px;
    }
    .dot{
      width:9px; height:9px; border-radius:999px;
      background: var(--good);
      box-shadow: 0 0 14px rgba(79,227,154,.35);
    }
    .badge{
      font-size:12px;
      color:var(--muted);
      padding:4px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(255,255,255,.03);
    }

    .chat{
      flex:1;
      overflow:auto;
      padding:18px;
    }
    .row{
      display:flex;
      margin:10px 0;
      gap:10px;
    }
    .row.simo{ justify-content:flex-start; }
    .row.you{ justify-content:flex-end; }

    .bubble{
      max-width:min(660px, 90%);
      padding:12px 14px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--bubble);
      box-shadow: 0 10px 40px rgba(0,0,0,.18);
      white-space:pre-wrap;
      line-height:1.35;
    }
    .row.you .bubble{ background: var(--bubble2); }

    .who{
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }

    .composer{
      padding:14px 16px;
      border-top:1px solid var(--line);
      display:flex;
      gap:10px;
      align-items:flex-end;
      background: linear-gradient(to top, rgba(255,255,255,.03), transparent);
    }
    textarea{
      flex:1;
      resize:none;
      min-height:48px;
      max-height:180px;
      padding:12px 12px;
      font-family:var(--sans);
      color:var(--text);
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius: 14px;
      outline:none;
    }
    textarea:focus{
      border-color: rgba(120,160,255,.35);
      box-shadow: 0 0 0 3px rgba(120,160,255,.12);
    }

    .btns{ display:flex; gap:10px; }
    button{
      border:none;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight:700;
      color:var(--text);
      background: linear-gradient(to bottom, var(--btn2), var(--btn));
      cursor:pointer;
      box-shadow: var(--shadow);
      min-width:100px;
    }
    button:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; }
    .ghost{
      background: rgba(255,255,255,.05);
      border:1px solid var(--line);
      box-shadow:none;
      font-weight:600;
      min-width:110px;
    }

    /* Right panel */
    .previewWrap{
      display:flex;
      flex-direction:column;
      height:100%;
      min-width:0;
    }
    .previewTop{
      padding:18px;
      border-bottom:1px solid var(--line);
    }
    .title{ font-size:20px; font-weight:800; margin:0 0 6px 0; }
    .sub{ color:var(--muted); font-size:13px; margin:0; }

    .chips{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .chip{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      cursor:pointer;
      font-size:12px;
      user-select:none;
    }
    .chip:hover{ color:var(--text); border-color: rgba(255,255,255,.16); }

    .previewBody{
      flex:1;
      min-height:0;
      overflow:auto;
      padding:0;
      background: rgba(0,0,0,.15);
    }
    .empty{ padding:18px; color:var(--muted); }
    iframe{ width:100%; height:100%; border:none; background:white; }

    .statusline{
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
      padding:10px 16px;
      border-top:1px solid var(--line);
      background: rgba(255,255,255,.02);
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .pill.good{ border-color: rgba(79,227,154,.35); color: rgba(79,227,154,.95); }
    .pill.bad{ border-color: rgba(255,107,107,.35); color: rgba(255,107,107,.95); }
    .pill.warn{ border-color: rgba(247,201,72,.35); color: rgba(247,201,72,.95); }

    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
      .col{ border-right:none; border-bottom:1px solid var(--line); }
      .col:last-child{ border-bottom:none; }
      button{ min-width:92px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- LEFT: CHAT -->
    <section class="col">
      <header>
        <div class="brand"><span class="dot"></span><span>Simo</span></div>
        <div class="badge" id="planBadge">Free</div>
      </header>

      <div class="chat" id="chat"></div>

      <div class="composer">
        <textarea id="input" placeholder="Talk to Simo… (Enter to send, Shift+Enter for a new line)"></textarea>
        <div class="btns">
          <button class="ghost" id="showBtn" title="Ask Simo to build something visual">Show me</button>
          <button id="sendBtn">Send</button>
        </div>
      </div>

      <div class="statusline" id="statusline">
        <span class="pill warn" id="netPill">idle</span>
        <span class="pill" id="modePill">mode: listen</span>
        <span class="pill" id="endpointPill">endpoint: auto</span>
      </div>
    </section>

    <!-- RIGHT: PREVIEW -->
    <section class="previewWrap">
      <header>
        <div class="brand"><span>Preview</span></div>
        <div class="badge" id="previewHint">Simo will show things here when there’s something real to look at.</div>
      </header>

      <div class="previewTop">
        <h2 class="title" id="previewTitle">Nothing here yet.</h2>
        <p class="sub" id="previewSub">
          When Simo builds something visual, it’ll appear here. You can also say “show me” anytime.
        </p>
        <div class="chips">
          <div class="chip" data-prompt="Show me a simple 1-page website layout.">website</div>
          <div class="chip" data-prompt="Show me a clean resume layout I can edit.">resume</div>
          <div class="chip" data-prompt="Show me a donation landing page mockup.">donation page</div>
          <div class="chip" data-prompt="Show me a portfolio homepage mockup.">portfolio</div>
        </div>
      </div>

      <div class="previewBody" id="previewBody">
        <div class="empty" id="previewEmpty">Nothing to preview yet.</div>
      </div>
    </section>
  </div>

<script>
/**
 * SIMO "ONCE AND FOR ALL" FRONTEND
 * - Best Friend (listen) + Builder (work + preview)
 * - Listen mode NEVER blocks short/ambiguous check-ins
 * - Listen mode NEVER depends on backend for presence/help check-ins
 * - Builder mode calls backend and can render preview HTML in iframe
 */

(() => {
  // ====== CONFIG ======
  // Recommended Netlify Functions endpoint:
  // "/.netlify/functions/simo"
  // If your function is named differently, change it here ONCE.
  const SIMO_ENDPOINT =
    window.SIMO_ENDPOINT ||
    localStorage.getItem("SIMO_ENDPOINT") ||
    "/.netlify/functions/simo";

  const MAX_HISTORY = 14;

  // Expanded: real-world variants, u/ur, help check-ins, etc.
  const SOFT_LISTEN = [
    // presence / check-in
    "are you listening","are u listening","u listening","you listening",
    "you there","are you there","are u there","you still there","u there",
    "can you hear me","can u hear me","can you hear","can u hear",
    "hello","hey","hi","yo","sup","simo",

    // “help me” check-ins (still listen mode)
    "can you help me","can u help me","are you able to help me","are u able to help me",
    "can you help","can u help","help me","i need help"
  ];

  const BUILDER_HINTS = [
    "show me", "build", "create", "design", "make", "generate", "code",
    "html", "app", "website", "landing", "mockup", "ui", "wireframe",
    "resume", "portfolio", "donation", "preview"
  ];

  // ====== DOM ======
  const chatEl = document.getElementById("chat");
  const inputEl = document.getElementById("input");
  const sendBtn = document.getElementById("sendBtn");
  const showBtn = document.getElementById("showBtn");

  const previewBody = document.getElementById("previewBody");
  const previewEmpty = document.getElementById("previewEmpty");
  const previewTitle = document.getElementById("previewTitle");
  const previewSub = document.getElementById("previewSub");

  const netPill = document.getElementById("netPill");
  const modePill = document.getElementById("modePill");
  const endpointPill = document.getElementById("endpointPill");

  endpointPill.textContent = "endpoint: " + (SIMO_ENDPOINT.includes("http") ? "remote" : SIMO_ENDPOINT);

  // ====== STATE ======
  const state = {
    messages: loadMessages(),
    busy: false,
    lastMode: "listen"
  };

  if (state.messages.length === 0) {
    state.messages.push({ role: "simo", content: "Hey — I’m Simo. What’s going on?" });
    saveMessages();
  }
  render();

  // ====== EVENTS ======
  sendBtn.addEventListener("click", () => send());
  showBtn.addEventListener("click", () => {
    if (!inputEl.value.trim()) inputEl.value = "Show me a quick preview of the thing we were talking about.";
    send({ forceMode: "build" });
  });

  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      send();
    }
  });

  document.querySelectorAll(".chip").forEach(chip => {
    chip.addEventListener("click", () => {
      inputEl.value = chip.dataset.prompt;
      send({ forceMode: "build" });
    });
  });

  // ====== HELPERS ======
  function normalize(s) {
    return (s || "").toLowerCase().trim();
  }

  function loadMessages() {
    try {
      const raw = localStorage.getItem("SIMO_CHAT_V1");
      return raw ? JSON.parse(raw) : [];
    } catch { return []; }
  }

  function saveMessages() {
    localStorage.setItem("SIMO_CHAT_V1", JSON.stringify(state.messages.slice(-200)));
  }

  function setBusy(on) {
    state.busy = on;
    sendBtn.disabled = on;
    showBtn.disabled = on;
    setNetPill("warn", on ? "thinking…" : "idle");
  }

  function pushMsg(role, content) {
    state.messages.push({ role, content });
    saveMessages();
    render();
    scrollChatToBottom();
  }

  function render() {
    chatEl.innerHTML = "";
    for (const m of state.messages) {
      const row = document.createElement("div");
      row.className = "row " + (m.role === "you" ? "you" : "simo");

      const bubble = document.createElement("div");
      bubble.className = "bubble";

      const who = document.createElement("div");
      who.className = "who";
      who.textContent = (m.role === "you") ? "you" : "Simo";
      bubble.appendChild(who);

      const text = document.createElement("div");
      text.textContent = m.content;
      bubble.appendChild(text);

      row.appendChild(bubble);
      chatEl.appendChild(row);
    }
    requestAnimationFrame(scrollChatToBottom);
  }

  function scrollChatToBottom() {
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function setModePill(mode) {
    state.lastMode = mode;
    modePill.textContent = "mode: " + mode;
  }

  function setNetPill(type, text) {
    netPill.textContent = text;
    if (type === "good") netPill.className = "pill good";
    else if (type === "bad") netPill.className = "pill bad";
    else netPill.className = "pill warn";
  }

  function showPreview(html) {
    previewTitle.textContent = "Preview";
    previewSub.textContent = "Generated by Simo. If you want changes, tell me what to tweak.";
    previewBody.innerHTML = "";

    const iframe = document.createElement("iframe");
    previewBody.appendChild(iframe);

    const doc = iframe.contentDocument || iframe.contentWindow.document;
    doc.open();
    doc.write(html);
    doc.close();
  }

  function summarizeHistoryForAPI() {
    return state.messages.slice(-MAX_HISTORY).map(m => ({
      role: m.role === "you" ? "user" : "assistant",
      content: m.content
    }));
  }

  // Decide whether we’re in listen vs build
  function decideMode(userText, forceMode) {
    if (forceMode === "build" || forceMode === "listen") return forceMode;

    const t = normalize(userText);

    // Soft-listen wins if message matches or contains those check-ins
    if (SOFT_LISTEN.some(k => t === k || t.includes(k))) return "listen";

    // Build if it includes builder hints
    if (BUILDER_HINTS.some(k => t.includes(k))) return "build";

    // Default listen
    return "listen";
  }

  /**
   * BEST-FRIEND LOCAL REPLIES (NEVER FAIL)
   * IMPORTANT: This prevents “I couldn’t reach my brain…” for check-ins.
   */
  function localListenReply(userText) {
    const t = normalize(userText);

    // Presence/listening variants
    if (
      t.includes("listening") ||
      t.includes("you there") || t.includes("u there") ||
      t.includes("are you there") || t.includes("are u there") ||
      t.includes("can you hear") || t.includes("can u hear")
    ) {
      return "Yeah — I’m here. What’s up?";
    }

    // Help check-ins
    if (
      t.includes("help me") ||
      t === "help" ||
      t.includes("can you help") || t.includes("can u help") ||
      t.includes("able to help")
    ) {
      return "Yeah. Tell me what you need — I got you.";
    }

    // Simple greetings / pings
    if (t === "hey" || t === "hi" || t === "hello" || t === "yo" || t === "simo" || t === "sup") {
      return "Hey. I’m here. What’s going on?";
    }

    // Very short messages: don’t hit backend
    if (t.length <= 12) {
      return "I’m here. Say it.";
    }

    return null;
  }

  async function callSimoAPI({ userText, mode }) {
    const payload = {
      message: userText,
      mode,
      history: summarizeHistoryForAPI()
    };

    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 25000);

    try {
      const res = await fetch(SIMO_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
        signal: controller.signal
      });

      const rawText = await res.text();
      let data = null;
      try { data = rawText ? JSON.parse(rawText) : null; } catch {}

      if (!res.ok) {
        const msg =
          (data && (data.error || data.message)) ||
          `HTTP ${res.status} ${res.statusText}` +
          (rawText ? ` — ${rawText.slice(0, 180)}` : "");
        throw new Error(msg);
      }

      const reply =
        (data && (data.reply || data.output || data.message)) ||
        (typeof data === "string" ? data : null);

      const preview_html =
        (data && data.preview_html) ||
        (data && data.preview && data.preview.type === "html" ? data.preview.html : null);

      return { reply, preview_html, raw: data };
    } finally {
      clearTimeout(timeout);
    }
  }

  // ====== MAIN SEND ======
  async function send(opts = {}) {
    const userText = inputEl.value.trim();
    if (!userText || state.busy) return;

    inputEl.value = "";

    const mode = decideMode(userText, opts.forceMode);
    setModePill(mode);

    // Always show user message
    pushMsg("you", userText);

    // LISTEN MODE: local reply for check-ins, no backend dependency
    if (mode === "listen") {
      const local = localListenReply(userText);
      if (local) {
        pushMsg("simo", local);
        setNetPill("good", "ok");
        return;
      }
      // If it’s listen mode but not a small check-in, we CAN still call backend
      // (This gives you “best friend” depth without forcing builder mode.)
    }

    setBusy(true);

    try {
      const { reply, preview_html } = await callSimoAPI({ userText, mode });

      if (!reply) throw new Error("Empty reply from backend (missing 'reply').");

      pushMsg("simo", reply);
      setNetPill("good", "ok");

      if (preview_html && typeof preview_html === "string" && preview_html.trim().length > 20) {
        showPreview(preview_html);
      }

    } catch (err) {
      // IMPORTANT: show real error so we know what’s wrong
      const msg = (err && err.name === "AbortError")
        ? "Timed out reaching the backend (25s). Usually endpoint mismatch or function crash."
        : (err && err.message ? err.message : "Unknown error.");

      setNetPill("bad", "error");
      pushMsg("simo",
        "I hit a snag talking to the backend.\n\n" +
        "Here’s the exact error:\n" +
        "- " + msg + "\n\n" +
        "Paste this back to me and I’ll tell you the exact fix (endpoint/function/env)."
      );
    } finally {
      setBusy(false);
    }
  }

})();
</script>
</body>
</html>
