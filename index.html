<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simo</title>
  <style>
    :root{
      --bg:#0b1020; --text:#eaf0ff; --muted:#a9b6d3;
      --line:rgba(255,255,255,.10);
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(0,0,0,.18);
      --btn:#2a66ff; --btn2:#1f4dd6;
      --good:#39d98a; --bad:#ff4d4d;
      --chip:rgba(255,255,255,.08);
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background: radial-gradient(1200px 700px at 20% 0%, #162a66 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{max-width:1240px;margin:0 auto;padding:18px}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px; border-radius:22px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      box-shadow: var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.10);
    }
    .brand h1{margin:0;font-size:22px;line-height:1}
    .brand .sub{margin:2px 0 0;color:var(--muted);font-size:13px}
    .top-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap; justify-content:flex-end}
    .pill{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:999px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
    }
    .pill b{font-size:13px}
    .toggle{
      width:46px;height:26px;border-radius:999px; position:relative;
      background: rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.16);
      cursor:pointer;
    }
    .toggle::after{
      content:""; position:absolute; top:3px; left:3px;
      width:20px;height:20px;border-radius:50%;
      background: rgba(255,255,255,.65);
      transition: all .18s ease;
    }
    .toggle.on{background: rgba(57,217,138,.18); border-color: rgba(57,217,138,.35)}
    .toggle.on::after{left:23px; background: rgba(57,217,138,.85)}
    .btn{
      padding:10px 14px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color:var(--text);
      cursor:pointer;
      font-weight:700;
    }
    .btn:hover{border-color:rgba(255,255,255,.22)}
    .btn.primary{background: linear-gradient(180deg, var(--btn), var(--btn2)); border:none}
    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:stretch;
    }
    .card{
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height: 560px;
      display:flex;
      flex-direction:column;
    }
    .card-header{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .card-header h2{margin:0;font-size:18px;letter-spacing:.5px}
    .modes{display:flex;gap:10px;flex-wrap:wrap}
    .chip{
      padding:9px 12px;
      border-radius:999px;
      background: var(--chip);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    .chip.active{background: rgba(42,102,255,.25); border-color: rgba(42,102,255,.45)}
    .chat-body{
      padding:14px 14px 0;
      overflow:auto;
      flex:1;
    }
    .msg{
      margin:0 0 12px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      max-width: 92%;
      white-space:pre-wrap;
      word-wrap:break-word;
    }
    .msg.you{
      margin-left:auto;
      background: rgba(42,102,255,.18);
      border-color: rgba(42,102,255,.28);
    }
    .msg .who{font-size:12px;color:var(--muted);margin:0 0 6px;font-weight:800}
    .msg.error{border-color: rgba(255,77,77,.40); background: rgba(255,77,77,.10)}
    .composer{
      padding:12px 14px 14px;
      display:flex; gap:10px;
      border-top:1px solid rgba(255,255,255,.08);
      align-items:flex-end;
    }
    textarea{
      flex:1;
      resize:none;
      border-radius:14px;
      padding:12px 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color:var(--text);
      min-height:48px;
      max-height:140px;
      outline:none;
    }
    .send{
      min-width:110px;
      height:48px;
      border-radius:14px;
      border:none;
      background: linear-gradient(180deg, var(--btn), var(--btn2));
      color:white;
      font-weight:900;
      cursor:pointer;
    }
    .footer-hint{
      padding:0 14px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      color:var(--muted);
      font-size:12px;
    }
    .status{display:flex;align-items:center;gap:8px}
    .dot{width:8px;height:8px;border-radius:50%;background:var(--good);box-shadow:0 0 0 3px rgba(57,217,138,.12)}
    .dot.bad{background:var(--bad); box-shadow:0 0 0 3px rgba(255,77,77,.12)}
    .preview-toolbar{display:flex;gap:10px;flex-wrap:wrap; justify-content:flex-end}
    .preview-sub{
      padding:12px 16px;
      border-bottom:1px solid rgba(255,255,255,.08);
      color:var(--muted);
      font-size:13px;
      display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      background: rgba(0,0,0,.20);
      border:1px solid rgba(57,217,138,.25);
      color: rgba(57,217,138,.95);
      font-weight:900;
      font-size:12px;
    }
    .preview-wrap{
      padding:14px;
      flex:1;
      overflow:auto;
    }
    .frame{
      width:100%;
      min-height:480px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      overflow:hidden;
    }
    iframe{
      width:100%;
      height: 760px;
      border:0;
      display:block;
      background:white;
    }
    .empty{
      padding:24px;
      text-align:left;
      color:var(--muted);
      border:1px dashed rgba(255,255,255,.18);
      border-radius:16px;
      background: rgba(0,0,0,.10);
    }
    .tiny{font-size:12px;color:var(--muted)}
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      iframe{height: 680px}
      .card{min-height:520px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Simo</h1>
          <div class="sub">best friend + builder</div>
        </div>
      </div>

      <div class="top-actions">
        <div class="pill">
          <b>Pro Mode</b>
          <div id="proToggle" class="toggle"></div>
        </div>
        <button id="resetBtn" class="btn">Reset</button>
        <button id="libraryBtn" class="btn">Library</button>
      </div>
    </div>

    <div class="grid">
      <!-- CHAT -->
      <section class="card">
        <div class="card-header">
          <h2>CHAT</h2>
          <div class="modes">
            <button class="chip" data-mode="venting">Venting</button>
            <button class="chip" data-mode="solving">Solving</button>
            <button class="chip active" data-mode="building">Building</button>
          </div>
        </div>

        <div id="chatBody" class="chat-body"></div>

        <div class="composer">
          <textarea id="input" placeholder="Type here… (Enter to send, Shift+Enter for new line)"></textarea>
          <button id="sendBtn" class="send">Send</button>
        </div>

        <div class="footer-hint">
          <div class="tiny">Tip: in <b>Building</b> mode, ask for a layout/app/site and I’ll render a preview.</div>
          <div class="status"><span id="dot" class="dot"></span><b id="statusText">Ready</b></div>
        </div>
      </section>

      <!-- PREVIEW -->
      <section class="card">
        <div class="card-header">
          <h2>PREVIEW</h2>
          <div class="preview-toolbar">
            <button id="saveBuildBtn" class="btn">Save Build</button>
            <button id="copyHtmlBtn" class="btn">Copy HTML</button>
            <button id="downloadBtn" class="btn">Download</button>
          </div>
        </div>

        <div class="preview-sub">
          <div>Current: <b id="currentKind">Untitled preview</b></div>
          <div class="tag"><span id="modeTag">Building</span></div>
        </div>

        <div class="preview-wrap">
          <div id="previewContainer" class="frame">
            <div id="emptyPreview" class="empty">
              <h2 style="margin:0 0 8px;">No preview yet.</h2>
              <div style="margin-bottom:10px;">Switch to <b>Building</b> and ask for something like:</div>
              <div class="tiny">“build a landing page” • “design a space renting app” • “make a resume layout”</div>
            </div>
            <iframe id="previewFrame" sandbox="allow-scripts allow-forms allow-popups allow-modals" style="display:none;"></iframe>
          </div>
          <div class="tiny" style="margin-top:10px;">Library is saved on this device</div>
        </div>
      </section>
    </div>
  </div>

<script>
  // --------------------------
  // Local state (frontend)
  // --------------------------
  const LS = {
    pro: "simo_proMode",
    mode: "simo_mode",
    thread: "simo_thread",
    buildState: "simo_buildState",
    library: "simo_library"
  };

  let mode = localStorage.getItem(LS.mode) || "building";
  let proMode = (localStorage.getItem(LS.pro) === "true");
  let thread = safeParse(localStorage.getItem(LS.thread), []);
  let buildState = safeParse(localStorage.getItem(LS.buildState), {
    current_kind: null,
    current_title: null,
    current_html: null
  });

  // --------------------------
  // DOM
  // --------------------------
  const chatBody = document.getElementById("chatBody");
  const input = document.getElementById("input");
  const sendBtn = document.getElementById("sendBtn");
  const dot = document.getElementById("dot");
  const statusText = document.getElementById("statusText");

  const proToggle = document.getElementById("proToggle");
  const resetBtn = document.getElementById("resetBtn");
  const libraryBtn = document.getElementById("libraryBtn");

  const saveBuildBtn = document.getElementById("saveBuildBtn");
  const copyHtmlBtn = document.getElementById("copyHtmlBtn");
  const downloadBtn = document.getElementById("downloadBtn");

  const previewFrame = document.getElementById("previewFrame");
  const emptyPreview = document.getElementById("emptyPreview");
  const currentKind = document.getElementById("currentKind");
  const modeTag = document.getElementById("modeTag");

  // --------------------------
  // Init UI
  // --------------------------
  setProToggle(proMode);
  setMode(mode);
  renderThread();
  renderPreviewFromState();

  // --------------------------
  // Events
  // --------------------------
  document.querySelectorAll(".chip").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      setMode(btn.dataset.mode);
    });
  });

  proToggle.addEventListener("click", ()=>{
    proMode = !proMode;
    localStorage.setItem(LS.pro, String(proMode));
    setProToggle(proMode);
    // Also show it visually in the tag
    renderModeTag();
  });

  resetBtn.addEventListener("click", ()=>{
    // Reset chat + preview state but keep library
    thread = [];
    buildState = { current_kind:null, current_title:null, current_html:null };
    persist();
    chatBody.innerHTML = "";
    addMsg("simo", "Fresh start. I’m here.");
    setStatus("ready");
    renderPreviewFromState();
  });

  libraryBtn.addEventListener("click", ()=>{
    const lib = safeParse(localStorage.getItem(LS.library), []);
    if(!lib.length){
      alert("Library is empty (on this device). Use “Save Build” first.");
      return;
    }
    const names = lib.map((x,i)=> `${i+1}) ${x.title || x.kind || "Untitled"} (${new Date(x.saved_at).toLocaleString()})`).join("\n");
    const pick = prompt("Library (pick a number to load):\n\n" + names);
    const idx = parseInt(pick,10)-1;
    if(Number.isFinite(idx) && lib[idx]){
      const item = lib[idx];
      buildState.current_kind = item.kind || "loaded";
      buildState.current_title = item.title || "Loaded build";
      buildState.current_html = item.html || null;
      persist();
      addMsg("simo", `Loaded from library: ${buildState.current_title}`);
      renderPreviewFromState();
    }
  });

  saveBuildBtn.addEventListener("click", ()=>{
    if(!buildState.current_html){
      alert("No preview HTML to save yet.");
      return;
    }
    const title = prompt("Name this build:", buildState.current_title || buildState.current_kind || "My Build");
    const lib = safeParse(localStorage.getItem(LS.library), []);
    lib.unshift({
      title: title || buildState.current_title || "Untitled",
      kind: buildState.current_kind || "preview",
      html: buildState.current_html,
      saved_at: new Date().toISOString()
    });
    localStorage.setItem(LS.library, JSON.stringify(lib.slice(0,50)));
    alert("Saved to Library (this device).");
  });

  copyHtmlBtn.addEventListener("click", async ()=>{
    if(!buildState.current_html){
      alert("No preview HTML to copy yet.");
      return;
    }
    await navigator.clipboard.writeText(buildState.current_html);
    alert("Copied preview HTML to clipboard.");
  });

  downloadBtn.addEventListener("click", ()=>{
    if(!buildState.current_html){
      alert("No preview HTML to download yet.");
      return;
    }
    const name = (buildState.current_title || buildState.current_kind || "preview")
      .replace(/[^a-z0-9\-_]+/gi, "_")
      .toLowerCase();
    const blob = new Blob([buildState.current_html], {type:"text/html;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${name}.html`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  sendBtn.addEventListener("click", ()=>send());
  input.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      send();
    }
  });

  // --------------------------
  // Chat / network
  // --------------------------
  function addMsg(who, text, extraClass=""){
    const div = document.createElement("div");
    div.className = `msg ${who === "you" ? "you" : ""} ${extraClass}`.trim();
    div.innerHTML = `<div class="who">${who === "you" ? "You" : "Simo"}</div>${escapeHtml(text)}`;
    chatBody.appendChild(div);
    chatBody.scrollTop = chatBody.scrollHeight;
    // keep in thread
    thread.push({role: who === "you" ? "user" : "assistant", text, at: Date.now()});
    persist();
  }

  function renderThread(){
    chatBody.innerHTML = "";
    if(!thread.length){
      addMsg("simo", "I’m here. Pick a mode — or just talk.");
      return;
    }
    for(const m of thread){
      addMsg(m.role === "user" ? "you" : "simo", m.text);
    }
  }

  function setStatus(state, msg){
    if(state === "thinking"){
      dot.classList.remove("bad");
      statusText.textContent = msg || "Thinking";
    }else if(state === "bad"){
      dot.classList.add("bad");
      statusText.textContent = msg || "Error";
    }else{
      dot.classList.remove("bad");
      statusText.textContent = msg || "Ready";
    }
  }

  async function send(){
    const text = input.value.trim();
    if(!text) return;
    input.value = "";
    addMsg("you", text);
    setStatus("thinking");

    try{
      const payload = {
        message: text,
        mode,
        pro: proMode,
        // send build state so backend can EDIT current HTML
        state: buildState
      };

      const res = await fetch("/.netlify/functions/simon", {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify(payload)
      });

      let data = null;
      const raw = await res.text();
      try{ data = JSON.parse(raw); }catch{ data = { ok:false, error:"Bad JSON", details: raw }; }

      if(!res.ok || !data.ok){
        addMsg("simo", `⚠️ Server error${data?.error ? ": " + data.error : ""}`, "error");
        if(data?.details){
          addMsg("simo", String(data.details).slice(0,1800), "error");
        }
        setStatus("bad");
        return;
      }

      // assistant response
      if(data.assistant){
        addMsg("simo", data.assistant);
      }else{
        addMsg("simo", "Okay.");
      }

      // update build state
      if(data.state){
        buildState = data.state;
        persist();
      }

      // render preview if provided / changed
      if(data.preview_html){
        buildState.current_html = data.preview_html;
        if(data.kind) buildState.current_kind = data.kind;
        if(data.title) buildState.current_title = data.title;
        persist();
        renderPreviewFromState();
      }else{
        // still render in case backend only updated state.current_html
        renderPreviewFromState();
      }

      setStatus("ready");
    }catch(err){
      addMsg("simo", "⚠️ Network error. Check your deploy / function logs.", "error");
      addMsg("simo", String(err?.message || err), "error");
      setStatus("bad");
    }
  }

  function renderPreviewFromState(){
    renderModeTag();
    const kind = buildState.current_kind || "Untitled preview";
    currentKind.textContent = kind;

    if(buildState.current_html){
      emptyPreview.style.display = "none";
      previewFrame.style.display = "block";
      // force refresh every time so it never “sticks”
      previewFrame.srcdoc = buildState.current_html;
    }else{
      previewFrame.style.display = "none";
      emptyPreview.style.display = "block";
      previewFrame.srcdoc = "";
    }
  }

  function renderModeTag(){
    modeTag.textContent = (mode || "building").charAt(0).toUpperCase() + (mode || "building").slice(1);
  }

  function setMode(newMode){
    mode = newMode;
    localStorage.setItem(LS.mode, mode);
    document.querySelectorAll(".chip").forEach(b=>{
      b.classList.toggle("active", b.dataset.mode === mode);
    });
    renderModeTag();
  }

  function setProToggle(on){
    proToggle.classList.toggle("on", !!on);
  }

  function persist(){
    localStorage.setItem(LS.thread, JSON.stringify(thread.slice(-200)));
    localStorage.setItem(LS.buildState, JSON.stringify(buildState));
  }

  function safeParse(v, fallback){
    try{ return v ? JSON.parse(v) : fallback; }catch{ return fallback; }
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }
</script>
</body>
</html>
